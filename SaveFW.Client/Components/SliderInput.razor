@using SaveFW.Shared
@inject IJSRuntime JSRuntime
@namespace SaveFW.Client.Components

<div class="space-y-2 mb-8" @ref="containerRef">
    <div class="flex justify-between items-center mb-1">
        <div class="flex items-center gap-1.5">
            <label class="text-sm font-medium text-slate-400">@Label</label>
            @if (!string.IsNullOrEmpty(Tooltip))
            {
                <div class="group relative flex items-center">
                    <span class="material-symbols-outlined text-slate-400 text-[16px] cursor-help hover:text-blue-500 transition-colors">info</span>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-3 bg-slate-900 dark:bg-slate-800 text-white text-xs rounded-lg shadow-xl border border-slate-700 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">
                        @Tooltip
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900 dark:border-t-slate-800"></div>
                    </div>
                </div>
            }
        </div>
        <div class="flex items-center gap-1">
            @if (InputType == "Currency" || InputType == "MoneyMM")
            {
                <span class="text-lg font-bold font-mono text-white">$</span>
            }
            <input @ref="textInputRef" type="text" id="val-@Id" inputmode="numeric" 
                   class="bg-slate-700/50 border border-slate-600 rounded-lg px-2 py-0.5 text-lg font-bold font-mono text-white w-28 text-right focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all shadow-inner" 
                   value="@FormattedInitialValue">
            @if (InputType == "Percent")
            {
                <span class="text-lg font-bold font-mono text-white">%</span>
            }
            @if (InputType == "MoneyMM")
            {
                <span class="text-lg font-bold font-mono text-white">MM</span>
            }
        </div>
    </div>
    <div class="relative w-full group overflow-visible select-none" style="height: 20px;" @ref="containerRef">
        <div class="slider-track"></div>
        <input @ref="rangeInputRef" type="range" id="input-@Id" min="@MinValue" max="@MaxValue" step="@Step" value="@Value"
               class="w-full h-1 bg-transparent appearance-none cursor-pointer accent-red-500 z-20 absolute top-1/2 -translate-y-1/2 m-0 p-0">
    </div>
</div>

@code {
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString("N");
    [Parameter] public string Label { get; set; } = "";
    [Parameter] public string Tooltip { get; set; } = "";
    
    [Parameter] public string InputType { get; set; } = "Number"; // Default: Numerical
    [Parameter] public int DecimalPlaces { get; set; } = 2;       // Default: 2
    [Parameter] public double MinValue { get; set; } = 0;         // Default: 0
    [Parameter] public double MaxValue { get; set; } = 100;       // Default: 100
    [Parameter] public List<SliderMarker> Markers { get; set; } = new();

    // Tick Options
    [Parameter] public double MajorTickInterval { get; set; } = 20; // Default for 0-100 range
    [Parameter] public double MinorTickInterval { get; set; } = 5;  // Default for 0-100 range

    // Slider Logic Props
    [Parameter] public double Step { get; set; } = 1;
    [Parameter] public double Value { get; set; }
    [Parameter] public string MarkerColor { get; set; } = "red"; // Default color

    private ElementReference containerRef;
    private ElementReference rangeInputRef;
    private ElementReference textInputRef;

    private string FormattedInitialValue => Value.ToString(InputType == "Percent" ? $"F{DecimalPlaces}" : $"N{DecimalPlaces}");

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Always try to init. The JS logic handles idempotency via dataset checks.
        // This ensures that if Blazor replaces the DOM element, we re-attach listeners.
        try 
        {
            await JSRuntime.InvokeVoidAsync("window.SliderInputLogic.init", rangeInputRef, textInputRef, containerRef, new 
            {
                min = MinValue,
                max = MaxValue,
                majorTickInterval = MajorTickInterval,
                minorTickInterval = MinorTickInterval,
                inputType = InputType,
                decimalPlaces = DecimalPlaces,
                markers = Markers,
                markerColor = MarkerColor
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing SliderInput {Id}: {ex.Message}");
        }
    }
}