!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t||self).terraDraw={})}(this,function(t){function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function i(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,d(n.key),n)}}function n(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function r(t,i){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,i){if(t){if("string"==typeof t)return e(t,i);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,i):void 0}}(t))||i&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function o(){return o=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)({}).hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},o.apply(null,arguments)}function s(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,a(t,e)}function a(t,e){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},a(t,e)}function d(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}var u,l="draw",h="edit",c="deleteCoordinate",p="insertMidpoint";!function(t){t.Commit="commit",t.Provisional="provisional",t.Finish="finish"}(u||(u={}));var g="https://raw.githubusercontent.com/JamesLMilner/terra-draw/refs/heads/main/assets/markers/marker-blue.png",f={SELECTED:"selected",MID_POINT:"midPoint",SELECTION_POINT_FEATURE_ID:"selectionPointFeatureId",SELECTION_POINT:"selectionPoint"},v={MODE:"mode",CURRENTLY_DRAWING:"currentlyDrawing",EDITED:"edited",CLOSING_POINT:"closingPoint",SNAPPING_POINT:"snappingPoint",COORDINATE_POINT:"coordinatePoint",COORDINATE_POINT_FEATURE_ID:"coordinatePointFeatureId",COORDINATE_POINT_IDS:"coordinatePointIds",PROVISIONAL_COORDINATE_COUNT:"provisionalCoordinateCount",COMMITTED_COORDINATE_COUNT:"committedCoordinateCount",MARKER:"marker"},y=10;function m(t){return Boolean(t&&"object"==typeof t&&null!==t&&!Array.isArray(t))}function P(t){return Boolean(t&&"object"==typeof t&&"properties"in t&&"object"==typeof t.properties&&null!==t.properties&&"mode"in t.properties)}function C(t){return!!function(t){return"number"==typeof t&&!isNaN(new Date(t).valueOf())}(t)}var I,F="Feature is not a Polygon",x="Feature mode property does not match the mode being added to";!function(t){t.Drawing="drawing",t.Select="select",t.Static="static",t.Render="render"}(I||(I={}));var M={rightClick:!0,contextMenu:!1,leftClick:!0,onDragStart:!0,onDrag:!0,onDragEnd:!0},S=/*#__PURE__*/function(){function t(t,e){void 0===e&&(e=!1),this._state="unregistered",this._styles={},this.pointerEvents=M,this.behaviors=[],this.validate=void 0,this.pointerDistance=40,this.coordinatePrecision=void 0,this.onStyleChange=void 0,this.store=void 0,this.projection="web-mercator",this.setDoubleClickToZoom=void 0,this.unproject=void 0,this.project=void 0,this.setCursor=void 0,this.isInitialUpdate=!1,this.type=I.Drawing,this.mode="base",e?this.isInitialUpdate=!0:this.updateOptions(o({},t))}var e=t.prototype;return e.registerBehaviors=function(t){},e.updateOptions=function(t){null!=t&&t.styles&&(this.styles=o({},this._styles,t.styles)),null!=t&&t.pointerDistance&&(this.pointerDistance=t.pointerDistance),null!=t&&t.validation&&(this.validate=t&&t.validation),null!=t&&t.projection&&(this.projection=t.projection),void 0!==(null==t?void 0:t.pointerEvents)&&(this.pointerEvents=t.pointerEvents),null!=t&&t.modeName&&!0===this.isInitialUpdate&&(this.mode=t.modeName),this.isInitialUpdate=!1},e.allowPointerEvent=function(t,e){return"boolean"==typeof t?t:"function"!=typeof t||t(e)},e.setDrawing=function(){if("started"!==this._state)throw new Error("Mode must be unregistered or stopped to start");this._state="drawing"},e.setStarted=function(){if("stopped"!==this._state&&"registered"!==this._state&&"drawing"!==this._state&&"selecting"!==this._state)throw new Error("Mode must be unregistered or stopped to start");this._state="started",this.setDoubleClickToZoom(!1)},e.setStopped=function(){if("started"!==this._state)throw new Error("Mode must be started to be stopped");this._state="stopped",this.setDoubleClickToZoom(!0)},e.register=function(t){if("unregistered"!==this._state)throw new Error("Can not register unless mode is unregistered");this._state="registered",this.store=t.store,this.store.registerOnChange(t.onChange),this.setDoubleClickToZoom=t.setDoubleClickToZoom,this.project=t.project,this.unproject=t.unproject,this.onSelect=t.onSelect,this.onDeselect=t.onDeselect,this.setCursor=t.setCursor,this.onStyleChange=t.onChange,this.onFinish=t.onFinish,this.coordinatePrecision=t.coordinatePrecision,this.registerBehaviors({mode:t.mode,store:this.store,project:this.project,unproject:this.unproject,pointerDistance:this.pointerDistance,coordinatePrecision:t.coordinatePrecision,projection:this.projection})},e.validateFeature=function(t){return this.performFeatureValidation(t)},e.afterFeatureAdded=function(t){},e.afterFeatureUpdated=function(t){},e.performFeatureValidation=function(t){if("unregistered"===this._state)throw new Error("Mode must be registered");var e=function(t,e){var i;if(m(t))if(null==t.id)i="Feature has no id";else if("string"!=typeof t.id&&"number"!=typeof t.id)i="Feature must be string or number as per GeoJSON spec";else if(e(t.id))if(m(t.geometry))if(m(t.properties))if("string"==typeof t.geometry.type&&["Polygon","LineString","Point"].includes(t.geometry.type))if(Array.isArray(t.geometry.coordinates)){if(!t.properties.mode||"string"!=typeof t.properties.mode)return{valid:!1,reason:"Feature does not have a valid mode property"}}else i="Feature coordinates is not an array";else i="Feature is not Point, LineString or Polygon";else i="Feature has no properties";else i="Feature has no geometry";else i="Feature must match the id strategy (default is UUID4)";else i="Feature is not object";return i?{valid:!1,reason:i}:{valid:!0}}(t,this.store.idStrategy.isValidId);if(this.validate){var i=this.validate(t,{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:u.Provisional});return{valid:e.valid&&i.valid,reason:i.reason}}return{valid:e.valid,reason:e.reason}},e.validateModeFeature=function(t,e){var i=this.performFeatureValidation(t);return i.valid?t.properties.mode===this.mode?e(t):{valid:!1,reason:x}:{valid:!1,reason:i.reason}},e.onFinish=function(t,e){},e.onDeselect=function(t){},e.onSelect=function(t){},e.onKeyDown=function(t){},e.onKeyUp=function(t){},e.onMouseMove=function(t){},e.onClick=function(t){},e.onDragStart=function(t,e){},e.onDrag=function(t,e){},e.onDragEnd=function(t,e){},e.getHexColorStylingValue=function(t,e,i){return this.getStylingValue(t,e,i)},e.getNumericStylingValue=function(t,e,i){return this.getStylingValue(t,e,i)},e.getUrlStylingValue=function(t,e,i){return this.getStylingValue(t,e,i)},e.getStylingValue=function(t,e,i){return void 0===t?e:"function"==typeof t?t(i):t},n(t,[{key:"state",get:function(){return this._state},set:function(t){throw new Error("Please use the modes lifecycle methods")}},{key:"styles",get:function(){return this._styles},set:function(t){if("object"!=typeof t)throw new Error("Styling must be an object");this.onStyleChange&&this.onStyleChange([],"styling"),this._styles=t}}])}(),E=/*#__PURE__*/function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).type=I.Select,e}return s(e,t),e}(S);function w(t,e){var i=function(t){return t*Math.PI/180},n=i(t[1]),r=i(t[0]),o=i(e[1]),s=o-n,a=i(e[0])-r,d=Math.sin(s/2)*Math.sin(s/2)+Math.cos(n)*Math.cos(o)*Math.sin(a/2)*Math.sin(a/2);return 2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d))*6371e3/1e3}var D=6371008.8;function O(t){return t%360*Math.PI/180}function _(t){return t/6371.0088}function b(t){return t%(2*Math.PI)*180/Math.PI}function k(t,e){void 0===e&&(e=9);var i=Math.pow(10,e);return Math.round(t*i)/i}var T=57.29577951308232,N=.017453292519943295,W=6378137,B=function(t,e){return{x:0===t?0:t*N*W,y:0===e?0:Math.log(Math.tan(Math.PI/4+e*N/2))*W}},A=function(t,e){return{lng:0===t?0:T*(t/W),lat:0===e?0:(2*Math.atan(Math.exp(e/W))-Math.PI/2)*T}};function R(t,e,i){var n=O(t[0]),r=O(t[1]),o=O(i),s=_(e),a=Math.asin(Math.sin(r)*Math.cos(s)+Math.cos(r)*Math.sin(s)*Math.cos(o));return[b(n+Math.atan2(Math.sin(o)*Math.sin(s)*Math.cos(r),Math.cos(s)-Math.sin(r)*Math.sin(a))),b(a)]}function L(t){for(var e=t.center,i=t.radiusKilometers,n=t.coordinatePrecision,r=t.steps?t.steps:64,o=[],s=0;s<r;s++){var a=R(e,i,-360*s/r);o.push([k(a[0],n),k(a[1],n)])}return o.push(o[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[o]},properties:{}}}function U(t){var e;if("Polygon"===t.geometry.type)e=t.geometry.coordinates;else{if("LineString"!==t.geometry.type)throw new Error("Self intersects only accepts Polygons and LineStrings");e=[t.geometry.coordinates]}for(var i=[],n=0;n<e.length;n++)for(var r=0;r<e[n].length-1;r++)for(var o=0;o<e.length;o++)for(var s=0;s<e[o].length-1;s++)d(n,r,o,s);return i.length>0;function a(t){return t<0||t>1}function d(t,n,r,o){var s,d=e[t][n],u=e[t][n+1],l=e[r][o],h=e[r][o+1],c=function(t,e,i,n){if(G(t,i)||G(t,n)||G(e,i)||G(n,i))return null;var r=t[0],o=t[1],s=e[0],a=e[1],d=i[0],u=i[1],l=n[0],h=n[1],c=(r-s)*(u-h)-(o-a)*(d-l);return 0===c?null:[((r*a-o*s)*(d-l)-(r-s)*(d*h-u*l))/c,((r*a-o*s)*(u-h)-(o-a)*(d*h-u*l))/c]}(d,u,l,h);null!==c&&(s=h[0]!==l[0]?(c[0]-l[0])/(h[0]-l[0]):(c[1]-l[1])/(h[1]-l[1]),a(u[0]!==d[0]?(c[0]-d[0])/(u[0]-d[0]):(c[1]-d[1])/(u[1]-d[1]))||a(s)||(c.toString(),i.push(c)))}}function G(t,e){return t[0]===e[0]&&t[1]===e[1]}function j(t,e){return Y(t[0])<=e&&Y(t[1])<=e}function V(t){return 2===t.length&&"number"==typeof t[0]&&"number"==typeof t[1]&&Infinity!==t[0]&&Infinity!==t[1]&&(i=t[0])>=-180&&i<=180&&(e=t[1])>=-90&&e<=90;var e,i}function Y(t){for(var e=1,i=0;Math.round(t*e)/e!==t;)e*=10,i++;return i}var z="Feature has holes",K="Feature has less than 4 coordinates",H="Feature has invalid coordinates",X="Feature coordinates are not closed";function q(t,e){if("Polygon"!==t.geometry.type)return{valid:!1,reason:"Feature is not a Polygon"};if(1!==t.geometry.coordinates.length)return{valid:!1,reason:z};if(t.geometry.coordinates[0].length<4)return{valid:!1,reason:K};for(var i=0;i<t.geometry.coordinates[0].length;i++){if(!V(t.geometry.coordinates[0][i]))return{valid:!1,reason:H};if(!j(t.geometry.coordinates[0][i],e))return{valid:!1,reason:"Feature has coordinates with excessive precision"}}return(n=t.geometry.coordinates[0][0])[0]!==(r=t.geometry.coordinates[0][t.geometry.coordinates[0].length-1])[0]||n[1]!==r[1]?{valid:!1,reason:X}:{valid:!0};var n,r}function Z(t,e){var i=q(t,e);return i.valid?U(t)?{valid:!1,reason:"Feature intersects itself"}:{valid:!0}:i}var J=function(t){var e=t.store,i=t.mode,n=t.project,r=t.unproject,o=t.pointerDistance,s=t.coordinatePrecision,a=t.projection;this.store=void 0,this.mode=void 0,this.project=void 0,this.unproject=void 0,this.pointerDistance=void 0,this.coordinatePrecision=void 0,this.projection=void 0,this.store=e,this.mode=i,this.project=n,this.unproject=r,this.pointerDistance=o,this.coordinatePrecision=s,this.projection=a};function $(t){var e=function(t){for(var e=t.coordinates[0],i=0,n=0;n<e.length-1;n++){var r=e[n],o=e[n+1];i+=(o[0]-r[0])*(o[1]+r[1])}return i<0}(t);if(!e)return{type:"Polygon",coordinates:[t.coordinates[0].reverse()]}}var Q="insert-before",tt="insert-after",et="update",it="delete",nt="replace",rt=/*#__PURE__*/function(t){function e(e,i){var n;return(n=t.call(this,e)||this).options=void 0,n.options=i,n}s(e,t);var i=e.prototype;return i.createPoint=function(t){var e=t.coordinates,i=t.properties,n=t.context;if((null==n?void 0:n.updateType)!==u.Finish||this.validateGeometryWithUpdateType({geometry:{type:"Point",coordinates:e},properties:i,updateType:u.Finish}))return this.handleCreateFeature({geometry:{type:"Point",coordinates:e},properties:i})},i.createLineString=function(t){return this.handleCreateFeature({geometry:{type:"LineString",coordinates:t.coordinates},properties:t.properties})},i.createPolygon=function(t){var e=t.coordinates,i=t.properties,n=$({type:"Polygon",coordinates:[e]});return this.handleCreateFeature({geometry:{type:"Polygon",coordinates:n?n.coordinates:[e]},properties:i})},i.createGuidancePoint=function(t){return this.createGuidancePoints({coordinates:[t.coordinate],type:t.type})[0]},i.createGuidancePoints=function(t){var e=this,i=t.type,n=t.additionalProperties,r=t.coordinates.map(function(t,r){var s;return{type:"Feature",geometry:{type:"Point",coordinates:t},properties:o((s={mode:e.mode},s[i]=!0,s),n?n(r):{})}});return this.createFeatures(r)},i.updatePoint=function(t){return this.handleMutateFeature({type:"Point",featureId:t.featureId,coordinateMutations:t.coordinateMutations,propertyMutations:t.propertyMutations,context:t.context})},i.updatePolygon=function(t){return this.handleMutateFeature({type:"Polygon",featureId:t.featureId,coordinateMutations:t.coordinateMutations,propertyMutations:t.propertyMutations,context:t.context})},i.updateLineString=function(t){return this.handleMutateFeature({type:"LineString",featureId:t.featureId,coordinateMutations:t.coordinateMutations,propertyMutations:t.propertyMutations,context:t.context})},i.deleteFeatureIfPresent=function(t){t&&this.store.has(t)&&this.store.delete([t])},i.deleteFeaturesIfPresent=function(t){var e=this;if(0!==t.length){var i=t.filter(function(t){return e.store.has(t)});i.length&&this.store.delete(i)}},i.setDeselected=function(t){var e=this,i=t.filter(function(t){return e.store.has(t)}).map(function(t){var e;return{featureId:t,properties:(e={},e[f.SELECTED]=!1,e)}});this.updateFeatureProperties(i)},i.setSelected=function(t){var e,i=this.store.getGeometryCopy(t).type,n={featureId:t,propertyMutations:(e={},e[f.SELECTED]=!0,e),context:{updateType:u.Commit}};"Polygon"===i?this.updatePolygon(n):"LineString"===i?this.updateLineString(n):"Point"===i&&this.updatePoint(n)},i.updateGuidancePoints=function(t){this.updateFeatureGeometries(t.map(function(t){return{id:t.featureId,geometry:{type:"Point",coordinates:t.coordinate}}}))},i.handleCreateFeature=function(t){return this.createFeatureWithGeometry({geometry:t.geometry,properties:t.properties})},i.handleMutateFeature=function(t){var e=t.featureId,i=t.coordinateMutations,n=t.context;if(!this.mutateFeature({type:t.type,featureId:e,coordinateMutations:i,propertyMutations:t.propertyMutations,context:n.updateType===u.Finish?o({},n,{correctRightHandRule:!0}):o({},n)}))return null;var r=this.buildFeatureWithGeometry(e);return n.updateType!==u.Finish||i||this.validateGeometryWithUpdateType({geometry:r.geometry,properties:r.properties,updateType:n.updateType})?r:null},i.epsilonOffset=function(){var t=1/Math.pow(10,this.coordinatePrecision-1);return Math.max(1e-6,t)},i.mutateFeature=function(t){var e=t.type,i=t.featureId,n=t.coordinateMutations,r=t.propertyMutations,o=t.context;if(!i)return!1;var s=this.store.getGeometryCopy(i),a=this.store.getPropertiesCopy(i);if(s.type!==e)throw new Error(e+" geometries cannot be updated on features with "+s.type+" geometries");if(n){var d=this.applyCoordinateMutations(s,n);if(o.correctRightHandRule&&"Polygon"===d.type){var u=$(d);u&&(d=u)}if(!this.validateGeometryWithUpdateType({geometry:d,properties:a,updateType:o.updateType}))return!1;this.updateFeatureGeometries([{id:i,geometry:d}])}return r&&this.updateFeatureProperties([{featureId:i,properties:r}]),!0},i.applyCoordinateMutations=function(t,e){if(this.isReplaceMutation(e))return o({},t,{coordinates:e.coordinates});if("Point"===t.type)throw new Error("Coordinate mutations are not supported for Point geometries");for(var i,n="Polygon"===t.type,s=n?t.coordinates[0].slice():t.coordinates.slice(),a=s.length,d=function(t){var e=t<0?a+t:t;if(e<0||e>=a)throw new RangeError("Index "+t+" (normalized to "+e+") is out of bounds");return e},u=new Array(a).fill(void 0),l=Array.from({length:a},function(){return[]}),h=Array.from({length:a},function(){return[]}),c=[],p=r(e);!(i=p()).done;){var g=i.value;if(g.type!==Q&&g.type!==tt){var f=d(g.index);u[f]=o({},g,{index:f})}else{var v=g.index,y=v<0?a+v:v;if(y<0||y>a)throw new RangeError("Index "+g.index+" (normalized to "+y+") is out of bounds");if(g.type===Q){if(y>=a)throw new RangeError("INSERT_BEFORE index "+g.index+" (normalized to "+y+") is out of bounds for length "+a);l[y].push(g)}else y===a?c.push(g):h[y].push(g)}}for(var m=[],P=0;P<a;P++){for(var C,I=r(l[P]);!(C=I()).done;)m.push(C.value.coordinate);var F=u[P];F?F.type===it||m.push(F.coordinate):m.push(s[P]);for(var x,M=r(h[P]);!(x=M()).done;)m.push(x.value.coordinate)}for(var S=0,E=c;S<E.length;S++)m.push(E[S].coordinate);return o({},t,n?{coordinates:[m].concat(t.coordinates.slice(1))}:{coordinates:m})},i.isReplaceMutation=function(t){return t.type===nt},i.createFeatureWithGeometry=function(t){var e=this.createFeatures([{type:"Feature",geometry:t.geometry,properties:t.properties}])[0];return{id:e,type:"Feature",properties:this.store.getPropertiesCopy(e),geometry:this.store.getGeometryCopy(e)}},i.validateGeometryWithUpdateType=function(t){return!this.options.validate||this.options.validate({type:"Feature",geometry:t.geometry,properties:t.properties||{}},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:t.updateType}).valid},i.buildFeatureWithGeometry=function(t){return{id:t,type:"Feature",properties:this.store.getPropertiesCopy(t),geometry:this.store.getGeometryCopy(t)}},i.createFeatures=function(t){return this.store.create(t)},i.updateFeatureGeometries=function(t){this.store.updateGeometry(t)},i.updateFeatureProperties=function(t){var e=t.map(function(t){var e=t.featureId;return Object.entries(t.properties).map(function(t){return{id:e,property:t[0],value:t[1]}})}).flat();this.store.updateProperty(e)},e}(J),ot={cancel:"Escape",finish:"Enter"},st={start:"crosshair"},at=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="circle",i.center=void 0,i.endPosition=void 0,i.segments=64,i.currentCircleId=void 0,i.keyEvents=ot,i.cursors=st,i.startingRadiusKilometers=1e-5,i.cursorMovedAfterInitialCursorDown=!1,i.drawInteraction="click-move",i.drawType=void 0,i.mutateFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors)),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents)),null!=e&&e.startingRadiusKilometers&&(this.startingRadiusKilometers=e.startingRadiusKilometers),null!=e&&e.drawInteraction&&(this.drawInteraction=e.drawInteraction),null!=e&&e.segments&&(this.segments=e.segments<3?3:e.segments)},i.close=function(){if(void 0!==this.currentCircleId&&void 0!==this.endPosition&&this.updateCircle(this.endPosition,u.Finish)){var t=this.currentCircleId;this.cursorMovedAfterInitialCursorDown=!1,this.center=void 0,this.currentCircleId=void 0,this.drawType=void 0,"drawing"===this.state&&this.setStarted(),this.onFinish(t,{mode:this.mode,action:l})}},i.beginDrawing=function(t,e){var i;void 0===e&&(e="click"),this.center=[t.lng,t.lat],this.endPosition=[t.lng,t.lat];var n=L({center:this.center,radiusKilometers:this.startingRadiusKilometers,coordinatePrecision:this.coordinatePrecision}),r=this.mutateFeature.createPolygon({coordinates:n.geometry.coordinates[0],properties:(i={mode:this.mode,radiusKilometers:this.startingRadiusKilometers},i[v.CURRENTLY_DRAWING]=!0,i)});r&&(this.currentCircleId=r.id,this.cursorMovedAfterInitialCursorDown=!1,this.drawType=e,this.setDrawing())},i.dragDrawAllowed=function(){return"click-drag"===this.drawInteraction||"click-move-or-drag"===this.drawInteraction},i.moveDrawAllowed=function(){return"click-move"===this.drawInteraction||"click-move-or-drag"===this.drawInteraction},i.start=function(){this.setStarted(),this.setCursor(this.cursors.start)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onClick=function(t){this.moveDrawAllowed()&&("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t))&&(this.center?this.center&&void 0!==this.currentCircleId&&(this.endPosition=[t.lng,t.lat],this.close()):this.beginDrawing(t))},i.onMouseMove=function(t){this.cursorMovedAfterInitialCursorDown=!0,this.endPosition=[t.lng,t.lat],this.updateCircle(this.endPosition,u.Provisional)},i.onKeyDown=function(){},i.onKeyUp=function(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()},i.onDragStart=function(t,e){"drawing"!==this.state&&this.allowPointerEvent(this.pointerEvents.onDragStart,t)&&this.dragDrawAllowed()&&(this.beginDrawing(t,"drag"),e(!1))},i.onDrag=function(t,e){this.allowPointerEvent(this.pointerEvents.onDrag,t)&&this.dragDrawAllowed()&&"drag"===this.drawType&&(this.cursorMovedAfterInitialCursorDown=!0,this.endPosition=[t.lng,t.lat],this.updateCircle(this.endPosition,u.Provisional))},i.onDragEnd=function(t,e){this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&this.dragDrawAllowed()&&"drag"===this.drawType&&(this.endPosition=[t.lng,t.lat],this.close(),e(!0))},i.cleanUp=function(){var t=this.currentCircleId;this.center=void 0,this.currentCircleId=void 0,this.drawType=void 0,"drawing"===this.state&&this.setStarted(),this.mutateFeature.deleteFeatureIfPresent(t)},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return"Feature"===t.type&&"Polygon"===t.geometry.type&&t.properties.mode===this.mode?(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=y,e):e},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return Z(t,e.coordinatePrecision)})},i.updateCircle=function(t,e){if(void 0!==this.currentCircleId&&void 0!==this.center){var i,n,r=e===u.Finish;if(this.cursorMovedAfterInitialCursorDown)if(n=w(this.center,t),"web-mercator"===this.projection){var o=function(t,e){var i=1e3*w(t,e);if(0===i)return 1;var n=B(t[0],t[1]),r=n.x,o=n.y,s=B(e[0],e[1]),a=s.y;return Math.sqrt(Math.pow(s.x-r,2)+Math.pow(a-o,2))/i}(this.center,t);i=function(t){for(var e=t.center,i=t.coordinatePrecision,n=t.steps?t.steps:64,r=1e3*t.radiusKilometers,o=B(e[0],e[1]),s=o.x,a=o.y,d=[],u=0;u<n;u++){var l=360*u/n*Math.PI/180,h=r*Math.cos(l),c=r*Math.sin(l),p=A(s+h,a+c),g=p.lat;d.push([k(p.lng,i),k(g,i)])}return d.push(d[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[d]},properties:{}}}({center:this.center,radiusKilometers:n*o,coordinatePrecision:this.coordinatePrecision,steps:this.segments})}else{if("globe"!==this.projection)throw new Error("Invalid projection");i=L({center:this.center,radiusKilometers:n,coordinatePrecision:this.coordinatePrecision,steps:this.segments})}var s={};return i&&n&&(s.radiusKilometers=n),r&&(s[v.CURRENTLY_DRAWING]=void 0),this.mutateFeature.updatePolygon({featureId:this.currentCircleId,coordinateMutations:i?{type:nt,coordinates:i.geometry.coordinates}:void 0,propertyMutations:s,context:r?{updateType:e,action:l}:{updateType:e}})}},i.afterFeatureUpdated=function(t){this.currentCircleId===t.id&&(this.cursorMovedAfterInitialCursorDown=!1,this.center=void 0,this.currentCircleId=void 0,this.drawType=void 0,"drawing"===this.state&&this.setStarted())},i.registerBehaviors=function(t){this.mutateFeature=new rt(t,{validate:this.validate})},e}(S),dt=function(t,e){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(n*n+i*i)};function ut(t,e){return t[0]===e[0]&&t[1]===e[1]}var lt=/*#__PURE__*/function(t){function e(e){return t.call(this,e)||this}s(e,t);var i=e.prototype;return i.getGeometryType=function(t){return this.store.getGeometryCopy(t).type},i.coordinateAtIndexIsIdentical=function(t){var e,i=t.newCoordinate,n=t.index,r=this.store.getGeometryCopy(t.featureId);if("Polygon"===r.type)e=r.coordinates[0][n];else if("LineString"===r.type)e=r.coordinates[n];else{if(0!==n)throw new Error("Point geometries only have one coordinate at index 0");e=r.coordinates}return ut(i,e)},i.getGeometry=function(t){return this.store.getGeometryCopy(t)},i.getCoordinates=function(t){var e=this.store.getGeometryCopy(t),i=e.coordinates;return"Polygon"===e.type?i[0]:i},i.getCoordinate=function(t,e){var i=this.getCoordinates(t),n=e<0?i.length+e:e;if(n<0||n>=i.length)throw new RangeError("Index "+e+" (normalized to "+n+") is out of bounds");return i[n]},i.getProperties=function(t){return this.store.getPropertiesCopy(t)},i.hasFeature=function(t){return this.store.has(t)},i.getAllFeatureIdsWhere=function(t){return this.store.copyAllWhere(t).map(function(t){return t.id})},e}(J),ht={cancel:"Escape",finish:"Enter"},ct={start:"crosshair",close:"pointer"},pt=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="freehand",i.canClose=!1,i.currentId=void 0,i.closingPointId=void 0,i.minDistance=20,i.keyEvents=ht,i.cursors=ct,i.preventPointsNearClose=!0,i.autoClose=!1,i.autoCloseTimeout=500,i.hasLeftStartingPoint=!1,i.preventNewFeature=!1,i.mutateFeature=void 0,i.readFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.minDistance&&(this.minDistance=e.minDistance),void 0!==(null==e?void 0:e.preventPointsNearClose)&&(this.preventPointsNearClose=e.preventPointsNearClose),void 0!==(null==e?void 0:e.autoClose)&&(this.autoClose=e.autoClose),null!=e&&e.autoCloseTimeout&&(this.autoCloseTimeout=e.autoCloseTimeout),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents)),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors))},i.close=function(){var t;if(void 0!==this.currentId&&this.mutateFeature.updatePolygon({featureId:this.currentId,propertyMutations:(t={},t[v.CURRENTLY_DRAWING]=void 0,t),context:{updateType:u.Finish,action:l}})){var e=this.currentId;this.mutateFeature.deleteFeatureIfPresent(this.closingPointId),this.canClose=!1,this.currentId=void 0,this.closingPointId=void 0,this.hasLeftStartingPoint=!1,"drawing"===this.state&&this.setStarted(),this.onFinish(e,{mode:this.mode,action:l})}},i.start=function(){this.setStarted(),this.setCursor(this.cursors.start)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onMouseMove=function(t){var e=this;if(void 0!==this.currentId&&!1!==this.canClose){var i=this.readFeature.getCoordinate(this.currentId,-2),n=this.project(i[0],i[1]),r=dt({x:n.x,y:n.y},{x:t.containerX,y:t.containerY}),o=this.readFeature.getCoordinate(this.currentId,0),s=this.project(o[0],o[1]);if(dt({x:s.x,y:s.y},{x:t.containerX,y:t.containerY})<this.pointerDistance){if(this.autoClose&&this.hasLeftStartingPoint&&(this.preventNewFeature=!0,setTimeout(function(){e.preventNewFeature=!1},this.autoCloseTimeout),this.close()),this.setCursor(this.cursors.close),this.preventPointsNearClose)return}else this.hasLeftStartingPoint=!0,this.setCursor(this.cursors.start);r<this.minDistance||this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:[{type:Q,index:-1,coordinate:[t.lng,t.lat]}],context:{updateType:u.Provisional}})}else this.setCursor(this.cursors.start)},i.onClick=function(t){if("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)){if(this.preventNewFeature)return;if(!1===this.canClose){var e,i=this.mutateFeature.createPolygon({coordinates:[[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat]],properties:(e={mode:this.mode},e[v.CURRENTLY_DRAWING]=!0,e)});return this.currentId=i.id,this.closingPointId=this.mutateFeature.createGuidancePoint({coordinate:[t.lng,t.lat],type:v.CLOSING_POINT}),this.canClose=!0,void("drawing"!==this.state&&this.setDrawing())}this.close()}},i.onKeyDown=function(){},i.onKeyUp=function(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&!0===this.canClose&&this.close()},i.onDragStart=function(){},i.onDrag=function(){},i.onDragEnd=function(){},i.cleanUp=function(){var t=this.currentId,e=this.closingPointId;this.closingPointId=void 0,this.currentId=void 0,this.canClose=!1,"drawing"===this.state&&this.setStarted(),this.mutateFeature.deleteFeatureIfPresent(t),this.mutateFeature.deleteFeatureIfPresent(e)},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return"Feature"===t.type&&"Polygon"===t.geometry.type&&t.properties.mode===this.mode?(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=y,e):"Feature"===t.type&&"Point"===t.geometry.type&&t.properties.mode===this.mode?(e.pointWidth=this.getNumericStylingValue(this.styles.closingPointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(this.styles.closingPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.closingPointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.closingPointOutlineWidth,2,t),e.zIndex=50,e):e},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return q(t,e.coordinatePrecision)})},i.afterFeatureUpdated=function(t){this.currentId===t.id&&(this.mutateFeature.deleteFeatureIfPresent(this.closingPointId),this.canClose=!1,this.currentId=void 0,this.closingPointId=void 0,this.hasLeftStartingPoint=!1)},i.registerBehaviors=function(t){this.readFeature=new lt(t),this.mutateFeature=new rt(t,{validate:this.validate})},e}(S);function gt(t){var e=t.unproject,i=t.point,n=t.pointerDistance/2,r=i.x,o=i.y;return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[e(r-n,o-n),e(r+n,o-n),e(r+n,o+n),e(r-n,o+n),e(r-n,o-n)].map(function(t){return[t.lng,t.lat]})]}}}var ft=/*#__PURE__*/function(t){function e(e){return t.call(this,e)||this}return s(e,t),e.prototype.create=function(t){return gt({unproject:this.unproject,point:{x:t.containerX,y:t.containerY},pointerDistance:this.pointerDistance})},e}(J),vt=/*#__PURE__*/function(t){function e(e){return t.call(this,e)||this}return s(e,t),e.prototype.measure=function(t,e){var i=this.project(e[0],e[1]);return dt({x:i.x,y:i.y},{x:t.containerX,y:t.containerY})},e}(J),yt=/*#__PURE__*/function(t){function e(e,i,n){var r;return(r=t.call(this,e)||this).config=void 0,r.pixelDistance=void 0,r.clickBoundingBox=void 0,r.getSnappableCoordinateFirstClick=function(t){return r.getSnappable(t,function(t){return Boolean(t.properties&&t.properties.mode===r.mode)}).coordinate},r.getSnappableCoordinate=function(t,e){return r.getSnappable(t,function(t){return Boolean(t.properties&&t.properties.mode===r.mode&&t.id!==e)}).coordinate},r.config=e,r.pixelDistance=i,r.clickBoundingBox=n,r}return s(e,t),e.prototype.getSnappable=function(t,e){var i=this,n=this.clickBoundingBox.create(t),r=this.store.search(n,e),o={featureId:void 0,featureCoordinateIndex:void 0,coordinate:void 0,minDist:Infinity};return r.forEach(function(e){var n;if("Polygon"===e.geometry.type)n=e.geometry.coordinates[0];else{if("LineString"!==e.geometry.type)return;n=e.geometry.coordinates}n.forEach(function(n,r){var s=i.pixelDistance.measure(t,n);s<o.minDist&&s<i.pointerDistance&&(o.coordinate=n,o.minDist=s,o.featureId=e.id,o.featureCoordinateIndex=r)})}),o},e}(J);function mt(t,e,i){var n=O(t[0]),r=O(t[1]),o=O(i),s=_(e),a=Math.asin(Math.sin(r)*Math.cos(s)+Math.cos(r)*Math.sin(s)*Math.cos(o));return[b(n+Math.atan2(Math.sin(o)*Math.sin(s)*Math.cos(r),Math.cos(s)-Math.sin(r)*Math.sin(a))),b(a)]}function Pt(t,e,i){var n=t.x,r=t.y,o=O(i);return{x:n+e*Math.cos(o),y:r+e*Math.sin(o)}}function Ct(t,e){var i=O(t[0]),n=O(e[0]),r=O(t[1]),o=O(e[1]),s=Math.sin(n-i)*Math.cos(o),a=Math.cos(r)*Math.sin(o)-Math.sin(r)*Math.cos(o)*Math.cos(n-i);return b(Math.atan2(s,a))}function It(t,e){var i=e.x-t.x,n=e.y-t.y;if(0===i&&0===n)return 0;var r=Math.atan2(n,i);return(r*=180/Math.PI)>180?r-=360:r<-180&&(r+=360),r}function Ft(t){return(t+360)%360}function xt(t,e,i){for(var n,r,o,s=[],a=t.length,d=0,u=0;u<t.length&&!(e>=d&&u===t.length-1);u++){if(d>e&&0===s.length){if(!(n=e-d))return s.push(t[u]),s;r=Ct(t[u],t[u-1])-180,o=mt(t[u],n,r),s.push(o)}if(d>=i)return(n=i-d)?(r=Ct(t[u],t[u-1])-180,o=mt(t[u],n,r),s.push(o),s):(s.push(t[u]),s);if(d>=e&&s.push(t[u]),u===t.length-1)return s;d+=w(t[u],t[u+1])}if(d<e&&t.length===a)throw new Error("Start position is beyond line");var l=t[t.length-1];return[l,l]}function Mt(t){return t*(Math.PI/180)}function St(t){return t*(180/Math.PI)}var Et=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e)||this).config=void 0,i.config=e,i}s(e,t);var i=e.prototype;return i.generateInsertionCoordinates=function(t,e,i){for(var n=[t,e],r=0,o=0;o<n.length-1;o++)r+=w(n[0],n[1]);if(r<=i)return n;var s=r/i-1;Number.isInteger(s)||(s=Math.floor(s)+1);for(var a=[],d=0;d<s;d++){var u=xt(n,i*d,i*(d+1));a.push(u)}for(var l=[],h=0;h<a.length;h++)l.push(a[h][1]);return this.limitCoordinates(l)},i.generateInsertionGeodesicCoordinates=function(t,e,i){var n=w(t,e),r=function(t,e,i){var n=[],r=Mt(t[1]),o=Mt(t[0]),s=Mt(e[1]),a=Mt(e[0]);i+=1;var d=2*Math.asin(Math.sqrt(Math.pow(Math.sin((s-r)/2),2)+Math.cos(r)*Math.cos(s)*Math.pow(Math.sin((a-o)/2),2)));if(0===d||isNaN(d))return n;for(var u=0;u<=i;u++){var l=u/i,h=Math.sin((1-l)*d)/Math.sin(d),c=Math.sin(l*d)/Math.sin(d),p=h*Math.cos(r)*Math.cos(o)+c*Math.cos(s)*Math.cos(a),g=h*Math.cos(r)*Math.sin(o)+c*Math.cos(s)*Math.sin(a),f=h*Math.sin(r)+c*Math.sin(s);if(!(isNaN(p)||isNaN(g)||isNaN(f))){var v=Math.atan2(f,Math.sqrt(Math.pow(p,2)+Math.pow(g,2))),y=Math.atan2(g,p);isNaN(v)||isNaN(y)||n.push([St(y),St(v)])}}return n.slice(1,-1)}(t,e,Math.floor(n/i));return this.limitCoordinates(r)},i.limitCoordinates=function(t){var e=this;return t.map(function(t){return[k(t[0],e.config.coordinatePrecision),k(t[1],e.config.coordinatePrecision)]})},e}(J);function wt(t,e){if("LineString"!==t.geometry.type)return{valid:!1,reason:"Feature is not a LineString"};if(t.geometry.coordinates.length<2)return{valid:!1,reason:"Feature has less than 2 coordinates"};for(var i=0;i<t.geometry.coordinates.length;i++){if(!V(t.geometry.coordinates[i]))return{valid:!1,reason:"Feature has invalid coordinates"};if(!j(t.geometry.coordinates[i],e))return{valid:!1,reason:"Feature has coordinates with excessive precision"}}return{valid:!0}}function Dt(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2))}function Ot(t,e){var i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(t,e)/(Dt(t)*Dt(e));return Math.acos(Math.min(Math.max(i,-1),1))}function _t(t){var e=O(t[1]),i=O(t[0]);return[Math.cos(e)*Math.cos(i),Math.cos(e)*Math.sin(i),Math.sin(e)]}function bt(t){var e=t[0],i=t[1],n=b(Math.asin(t[2]));return[b(Math.atan2(i,e)),n]}var kt=/*#__PURE__*/function(t){function e(e,i,n){var r;return(r=t.call(this,e)||this).config=void 0,r.pixelDistance=void 0,r.clickBoundingBox=void 0,r.getSnappableCoordinateFirstClick=function(t){var e=r.getSnappable(t,function(t){return Boolean(t.properties&&t.properties.mode===r.mode)});return e.coordinate?[k(e.coordinate[0],r.config.coordinatePrecision),k(e.coordinate[1],r.config.coordinatePrecision)]:void 0},r.getSnappableCoordinate=function(t,e){var i=r.getSnappable(t,function(t){return Boolean(t.properties&&t.properties.mode===r.mode&&t.id!==e)});return i.coordinate?[k(i.coordinate[0],r.config.coordinatePrecision),k(i.coordinate[1],r.config.coordinatePrecision)]:void 0},r.config=e,r.pixelDistance=i,r.clickBoundingBox=n,r}return s(e,t),e.prototype.getSnappable=function(t,e){var i=this,n=this.clickBoundingBox.create(t),o=this.store.search(n,e),s={featureId:void 0,featureCoordinateIndex:void 0,coordinate:void 0,minDistance:Infinity};return o.forEach(function(e){var n;if("Polygon"===e.geometry.type)n=e.geometry.coordinates[0];else{if("LineString"!==e.geometry.type)return;n=e.geometry.coordinates}for(var o,a=[],d=0;d<n.length-1;d++)a.push([n[d],n[d+1]]);var u=[t.lng,t.lat];if("web-mercator"===i.config.projection?o=function(t,e){for(var i,n,o,s,a,d,u,l,h=[Infinity,Infinity],c=Infinity,p=0,g=r(e);!(i=g()).done;){var f=i.value,v=f[0],y=f[1],m=void 0,P=Infinity,C=B(v[0],v[1]),I=B(y[0],y[1]),F=B(t[0],t[1]);if(v[0]===t[0]&&v[1]===t[1])m=v;else if(y[0]===t[0]&&y[1]===t[1])m=y;else{var x=(u=(d={x:(s=F).x-(n=C).x,y:s.y-n.y}).x*(a={x:(o=I).x-n.x,y:o.y-n.y}).x+d.y*a.y,l=Math.max(0,Math.min(1,u/(a.x*a.x+a.y*a.y))),{x:n.x+l*a.x,y:n.y+l*a.y}),M=A(x.x,x.y);m=[M.lng,M.lat]}m&&(P=dt(F,B(m[0],m[1])))<c&&(h=m,c=P,p=e.indexOf(f))}return Infinity===c?void 0:{coordinate:h,lineIndex:p,distance:c}}(u,a):"globe"===i.config.projection&&(o=function(t,e){for(var i,n=[Infinity,Infinity],o=Infinity,s=0,a=r(e);!(i=a()).done;){var d,u=i.value,l=u[0],h=u[1],c=Infinity;(d=l[0]===t[0]&&l[1]===t[1]?l:h[0]===t[0]&&h[1]===t[1]?h:(p=l,g=h,f=t,S=_t(p),E=_t(g),D=_t(f),O=D[0],_=D[1],b=D[2],k=[(P=(v=S)[1])*(x=(y=E)[2])-(C=v[2])*(F=y[1]),C*(I=y[0])-(m=v[0])*x,m*F-P*I],T=k[0],N=k[1],W=k[2],B=N*b-W*_,A=W*O-T*b,R=T*_-N*O,L=R*N-A*W,U=B*W-R*T,G=A*T-B*N,j=1/Math.sqrt(Math.pow(L,2)+Math.pow(U,2)+Math.pow(G,2)),V=[L*j,U*j,G*j],Y=[-1*L*j,-1*U*j,-1*G*j],z=Ot(S,E),K=Ot(S,V),H=Ot(E,V),X=Ot(S,Y),q=Ot(E,Y),Ot(S,M=K<X&&K<q||H<X&&H<q?V:Y)>z||Ot(E,M)>z?w(bt(M),bt(S))<=w(bt(M),bt(E))?[bt(S),!0,!1]:[bt(E),!1,!0]:[bt(M),!1,!1])[0])&&(c=w(t,d))<o&&(n=d,o=c,s=e.indexOf(u))}var p,g,f,v,y,m,P,C,I,F,x,M,S,E,D,O,_,b,k,T,N,W,B,A,R,L,U,G,j,V,Y,z,K,H,X,q;return Infinity===o?void 0:{coordinate:n,distance:o,lineIndex:s}}(u,a)),o){var l=i.pixelDistance.measure(t,o.coordinate);l<s.minDistance&&l<i.pointerDistance&&(s.featureId=e.id,s.coordinate=[k(o.coordinate[0],i.config.coordinatePrecision),k(o.coordinate[1],i.config.coordinatePrecision)],s.featureCoordinateIndex=o.lineIndex,s.minDistance=l)}}),s},e}(J);function Tt(t){return Array.isArray(t)&&t.length>0&&Array.isArray(t[0])&&Array.isArray(t[0][0])}var Nt=function(t){return Tt(t)?t[0].slice(0,-1):t},Wt=function(t){return Tt(t)?t[0]:t},Bt=/*#__PURE__*/function(t){function e(e,i,n,r){var o;return(o=t.call(this,e)||this).config=void 0,o.pixelDistance=void 0,o.mutateFeatureBehavior=void 0,o.readFeatureBehavior=void 0,o._startEndPoints=[],o.config=e,o.pixelDistance=i,o.mutateFeatureBehavior=n,o.readFeatureBehavior=r,o}s(e,t);var i=e.prototype;return i.create=function(t){if(this.ids.length)throw new Error("Opening and closing points already created");var e=Tt(t),i=Wt(t);if(e){if(i.length<=3)throw new Error("Requires at least 4 coordinates");this._startEndPoints=this.mutateFeatureBehavior.createGuidancePoints({coordinates:[i[0],i[i.length-2]],type:v.CLOSING_POINT})}else this._startEndPoints=[this.mutateFeatureBehavior.createGuidancePoint({coordinate:i[i.length-2],type:v.CLOSING_POINT})]},i.delete=function(){this.ids.length&&(this.mutateFeatureBehavior.deleteFeaturesIfPresent(this.ids),this._startEndPoints=[])},i.updateOne=function(t,e){this.mutateFeatureBehavior.updateGuidancePoints([{featureId:this.ids[t],coordinate:e}])},i.update=function(t){var e=Wt(t);1!==this.ids.length?2===this.ids.length&&this.mutateFeatureBehavior.updateGuidancePoints([{featureId:this.ids[0],coordinate:e[0]},{featureId:this.ids[1],coordinate:e[e.length-3]}]):this.mutateFeatureBehavior.updateGuidancePoints([{featureId:this.ids[0],coordinate:e[e.length-2]}])},i.isLineStringClosingPoint=function(t){if(1!==this.ids.length)return{isClosing:!1};var e=this.readFeatureBehavior.getGeometry(this.ids[0]);return{isClosing:this.pixelDistance.measure(t,e.coordinates)<this.pointerDistance}},i.isPolygonClosingPoints=function(t){if(2!==this.ids.length)return{isClosing:!1,isPreviousClosing:!1};var e=this.readFeatureBehavior.getGeometry(this.ids[0]),i=this.readFeatureBehavior.getGeometry(this.ids[1]),n=this.pixelDistance.measure(t,e.coordinates),r=this.pixelDistance.measure(t,i.coordinates);return{isClosing:n<this.pointerDistance,isPreviousClosing:r<this.pointerDistance}},n(e,[{key:"ids",get:function(){return this._startEndPoints.concat()},set:function(t){}}])}(J),At={cancel:"Escape",finish:"Enter"},Rt={start:"crosshair",close:"pointer",dragStart:"grabbing",dragEnd:"crosshair"},Lt=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="linestring",i.currentCoordinate=0,i.currentId=void 0,i.keyEvents=At,i.snapping=void 0,i.cursors=Rt,i.mouseMove=!1,i.insertCoordinates=void 0,i.lastCommittedCoordinates=void 0,i.snappedPointId=void 0,i.lastMouseMoveEvent=void 0,i.editable=!1,i.editedFeatureId=void 0,i.editedFeatureCoordinateIndex=void 0,i.editedSnapType=void 0,i.editedInsertIndex=void 0,i.editedPointId=void 0,i.coordinateSnapping=void 0,i.insertPoint=void 0,i.lineSnapping=void 0,i.pixelDistance=void 0,i.clickBoundingBox=void 0,i.mutateFeature=void 0,i.readFeature=void 0,i.closingPoints=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors)),null!=e&&e.snapping&&(this.snapping=e.snapping),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents)),null!=e&&e.insertCoordinates&&(this.insertCoordinates=e.insertCoordinates),e&&e.editable&&(this.editable=e.editable)},i.updateSnappedCoordinate=function(t){var e=this.snapCoordinate(t);return e?(this.snappedPointId?this.mutateFeature.updateGuidancePoints([{featureId:this.snappedPointId,coordinate:e}]):this.snappedPointId=this.mutateFeature.createGuidancePoint({coordinate:e,type:v.SNAPPING_POINT}),t.lng=e[0],t.lat=e[1]):this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0),e},i.close=function(){var t;if(void 0!==this.currentId&&this.mutateFeature.updateLineString({featureId:this.currentId,context:{updateType:u.Finish,action:l},coordinateMutations:[{type:it,index:-1}],propertyMutations:(t={},t[v.CURRENTLY_DRAWING]=void 0,t)})){var e=this.currentId;this.currentCoordinate=0,this.currentId=void 0,this.lastCommittedCoordinates=void 0,"drawing"===this.state&&this.setStarted(),this.closingPoints.delete(),this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0),this.editedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.editedPointId),this.editedPointId=void 0,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedInsertIndex=void 0,this.editedSnapType=void 0),this.onFinish(e,{mode:this.mode,action:l})}},i.generateInsertCoordinates=function(t,e){if(!this.insertCoordinates||!this.lastCommittedCoordinates)throw new Error("Not able to insert coordinates");if("amount"!==this.insertCoordinates.strategy)throw new Error("Strategy does not exist");var i=w(t,e)/(this.insertCoordinates.value+1),n=[];return"globe"===this.projection?n=this.insertPoint.generateInsertionGeodesicCoordinates(t,e,i):"web-mercator"===this.projection&&(n=this.insertPoint.generateInsertionCoordinates(t,e,i)),n},i.createLine=function(t){var e,i=this.mutateFeature.createLineString({coordinates:[t,t],properties:(e={mode:this.mode},e[v.CURRENTLY_DRAWING]=!0,e)});this.lastCommittedCoordinates=i.geometry.coordinates,this.currentId=i.id,this.currentCoordinate++,this.setDrawing()},i.firstUpdateToLine=function(t){if(this.currentId){this.setCursor(this.cursors.close);var e=this.mutateFeature.updateLineString({featureId:this.currentId,context:{updateType:u.Commit},coordinateMutations:[{type:tt,index:-1,coordinate:t}]});e&&(this.closingPoints.create(e.geometry.coordinates),this.lastCommittedCoordinates=e.geometry.coordinates,this.currentCoordinate++)}},i.updateToLine=function(t,e){if(this.currentId)if(this.closingPoints.isLineStringClosingPoint(t).isClosing)this.close();else{this.setCursor(this.cursors.close);var i=this.mutateFeature.updateLineString({featureId:this.currentId,context:{updateType:u.Commit},coordinateMutations:[{type:tt,index:-1,coordinate:e}]});i&&(this.closingPoints.update(i.geometry.coordinates),this.lastCommittedCoordinates=i.geometry.coordinates,this.currentCoordinate++)}},i.registerBehaviors=function(t){this.insertPoint=new Et(t),this.clickBoundingBox=new ft(t),this.pixelDistance=new vt(t),this.lineSnapping=new kt(t,this.pixelDistance,this.clickBoundingBox),this.coordinateSnapping=new yt(t,this.pixelDistance,this.clickBoundingBox),this.readFeature=new lt(t),this.mutateFeature=new rt(t,{validate:this.validate}),this.closingPoints=new Bt(t,this.pixelDistance,this.mutateFeature,this.readFeature)},i.start=function(){this.setStarted(),this.setCursor(this.cursors.start)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onMouseMove=function(t){this.mouseMove=!0,this.setCursor(this.cursors.start),this.lastMouseMoveEvent=t;var e=this.updateSnappedCoordinate(t)||[t.lng,t.lat];if(void 0!==this.currentId&&0!==this.currentCoordinate){this.closingPoints.isLineStringClosingPoint(t).isClosing&&this.setCursor(this.cursors.close);var i=[{type:et,index:-1,coordinate:e}];if(this.insertCoordinates){var n=this.getInsertCoordinates(e);n&&(i={type:nt,coordinates:n})}this.mutateFeature.updateLineString({coordinateMutations:i,featureId:this.currentId,context:{updateType:u.Provisional}})}},i.getInsertCoordinates=function(t){if(this.lastCommittedCoordinates){var e=this.lastCommittedCoordinates[this.lastCommittedCoordinates.length-1];if(!ut(e,t)){var i=this.generateInsertCoordinates(e,t),n=this.lastCommittedCoordinates.slice(0,-1);return[].concat(n,i,[t])}}},i.onRightClick=function(t){var e=this;if(this.editable&&"started"===this.state){var i=this.coordinateSnapping.getSnappable(t,function(t){return e.lineStringFilter(t)}),n=i.featureId,r=i.featureCoordinateIndex;if(n&&void 0!==r){var o=this.readFeature.getGeometry(n);"LineString"===o.type&&(o.coordinates.length<=2||(this.mutateFeature.updateLineString({featureId:n,coordinateMutations:[{type:it,index:r}],context:{updateType:u.Finish,action:h}}),this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0),this.editedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.editedPointId),this.editedPointId=void 0,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedInsertIndex=void 0,this.editedSnapType=void 0),this.closingPoints.delete(),this.onFinish(n,{mode:this.mode,action:c})))}}},i.onLeftClick=function(t){this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0);var e=this.snapCoordinate(t)||[t.lng,t.lat];0===this.currentCoordinate?this.createLine(e):1===this.currentCoordinate&&this.currentId?this.firstUpdateToLine(e):this.currentId&&this.updateToLine(t,e)},i.onClick=function(t){void 0===this.currentId||this.readFeature.hasFeature(this.currentId)||this.cleanUp(),("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t))&&(this.currentCoordinate>0&&!this.mouseMove&&this.onMouseMove(t),this.mouseMove=!1,"right"===t.button?this.onRightClick(t):"left"===t.button&&this.onLeftClick(t))},i.onKeyDown=function(){},i.onKeyUp=function(t){t.key===this.keyEvents.cancel&&this.cleanUp(),t.key===this.keyEvents.finish&&this.close()},i.onDragStart=function(t,e){var i=this;if(this.allowPointerEvent(this.pointerEvents.onDragStart,t)&&this.editable){var n=void 0;if("started"===this.state){var r=this.lineSnapping.getSnappable(t,function(t){return i.lineStringFilter(t)});r.coordinate&&(this.editedSnapType="line",this.editedFeatureCoordinateIndex=r.featureCoordinateIndex,this.editedFeatureId=r.featureId,n=r.coordinate);var o=this.coordinateSnapping.getSnappable(t,function(t){return i.lineStringFilter(t)});o.coordinate&&(this.editedSnapType="coordinate",this.editedFeatureCoordinateIndex=o.featureCoordinateIndex,this.editedFeatureId=o.featureId,n=o.coordinate)}this.editedFeatureId&&n&&(this.editedPointId||(this.editedPointId=this.mutateFeature.createGuidancePoint({coordinate:n,type:v.EDITED})),this.setCursor(this.cursors.dragStart),e(!1))}},i.onDrag=function(t,e){var i;if(this.allowPointerEvent(this.pointerEvents.onDrag,t)&&void 0!==this.editedFeatureId&&void 0!==this.editedFeatureCoordinateIndex){if("coordinate"===this.editedSnapType||"line"===this.editedSnapType&&void 0!==this.editedInsertIndex){if(!this.mutateFeature.updateLineString({featureId:this.editedFeatureId,context:{updateType:u.Provisional},coordinateMutations:[{type:et,index:this.editedFeatureCoordinateIndex,coordinate:[t.lng,t.lat]}]}))return}else if("line"===this.editedSnapType&&void 0===this.editedInsertIndex){if(this.editedInsertIndex=this.editedFeatureCoordinateIndex+1,!this.mutateFeature.updateLineString({featureId:this.editedFeatureId,context:{updateType:u.Provisional}}))return;this.editedFeatureCoordinateIndex++}this.snapping&&this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0),this.editedPointId&&this.mutateFeature.updateGuidancePoints([{featureId:this.editedPointId,coordinate:[t.lng,t.lat]}]),this.mutateFeature.updateLineString({featureId:this.editedFeatureId,context:{updateType:u.Provisional},propertyMutations:(i={},i[v.EDITED]=!0,i)})}},i.onDragEnd=function(t,e){var i;if(this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&void 0!==this.editedFeatureId&&(this.setCursor(this.cursors.dragEnd),this.mutateFeature.updateLineString({featureId:this.editedFeatureId,propertyMutations:(i={},i[v.EDITED]=!1,i),context:{updateType:u.Finish,action:h}}))){var n=this.editedFeatureId;e(!0),this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0),this.editedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.editedPointId),this.editedPointId=void 0,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedInsertIndex=void 0,this.editedSnapType=void 0),this.closingPoints.delete(),this.onFinish(n,{mode:this.mode,action:h})}},i.cleanUp=function(){var t=this.currentId,e=this.snappedPointId;this.snappedPointId=void 0,this.currentId=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted(),this.mutateFeature.deleteFeatureIfPresent(t),this.mutateFeature.deleteFeatureIfPresent(e),this.closingPoints.delete()},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});if("Feature"===t.type&&"LineString"===t.geometry.type&&t.properties.mode===this.mode)return e.lineStringColor=this.getHexColorStylingValue(this.styles.lineStringColor,e.lineStringColor,t),e.lineStringWidth=this.getNumericStylingValue(this.styles.lineStringWidth,e.lineStringWidth,t),e.zIndex=y,e;if("Feature"===t.type&&"Point"===t.geometry.type&&t.properties.mode===this.mode){var i=t.properties[v.CLOSING_POINT];return e.pointColor=this.getHexColorStylingValue(i?this.styles.closingPointColor:this.styles.snappingPointColor,e.pointColor,t),e.pointWidth=this.getNumericStylingValue(i?this.styles.closingPointWidth:this.styles.snappingPointWidth,e.pointWidth,t),e.pointOutlineColor=this.getHexColorStylingValue(i?this.styles.closingPointOutlineColor:this.styles.snappingPointOutlineColor,"#ffffff",t),e.pointOutlineWidth=this.getNumericStylingValue(i?this.styles.closingPointOutlineWidth:this.styles.snappingPointOutlineWidth,2,t),e.zIndex=50,e}return e},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return wt(t,e.coordinatePrecision)})},i.lineStringFilter=function(t){return Boolean("LineString"===t.geometry.type&&t.properties&&t.properties.mode===this.mode)},i.snapCoordinate=function(t){var e,i,n,r,o,s,a=this;if(null!=(e=this.snapping)&&e.toLine&&(o=this.currentId?this.lineSnapping.getSnappableCoordinate(t,this.currentId):this.lineSnapping.getSnappableCoordinateFirstClick(t))&&(r=o),null!=(i=this.snapping)&&i.toCoordinate&&(s=this.currentId?this.coordinateSnapping.getSnappableCoordinate(t,this.currentId):this.coordinateSnapping.getSnappableCoordinateFirstClick(t))&&(r=s),null!=(n=this.snapping)&&n.toCustom){var d=this.snapping.toCustom(t,{currentCoordinate:this.currentCoordinate,currentId:this.currentId,getCurrentGeometrySnapshot:this.currentId?function(){return a.readFeature.getGeometry(a.currentId)}:function(){return null},project:this.project,unproject:this.unproject});d&&(r=d)}return r},i.afterFeatureUpdated=function(t){this.editedFeatureId===t.id&&this.editedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.editedPointId),this.editedPointId=void 0,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedSnapType=void 0),this.snappedPointId&&this.lastMouseMoveEvent&&this.updateSnappedCoordinate(this.lastMouseMoveEvent),this.currentId===t.id&&(this.closingPoints.delete(),this.currentCoordinate=0,this.currentId=void 0,"drawing"===this.state&&this.setStarted())},e}(S),Ut="Feature is not a Point",Gt="Feature has invalid coordinates",jt="Feature has coordinates with excessive precision";function Vt(t,e){return"Point"!==t.geometry.type?{valid:!1,reason:Ut}:V(t.geometry.coordinates)?j(t.geometry.coordinates,e)?{valid:!0}:{valid:!1,reason:jt}:{valid:!1,reason:Gt}}var Yt=/*#__PURE__*/function(t){function e(e,i,n){var r;return(r=t.call(this,e)||this).pixelDistance=void 0,r.clickBoundingBox=void 0,r.pixelDistance=i,r.clickBoundingBox=n,r}return s(e,t),e.prototype.getNearestPointFeature=function(t){for(var e=this.clickBoundingBox.create(t),i=this.store.search(e),n=Infinity,r=void 0,o=0;o<i.length;o++){var s=i[o];if("Point"===s.geometry.type&&s.properties.mode===this.mode){var a=this.pixelDistance.measure(t,s.geometry.coordinates);a>n||a>this.pointerDistance||(n=a,r=s)}}return r},e}(J),zt={create:"crosshair",dragStart:"grabbing",dragEnd:"crosshair"},Kt=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="point",i.cursors=zt,i.editable=!1,i.editedFeatureId=void 0,i.pixelDistance=void 0,i.clickBoundingBox=void 0,i.pointSearch=void 0,i.mutateFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors)),null!=e&&e.editable&&(this.editable=e.editable)},i.start=function(){this.setStarted(),this.setCursor(this.cursors.create)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onClick=function(t){"right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)?this.onRightClick(t):"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)&&this.onLeftClick(t)},i.onMouseMove=function(){},i.onKeyDown=function(){},i.onKeyUp=function(){},i.cleanUp=function(){this.editedFeatureId=void 0},i.onDragStart=function(t,e){if(this.allowPointerEvent(this.pointerEvents.onDragStart,t)){if(this.editable){var i=this.pointSearch.getNearestPointFeature(t);this.editedFeatureId=null==i?void 0:i.id}this.editedFeatureId&&(this.setCursor(this.cursors.dragStart),e(!1))}},i.onDrag=function(t,e){var i;this.allowPointerEvent(this.pointerEvents.onDrag,t)&&void 0!==this.editedFeatureId&&this.mutateFeature.updatePoint({featureId:this.editedFeatureId,coordinateMutations:{type:nt,coordinates:[t.lng,t.lat]},propertyMutations:(i={},i[v.EDITED]=!0,i),context:{updateType:u.Provisional}})},i.onDragEnd=function(t,e){var i;if(this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&void 0!==this.editedFeatureId&&this.mutateFeature.updatePoint({featureId:this.editedFeatureId,propertyMutations:(i={mode:this.mode},i[v.EDITED]=!1,i),context:{updateType:u.Finish,action:"edit"}})){var n=this.editedFeatureId;this.setCursor(this.cursors.dragEnd),this.editedFeatureId=void 0,e(!0),this.onFinish(n,{mode:this.mode,action:l})}},i.registerBehaviors=function(t){this.pixelDistance=new vt(t),this.clickBoundingBox=new ft(t),this.pointSearch=new Yt(t,this.pixelDistance,this.clickBoundingBox),this.mutateFeature=new rt(t,{validate:this.validate})},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});if("Feature"===t.type&&"Point"===t.geometry.type&&t.properties.mode===this.mode){var i=Boolean(t.id&&this.editedFeatureId===t.id);e.pointWidth=this.getNumericStylingValue(i?this.styles.editedPointWidth:this.styles.pointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(i?this.styles.editedPointColor:this.styles.pointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(i?this.styles.editedPointOutlineColor:this.styles.pointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(i?this.styles.editedPointOutlineWidth:this.styles.pointOutlineWidth,2,t),e.zIndex=30}return e},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return Vt(t,e.coordinatePrecision)})},i.onLeftClick=function(t){var e,i=this.mutateFeature.createPoint({coordinates:[t.lng,t.lat],properties:(e={mode:this.mode},e[v.MARKER]=!0,e),context:{updateType:u.Finish,action:l}});i&&this.onFinish(i.id,{mode:this.mode,action:l})},i.onRightClick=function(t){if(this.editable){var e=this.pointSearch.getNearestPointFeature(t);e&&this.mutateFeature.deleteFeatureIfPresent(e.id)}},i.afterFeatureUpdated=function(t){this.editedFeatureId===t.id&&(this.editedFeatureId=void 0,this.setCursor(this.cursors.create))},e}(S),Ht=/*#__PURE__*/function(t){function e(e,i,n){var r;return(r=t.call(this,e)||this).readFeature=void 0,r.mutateFeature=void 0,r.readFeature=i,r.mutateFeature=n,r}s(e,t);var i=e.prototype;return i.createOrUpdate=function(t){var e=this,i=t.featureId,n=t.featureCoordinates;if(this.readFeature.hasFeature(i)){var r=Nt(n),o=this.readFeature.getProperties(i),s=o.coordinatePointIds;if(s)if(s&&s.every(function(t){return e.readFeature.hasFeature(t)})){var a=o.coordinatePointIds,d=a.map(function(t){return e.readFeature.getGeometry(t).coordinates});if(a.length!==r.length){this.deleteCoordinatePoints(a);var u=this.createPoints(r,o.mode,i);this.setFeatureCoordinatePoints(i,u)}else{var l=[];r.forEach(function(t,e){t[0]===d[e][0]&&t[1]===d[e][1]||l.push({featureId:a[e],coordinate:t})}),this.mutateFeature.updateGuidancePoints(l)}}else{var h=s.filter(function(t){return e.readFeature.hasFeature(t)});h.length&&this.deleteCoordinatePoints(h);var c=this.createPoints(r,o.mode,i);this.setFeatureCoordinatePoints(i,c)}else{var p=this.createPoints(r,o.mode,i);this.setFeatureCoordinatePoints(i,p)}}else this.deleteOrphanedPoints(i)},i.deletePointsByFeatureIds=function(t){for(var e,i=r(t);!(e=i()).done;)this.deleteIfPresent(e.value)},i.updateOneAtIndex=function(t,e,i){var n=this.readFeature.getProperties(t).coordinatePointIds;n&&0!==n.length&&void 0!==n[e]&&this.mutateFeature.updateGuidancePoints([{featureId:n[e],coordinate:i}])},i.updateAllInPlace=function(t){var e=t.featureCoordinates,i=this.readFeature.getProperties(t.featureId);if(i.coordinatePointIds){var n=Nt(e);n.length===i.coordinatePointIds.length&&this.mutateFeature.updateGuidancePoints(i.coordinatePointIds.map(function(t,e){return{featureId:t,coordinate:n[e]}}))}},i.createPoints=function(t,e,i){return this.mutateFeature.createGuidancePoints({coordinates:t,type:v.COORDINATE_POINT,additionalProperties:function(t){var n;return(n={mode:e})[v.COORDINATE_POINT]=!0,n[v.COORDINATE_POINT_FEATURE_ID]=i,n.index=t,n}})},i.setFeatureCoordinatePoints=function(t,e,i){var n;void 0===i&&(i=u.Commit);var r=this.readFeature.getGeometryType(t),o={featureId:t,propertyMutations:(n={},n[v.COORDINATE_POINT_IDS]=e,n),context:{updateType:i}};if("Polygon"===r)this.mutateFeature.updatePolygon(o);else{if("LineString"!==r)throw new Error("Unsupported geometry type for coordinate points");this.mutateFeature.updateLineString(o)}},i.deleteCoordinatePoints=function(t){this.mutateFeature.deleteFeaturesIfPresent(t)},i.deleteIfPresent=function(t){if(this.readFeature.hasFeature(t)){var e=this.readFeature.getProperties(t).coordinatePointIds;e&&(this.deleteCoordinatePoints(e),this.setFeatureCoordinatePoints(t,null))}},i.deleteOrphanedPoints=function(t){var e=this.readFeature.getAllFeatureIdsWhere(function(e){return e[v.COORDINATE_POINT_FEATURE_ID]===t});this.mutateFeature.deleteFeaturesIfPresent(e)},e}(J),Xt={cancel:"Escape",finish:"Enter"},qt={start:"crosshair",close:"pointer",dragStart:"grabbing",dragEnd:"crosshair"},Zt=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="polygon",i.currentCoordinate=0,i.currentId=void 0,i.keyEvents=Xt,i.cursors=qt,i.mouseMove=!1,i.showCoordinatePoints=!1,i.lastMouseMoveEvent=void 0,i.snapping=void 0,i.snappedPointId=void 0,i.editable=!1,i.editedFeatureId=void 0,i.editedFeatureCoordinateIndex=void 0,i.editedSnapType=void 0,i.editedInsertIndex=void 0,i.editedPointId=void 0,i.coordinatePoints=void 0,i.lineSnapping=void 0,i.coordinateSnapping=void 0,i.pixelDistance=void 0,i.closingPoints=void 0,i.clickBoundingBox=void 0,i.mutateFeature=void 0,i.readFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){var i=this;if(t.prototype.updateOptions.call(this,e),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors)),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents)),null!=e&&e.snapping&&(this.snapping=e.snapping),void 0!==(null==e?void 0:e.editable)&&(this.editable=e.editable),void 0!==(null==e?void 0:e.pointerEvents)&&(this.pointerEvents=e.pointerEvents),void 0!==(null==e?void 0:e.showCoordinatePoints))if(this.showCoordinatePoints=e.showCoordinatePoints,this.coordinatePoints&&!0===e.showCoordinatePoints)this.store.copyAllWhere(function(t){return t.mode===i.mode}).forEach(function(t){i.coordinatePoints.createOrUpdate({featureId:t.id,featureCoordinates:t.geometry.coordinates})});else if(this.coordinatePoints&&!1===this.showCoordinatePoints){var n=this.store.copyAllWhere(function(t){return t.mode===i.mode&&Boolean(t[v.COORDINATE_POINT_IDS])});this.coordinatePoints.deletePointsByFeatureIds(n.map(function(t){return t.id}))}},i.close=function(){var t;if(void 0!==this.currentId&&!(this.readFeature.getCoordinates(this.currentId).length<5)){var e=this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:[{type:it,index:-2}],propertyMutations:(t={},t[v.CURRENTLY_DRAWING]=void 0,t[v.COMMITTED_COORDINATE_COUNT]=void 0,t[v.PROVISIONAL_COORDINATE_COUNT]=void 0,t),context:{updateType:u.Finish,action:l}});if(e){this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate({featureId:this.currentId,featureCoordinates:e.geometry.coordinates}),"drawing"===this.state&&this.setStarted(),this.editedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.editedPointId),this.editedPointId=void 0),this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0),this.closingPoints.delete();var i=this.currentId;this.currentCoordinate=0,this.currentId=void 0,this.onFinish(i,{mode:this.mode,action:l})}}},i.registerBehaviors=function(t){this.readFeature=new lt(t),this.mutateFeature=new rt(t,{validate:this.validate}),this.clickBoundingBox=new ft(t),this.pixelDistance=new vt(t),this.lineSnapping=new kt(t,this.pixelDistance,this.clickBoundingBox),this.coordinateSnapping=new yt(t,this.pixelDistance,this.clickBoundingBox),this.closingPoints=new Bt(t,this.pixelDistance,this.mutateFeature,this.readFeature),this.coordinatePoints=new Ht(t,this.readFeature,this.mutateFeature)},i.start=function(){this.setStarted(),this.setCursor(this.cursors.start)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.updateSnappedCoordinate=function(t){var e=this.snapCoordinate(t);e?(this.snappedPointId?this.mutateFeature.updateGuidancePoints([{featureId:this.snappedPointId,coordinate:e}]):this.snappedPointId=this.mutateFeature.createGuidancePoint({coordinate:e,type:v.SNAPPING_POINT}),t.lng=e[0],t.lat=e[1]):this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0)},i.onMouseMove=function(t){var e;if(this.mouseMove=!0,this.setCursor(this.cursors.start),this.lastMouseMoveEvent=t,this.updateSnappedCoordinate(t),void 0!==this.currentId&&0!==this.currentCoordinate){var i,n=this.readFeature.getCoordinate(this.currentId,0),r=[t.lng,t.lat];if(1===this.currentCoordinate)i=[{type:et,index:1,coordinate:r},{type:et,index:2,coordinate:[t.lng,t.lat-this.mutateFeature.epsilonOffset()]}];else if(2===this.currentCoordinate)i=[{type:et,index:2,coordinate:r}];else{var o=this.closingPoints.isPolygonClosingPoints(t);o.isPreviousClosing||o.isClosing?(this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0),this.setCursor(this.cursors.close),i=[{type:et,index:-1,coordinate:n},{type:et,index:-2,coordinate:n}]):i=[{type:et,index:-2,coordinate:r},{type:et,index:-1,coordinate:n}]}var s=this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:i,propertyMutations:(e={},e[v.PROVISIONAL_COORDINATE_COUNT]=this.currentCoordinate+1,e),context:{updateType:u.Provisional}});s&&this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate({featureId:this.currentId,featureCoordinates:s.geometry.coordinates})}},i.snapCoordinate=function(t){var e,i,n,r,o,s=this,a=void 0;if(null!=(e=this.snapping)&&e.toLine&&(r=this.currentId?this.lineSnapping.getSnappableCoordinate(t,this.currentId):this.lineSnapping.getSnappableCoordinateFirstClick(t))&&(a=r),null!=(i=this.snapping)&&i.toCoordinate&&(o=this.currentId?this.coordinateSnapping.getSnappableCoordinate(t,this.currentId):this.coordinateSnapping.getSnappableCoordinateFirstClick(t))&&(a=o),null!=(n=this.snapping)&&n.toCustom){var d=this.snapping.toCustom(t,{currentCoordinate:this.currentCoordinate,currentId:this.currentId,getCurrentGeometrySnapshot:this.currentId?function(){return s.readFeature.getGeometry(s.currentId)}:function(){return null},project:this.project,unproject:this.unproject});d&&(a=d)}return a},i.polygonFilter=function(t){return Boolean("Polygon"===t.geometry.type&&t.properties&&t.properties.mode===this.mode)},i.onRightClick=function(t){var e=this;if(this.editable&&"started"===this.state){var i=this.coordinateSnapping.getSnappable(t,function(t){return e.polygonFilter(t)}),n=i.featureId,r=i.featureCoordinateIndex;if(n&&void 0!==r){var o=this.readFeature.getGeometry(n);if("Polygon"===o.type){var s=o.coordinates[0];if(!(s.length<=4)){var a=this.mutateFeature.updatePolygon({featureId:n,coordinateMutations:0===r||r===s.length-1?[{type:it,index:0},{type:it,index:-1},{type:tt,index:-1,coordinate:s[1]}]:[{type:it,index:r}],context:{updateType:u.Finish,action:h}});a&&(this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate({featureId:n,featureCoordinates:a.geometry.coordinates}),this.onFinish(n,{mode:this.mode,action:h}))}}}}},i.onLeftClick=function(t){this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0);var e=this.snapCoordinate(t)||[t.lng,t.lat];if(0===this.currentCoordinate){var i,n=this.mutateFeature.createPolygon({coordinates:[e,e,e,e],properties:(i={mode:this.mode},i[v.CURRENTLY_DRAWING]=!0,i[v.COMMITTED_COORDINATE_COUNT]=this.currentCoordinate+1,i[v.PROVISIONAL_COORDINATE_COUNT]=this.currentCoordinate+1,i)}),r=n.id;this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate({featureId:r,featureCoordinates:n.geometry.coordinates}),this.currentId=r,this.currentCoordinate++,this.setDrawing()}else if(1===this.currentCoordinate&&this.currentId){var o;if(this.readFeature.coordinateAtIndexIsIdentical({featureId:this.currentId,newCoordinate:e,index:0}))return;var s=this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:[{type:et,index:1,coordinate:e},{type:et,index:2,coordinate:e}],propertyMutations:(o={},o[v.COMMITTED_COORDINATE_COUNT]=this.currentCoordinate+1,o),context:{updateType:u.Commit}});if(!s)return;this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate({featureId:this.currentId,featureCoordinates:s.geometry.coordinates}),this.currentCoordinate++}else if(2===this.currentCoordinate&&this.currentId){var a;if(this.readFeature.coordinateAtIndexIsIdentical({featureId:this.currentId,newCoordinate:e,index:1}))return;var d=this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:[{type:et,index:2,coordinate:e},{type:tt,index:2,coordinate:e}],propertyMutations:(a={},a[v.COMMITTED_COORDINATE_COUNT]=this.currentCoordinate+1,a),context:{updateType:u.Commit}});if(!d)return;this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate({featureId:this.currentId,featureCoordinates:d.geometry.coordinates}),2===this.currentCoordinate&&this.closingPoints.create(d.geometry.coordinates),this.currentCoordinate++}else if(this.currentId){var l=this.closingPoints.isPolygonClosingPoints(t);if(l.isPreviousClosing||l.isClosing)this.close();else{var h;if(this.readFeature.coordinateAtIndexIsIdentical({featureId:this.currentId,newCoordinate:e,index:this.currentCoordinate-1}))return;var c=this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:[{type:Q,index:-1,coordinate:e}],propertyMutations:(h={},h[v.COMMITTED_COORDINATE_COUNT]=this.currentCoordinate+1,h),context:{updateType:u.Commit}});if(!c)return;this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate({featureId:this.currentId,featureCoordinates:c.geometry.coordinates}),this.currentCoordinate++,this.closingPoints.ids.length&&this.closingPoints.update(c.geometry.coordinates)}}},i.onClick=function(t){this.currentCoordinate>0&&!this.mouseMove&&this.onMouseMove(t),this.mouseMove=!1,"right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)?this.onRightClick(t):"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)&&this.onLeftClick(t)},i.onKeyUp=function(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()},i.onKeyDown=function(){},i.onDragStart=function(t,e){var i=this;if(this.allowPointerEvent(this.pointerEvents.onDragStart,t)&&this.editable){var n=void 0;if("started"===this.state){var r=this.lineSnapping.getSnappable(t,function(t){return i.polygonFilter(t)});r.coordinate&&(this.editedSnapType="line",this.editedFeatureCoordinateIndex=r.featureCoordinateIndex,this.editedFeatureId=r.featureId,n=r.coordinate);var o=this.coordinateSnapping.getSnappable(t,function(t){return i.polygonFilter(t)});o.coordinate&&(this.editedSnapType="coordinate",this.editedFeatureCoordinateIndex=o.featureCoordinateIndex,this.editedFeatureId=o.featureId,n=o.coordinate)}this.editedFeatureId&&n&&(this.editedPointId||(this.editedPointId=this.mutateFeature.createGuidancePoint({coordinate:n,type:v.EDITED})),this.setCursor(this.cursors.dragStart),e(!1))}},i.onDrag=function(t,e){var i;if(this.allowPointerEvent(this.pointerEvents.onDrag,t)&&void 0!==this.editedFeatureId&&void 0!==this.editedFeatureCoordinateIndex){var n=this.readFeature.getGeometry(this.editedFeatureId),r=[t.lng,t.lat],o=[];"coordinate"===this.editedSnapType||"line"===this.editedSnapType&&void 0!==this.editedInsertIndex?o=0===this.editedFeatureCoordinateIndex||this.editedFeatureCoordinateIndex===n.coordinates[0].length-1?[{type:et,index:0,coordinate:r},{type:et,index:-1,coordinate:r}]:[{type:et,index:this.editedFeatureCoordinateIndex,coordinate:r}]:"line"===this.editedSnapType&&void 0===this.editedInsertIndex&&(this.editedInsertIndex=this.editedFeatureCoordinateIndex+1,o=[{type:Q,index:this.editedInsertIndex,coordinate:r}],this.editedFeatureCoordinateIndex++),0!==o.length&&this.mutateFeature.updatePolygon({featureId:this.editedFeatureId,coordinateMutations:o,propertyMutations:(i={},i[v.EDITED]=!0,i),context:{updateType:u.Provisional}})&&(this.showCoordinatePoints&&void 0!==this.editedFeatureCoordinateIndex&&this.coordinatePoints.updateOneAtIndex(this.editedFeatureId,this.editedFeatureCoordinateIndex,r),this.snapping&&this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0),this.editedPointId&&this.mutateFeature.updateGuidancePoints([{featureId:this.editedPointId,coordinate:r}]))}},i.onDragEnd=function(t,e){var i;if(this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&void 0!==this.editedFeatureId&&(this.setCursor(this.cursors.dragEnd),this.mutateFeature.updatePolygon({featureId:this.editedFeatureId,propertyMutations:(i={},i[v.EDITED]=!1,i),context:{updateType:u.Finish,action:h}}))){var n=this.editedFeatureId;this.editedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.editedPointId),this.editedPointId=void 0),this.snappedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.snappedPointId),this.snappedPointId=void 0),this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedInsertIndex=void 0,this.editedSnapType=void 0,e(!0),this.onFinish(n,{mode:this.mode,action:l})}},i.cleanUp=function(){var t=this.currentId,e=this.snappedPointId,i=this.editedPointId;this.currentId=void 0,this.snappedPointId=void 0,this.editedPointId=void 0,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedInsertIndex=void 0,this.editedSnapType=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted(),t&&this.coordinatePoints.deletePointsByFeatureIds([t]),this.mutateFeature.deleteFeatureIfPresent(t),this.mutateFeature.deleteFeatureIfPresent(i),this.mutateFeature.deleteFeatureIfPresent(e),this.closingPoints.ids.length&&this.closingPoints.delete()},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});if(t.properties.mode===this.mode){if("Polygon"===t.geometry.type)return e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=y,e;if("Point"===t.geometry.type){var i=t.properties[v.EDITED],n=t.properties[v.COORDINATE_POINT],r=i?"editedPoint":t.properties[v.CLOSING_POINT]?"closingPoint":t.properties[v.SNAPPING_POINT]?"snappingPoint":n?"coordinatePoint":void 0;if(!r)return e;var s={editedPoint:{width:this.styles.editedPointOutlineWidth,color:this.styles.editedPointColor,outlineColor:this.styles.editedPointOutlineColor,outlineWidth:this.styles.editedPointOutlineWidth},closingPoint:{width:this.styles.closingPointWidth,color:this.styles.closingPointColor,outlineColor:this.styles.closingPointOutlineColor,outlineWidth:this.styles.closingPointOutlineWidth},snappingPoint:{width:this.styles.snappingPointWidth,color:this.styles.snappingPointColor,outlineColor:this.styles.snappingPointOutlineColor,outlineWidth:this.styles.snappingPointOutlineWidth},coordinatePoint:{width:this.styles.coordinatePointWidth,color:this.styles.coordinatePointColor,outlineColor:this.styles.coordinatePointOutlineColor,outlineWidth:this.styles.coordinatePointOutlineWidth}};return e.pointWidth=this.getNumericStylingValue(s[r].width,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(s[r].color,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(s[r].outlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(s[r].outlineWidth,2,t),e.zIndex=i?40:n?20:30,e}}return e},i.afterFeatureAdded=function(t){this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate({featureId:t.id,featureCoordinates:t.geometry.coordinates})},i.afterFeatureUpdated=function(t){this.showCoordinatePoints&&this.coordinatePoints.createOrUpdate({featureId:t.id,featureCoordinates:t.geometry.coordinates}),this.editedFeatureId===t.id&&this.editedPointId&&(this.mutateFeature.deleteFeatureIfPresent(this.editedPointId),this.editedPointId=void 0,this.editedFeatureId=void 0,this.editedFeatureCoordinateIndex=void 0,this.editedSnapType=void 0),this.snappedPointId&&this.lastMouseMoveEvent&&this.updateSnappedCoordinate(this.lastMouseMoveEvent),this.currentId===t.id&&(this.currentCoordinate=0,this.currentId=void 0,this.closingPoints.delete(),"drawing"===this.state&&this.setStarted())},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return q(t,e.coordinatePrecision)})},e}(S),Jt={cancel:"Escape",finish:"Enter"},$t={start:"crosshair"},Qt=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="rectangle",i.startPosition=void 0,i.endPosition=void 0,i.currentRectangleId=void 0,i.keyEvents=Jt,i.cursors=$t,i.drawInteraction="click-move",i.drawType=void 0,i.mutateFeature=void 0,i.readFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors)),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents)),null!=e&&e.drawInteraction&&(this.drawInteraction=e.drawInteraction)},i.updateRectangle=function(t,e){var i;if(this.startPosition&&this.currentRectangleId){var n=e===u.Finish;return this.mutateFeature.updatePolygon({featureId:this.currentRectangleId,coordinateMutations:[{type:et,index:1,coordinate:[t[0],this.startPosition[1]]},{type:et,index:2,coordinate:t},{type:et,index:3,coordinate:[this.startPosition[0],t[1]]}],propertyMutations:n?(i={},i[v.CURRENTLY_DRAWING]=void 0,i):{},context:n?{updateType:e,action:l}:{updateType:e}})}},i.close=function(){if(this.currentRectangleId&&this.endPosition&&this.updateRectangle(this.endPosition,u.Finish)){var t=this.currentRectangleId;this.startPosition=void 0,this.currentRectangleId=void 0,this.drawType=void 0,"drawing"===this.state&&this.setStarted(),this.onFinish(t,{mode:this.mode,action:l})}},i.beginDrawing=function(t,e){var i;void 0===e&&(e="click"),this.startPosition=[t.lng,t.lat],this.endPosition=[t.lng,t.lat];var n=this.mutateFeature.createPolygon({coordinates:[[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat]],properties:(i={mode:this.mode},i[v.CURRENTLY_DRAWING]=!0,i)});this.currentRectangleId=n.id,this.drawType=e,this.setDrawing()},i.moveDrawAllowed=function(){return"click-move"===this.drawInteraction||"click-move-or-drag"===this.drawInteraction},i.dragDrawAllowed=function(){return"click-drag"===this.drawInteraction||"click-move-or-drag"===this.drawInteraction},i.start=function(){this.setStarted(),this.setCursor(this.cursors.start)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onClick=function(t){this.moveDrawAllowed()&&("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t))&&(this.startPosition?(this.endPosition=[t.lng,t.lat],this.close()):this.beginDrawing(t))},i.onMouseMove=function(t){this.endPosition=[t.lng,t.lat],this.updateRectangle(this.endPosition,u.Provisional)},i.onKeyDown=function(){},i.onKeyUp=function(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()},i.onDragStart=function(t,e){"drawing"!==this.state&&this.allowPointerEvent(this.pointerEvents.onDragStart,t)&&this.dragDrawAllowed()&&(this.beginDrawing(t,"drag"),e(!1))},i.onDrag=function(t,e){this.allowPointerEvent(this.pointerEvents.onDrag,t)&&this.dragDrawAllowed()&&"drag"===this.drawType&&(this.endPosition=[t.lng,t.lat],this.updateRectangle(this.endPosition,u.Provisional))},i.onDragEnd=function(t,e){this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&this.dragDrawAllowed()&&"drag"===this.drawType&&(this.endPosition=[t.lng,t.lat],this.close(),e(!0))},i.cleanUp=function(){var t=this.currentRectangleId;this.startPosition=void 0,this.currentRectangleId=void 0,this.drawType=void 0,"drawing"===this.state&&this.setStarted(),this.mutateFeature.deleteFeatureIfPresent(t)},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return"Feature"===t.type&&"Polygon"===t.geometry.type&&t.properties.mode===this.mode?(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=y,e):e},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return Z(t,e.coordinatePrecision)})},i.afterFeatureUpdated=function(t){this.currentRectangleId===t.id&&(this.startPosition=void 0,this.currentRectangleId=void 0,this.drawType=void 0,"drawing"===this.state&&this.setStarted())},i.registerBehaviors=function(t){this.readFeature=new lt(t),this.mutateFeature=new rt(t,{validate:this.validate})},e}(S),te=/*#__PURE__*/function(t){function e(e){var i;if(!e.modeName)throw new Error("Mode name is required for TerraDrawRenderMode");return(i=t.call(this,e,!0)||this).type=I.Render,i.mode="render",i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e)},i.registerBehaviors=function(t){this.mode=t.mode},i.start=function(){this.setStarted()},i.stop=function(){this.setStopped()},i.onKeyUp=function(){},i.onKeyDown=function(){},i.onClick=function(){},i.onDragStart=function(){},i.onDrag=function(){},i.onDragEnd=function(){},i.onMouseMove=function(){},i.cleanUp=function(){},i.styleFeature=function(t){return{pointColor:this.getHexColorStylingValue(this.styles.pointColor,"#3f97e0",t),pointWidth:this.getNumericStylingValue(this.styles.pointWidth,6,t),pointOutlineColor:this.getHexColorStylingValue(this.styles.pointOutlineColor,"#ffffff",t),pointOutlineWidth:this.getNumericStylingValue(this.styles.pointOutlineWidth,0,t),polygonFillColor:this.getHexColorStylingValue(this.styles.polygonFillColor,"#3f97e0",t),polygonFillOpacity:this.getNumericStylingValue(this.styles.polygonFillOpacity,.3,t),polygonOutlineColor:this.getHexColorStylingValue(this.styles.polygonOutlineColor,"#3f97e0",t),polygonOutlineWidth:this.getNumericStylingValue(this.styles.polygonOutlineWidth,4,t),lineStringWidth:this.getNumericStylingValue(this.styles.lineStringWidth,4,t),lineStringColor:this.getHexColorStylingValue(this.styles.lineStringColor,"#3f97e0",t),zIndex:this.getNumericStylingValue(this.styles.zIndex,0,t)}},i.validateFeature=function(e){var i=t.prototype.validateFeature.call(this,e);if(i.valid){var n=e,r=Vt(n,this.coordinatePrecision).valid||q(n,this.coordinatePrecision).valid||wt(n,this.coordinatePrecision).valid;return r?{valid:!0}:{valid:r,reason:"Feature is not a valid Point, Polygon or LineString feature"}}return i},e}(S);function ee(t,e){var i=t,n=e,r=O(i[1]),o=O(n[1]),s=O(n[0]-i[0]);s>Math.PI&&(s-=2*Math.PI),s<-Math.PI&&(s+=2*Math.PI);var a=Math.log(Math.tan(o/2+Math.PI/4)/Math.tan(r/2+Math.PI/4)),d=(b(Math.atan2(s,a))+360)%360;return d>180?-(360-d):d}function ie(t,e,i){var n=e;e<0&&(n=-Math.abs(n));var r=n/D,o=t[0]*Math.PI/180,s=O(t[1]),a=O(i),d=r*Math.cos(a),u=s+d;Math.abs(u)>Math.PI/2&&(u=u>0?Math.PI-u:-Math.PI-u);var l=Math.log(Math.tan(u/2+Math.PI/4)/Math.tan(s/2+Math.PI/4)),h=Math.abs(l)>1e-11?d/l:Math.cos(s),c=[(180*(o+r*Math.sin(a)/h)/Math.PI+540)%360-180,180*u/Math.PI];return c[0]+=c[0]-t[0]>180?-360:t[0]-c[0]>180?360:0,c}function ne(t,e,i,n,r){var o=n(t[0],t[1]),s=n(e[0],e[1]),a=r((o.x+s.x)/2,(o.y+s.y)/2),d=a.lat;return[k(a.lng,i),k(d,i)]}function re(t,e,i){var n=ie(t,1e3*w(t,e)/2,ee(t,e));return[k(n[0],i),k(n[1],i)]}function oe(t){for(var e=t.featureCoords,i=t.precision,n=t.unproject,r=t.project,o=t.projection,s=[],a=0;a<e.length-1;a++){var d=void 0;if("web-mercator"===o)d=ne(e[a],e[a+1],i,r,n);else{if("globe"!==o)throw new Error("Invalid projection");d=re(e[a],e[a+1],i)}s.push(d)}return s}var se=/*#__PURE__*/function(t){function e(e,i,n,r,o){var s;return(s=t.call(this,e)||this).config=void 0,s.selectionPointBehavior=void 0,s.coordinatePointBehavior=void 0,s.mutateFeature=void 0,s.readFeature=void 0,s._midPoints=[],s.config=e,s.selectionPointBehavior=i,s.coordinatePointBehavior=n,s.mutateFeature=r,s.readFeature=o,s}s(e,t);var i=e.prototype;return i.getMidpointConfig=function(t){return{featureCoords:t,precision:this.coordinatePrecision,project:this.config.project,unproject:this.config.unproject,projection:this.config.projection}},i.insert=function(t){var e=t.featureId,i=t.midPointId,n=this.readFeature.getGeometry(i),r=this.readFeature.getProperties(i),o=r.midPointFeatureId,s=r.midPointSegment,a=this.readFeature.getGeometry(o),d={featureId:o,coordinateMutations:[{type:tt,index:s,coordinate:n.coordinates}],context:{updateType:u.Commit}},l=null;if("Polygon"===a.type)l=this.mutateFeature.updatePolygon(d);else{if("LineString"!==a.type)throw new Error("Midpoints can only be added to polygons or linestrings");l=this.mutateFeature.updateLineString(d)}if(!l)throw new Error("Failed to insert midpoint coordinate");var h=l.geometry.coordinates;this.readFeature.getProperties(e)[v.COORDINATE_POINT_IDS]&&this.coordinatePointBehavior.createOrUpdate({featureId:e,featureCoordinates:h}),this.mutateFeature.deleteFeaturesIfPresent([].concat(this.selectionPointBehavior.ids,this._midPoints)),this.create({featureCoordinates:h,featureId:o}),this.selectionPointBehavior.create({featureCoordinates:h,featureId:e})},i.create=function(t){var e=this,i=t.featureCoordinates,n=t.featureId;if(!this.readFeature.hasFeature(n))throw new Error("Store does not have feature with this id");var r=Wt(i),o=oe(this.getMidpointConfig(r));this._midPoints=this.mutateFeature.createGuidancePoints({additionalProperties:function(t){var i;return(i={mode:e.mode,midPointSegment:t,midPointFeatureId:n})[f.MID_POINT]=!0,i},coordinates:o,type:f.MID_POINT})},i.delete=function(){this._midPoints.length&&(this.mutateFeature.deleteFeaturesIfPresent(this._midPoints),this._midPoints=[])},i.updateAllInPlace=function(t){if(0!==this._midPoints.length){var e=Wt(t.featureCoordinates),i=oe(this.getMidpointConfig(e));this.mutateFeature.updateGuidancePoints(this._midPoints.map(function(t,e){return{featureId:t,coordinate:i[e]}}))}},i.updateOneAtIndex=function(t,e){if(t<0&&(t=this._midPoints.length+t),void 0!==this._midPoints[t]){var i=Wt(e),n=oe(this.getMidpointConfig(i));this.mutateFeature.updateGuidancePoints([{featureId:this._midPoints[t],coordinate:n[t]}])}},n(e,[{key:"ids",get:function(){return this._midPoints.concat()},set:function(t){}}])}(J),ae=/*#__PURE__*/function(t){function e(e,i){var n;return(n=t.call(this,e)||this).mutateFeature=void 0,n._selectionPoints=[],n.mutateFeature=i,n}s(e,t);var i=e.prototype;return i.create=function(t){var e=t.featureId,i=Nt(t.featureCoordinates);this._selectionPoints=this.mutateFeature.createGuidancePoints({coordinates:i,type:f.SELECTION_POINT,additionalProperties:function(t){var i;return(i={})[f.SELECTION_POINT_FEATURE_ID]=e,i.index=t,i}})},i.delete=function(){this.ids.length&&(this.mutateFeature.deleteFeaturesIfPresent(this.ids),this._selectionPoints=[])},i.updateAllInPlace=function(t){if(0!==this._selectionPoints.length){var e=Nt(t.featureCoordinates);e.length===this._selectionPoints.length&&this.mutateFeature.updateGuidancePoints(this._selectionPoints.map(function(t,i){return{featureId:t,coordinate:e[i]}}))}},i.updateOneAtIndex=function(t,e){void 0!==this._selectionPoints[t]&&this.mutateFeature.updateGuidancePoints([{featureId:this._selectionPoints[t],coordinate:e}])},n(e,[{key:"ids",get:function(){return this._selectionPoints.concat()},set:function(t){}}])}(J);function de(t,e){for(var i,n,r,o=!1,s=0,a=e.length;s<a;s++)for(var d=e[s],u=0,l=d.length,h=l-1;u<l;h=u++)(n=d[u])[1]>(i=t)[1]!=(r=d[h])[1]>i[1]&&i[0]<(r[0]-n[0])*(i[1]-n[1])/(r[1]-n[1])+n[0]&&(o=!o);return o}var ue=function(t,e,i){var n=function(t){return t*t},r=function(t,e){return n(t.x-e.x)+n(t.y-e.y)};return Math.sqrt(function(t,e,i){var n=r(e,i);if(0===n)return r(t,e);var o=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/n;return o=Math.max(0,Math.min(1,o)),r(t,{x:e.x+o*(i.x-e.x),y:e.y+o*(i.y-e.y)})}(t,e,i))},le=/*#__PURE__*/function(t){function e(e,i,n){var r;return(r=t.call(this,e)||this).config=void 0,r.createClickBoundingBox=void 0,r.pixelDistance=void 0,r.config=e,r.createClickBoundingBox=i,r.pixelDistance=n,r}return s(e,t),e.prototype.find=function(t,e){for(var i=void 0,n=Infinity,r=void 0,o=Infinity,s=void 0,a=Infinity,d=void 0,u=this.createClickBoundingBox.create(t),l=this.store.search(u),h=0;h<l.length;h++){var c=l[h],p=c.geometry;if("Point"===p.type){if(c.properties.selectionPoint||c.properties.coordinatePoint||!e&&c.properties[f.MID_POINT])continue;var g=this.pixelDistance.measure(t,p.coordinates);c.properties[f.MID_POINT]&&g<this.pointerDistance&&g<a?(a=g,s=c):!c.properties[f.MID_POINT]&&g<this.pointerDistance&&g<n&&(n=g,i=c)}else if("LineString"===p.type){if(i)continue;for(var v=0;v<p.coordinates.length-1;v++){var y=p.coordinates[v],m=p.coordinates[v+1],P=ue({x:t.containerX,y:t.containerY},this.project(y[0],y[1]),this.project(m[0],m[1]));P<this.pointerDistance&&P<o&&(o=P,r=c)}}else if("Polygon"===p.type){if(i||r)continue;de([t.lng,t.lat],p.coordinates)&&(d=c)}}return{clickedFeature:i||r||d,clickedMidPoint:s}},e}(J),he=/*#__PURE__*/function(t){function e(e,i,n,r,o,s,a){var d;return(d=t.call(this,e)||this).config=void 0,d.featuresAtCursorEvent=void 0,d.selectionPoints=void 0,d.midPoints=void 0,d.coordinatePoints=void 0,d.readFeature=void 0,d.mutateFeature=void 0,d.draggedFeatureId=null,d.dragPosition=void 0,d.config=e,d.featuresAtCursorEvent=i,d.selectionPoints=n,d.midPoints=r,d.coordinatePoints=o,d.readFeature=s,d.mutateFeature=a,d}s(e,t);var i=e.prototype;return i.startDragging=function(t,e){this.draggedFeatureId=e,this.dragPosition=[t.lng,t.lat]},i.stopDragging=function(){this.draggedFeatureId=null,this.dragPosition=void 0},i.isDragging=function(){return null!==this.draggedFeatureId},i.canDrag=function(t,e){var i=this.featuresAtCursorEvent.find(t,!0).clickedFeature;return!(!i||i.id!==e)},i.drag=function(t){if(this.draggedFeatureId){var e=this.readFeature.getGeometry(this.draggedFeatureId),i=[t.lng,t.lat];if("Polygon"===e.type||"LineString"===e.type){var n,r;if(r="Polygon"===e.type?(n=e.coordinates[0]).length-1:(n=e.coordinates).length,!this.dragPosition)return!1;for(var o=0;o<r;o++){var s=n[o],a=void 0,d=void 0;if("web-mercator"===this.config.projection){var l=B(this.dragPosition[0],this.dragPosition[1]),h=B(i[0],i[1]),c=B(s[0],s[1]),p={x:l.x-h.x,y:l.y-h.y},g=A(c.x-p.x,c.y-p.y);a=g.lng,d=g.lat}else{var f=[this.dragPosition[0]-i[0],this.dragPosition[1]-i[1]];a=s[0]-f[0],d=s[1]-f[1]}if(a=k(a,this.config.coordinatePrecision),d=k(d,this.config.coordinatePrecision),a>180||a<-180||d>90||d<-90)return!1;n[o]=[a,d]}"Polygon"===e.type&&(n[n.length-1]=[n[0][0],n[0][1]]);var v=this.draggedFeatureId,y=null;if("Polygon"===e.type)y=this.mutateFeature.updatePolygon({featureId:v,coordinateMutations:{type:nt,coordinates:[n]},context:{updateType:u.Provisional}});else{if("LineString"!==e.type)return;y=this.mutateFeature.updateLineString({featureId:v,coordinateMutations:{type:nt,coordinates:n},context:{updateType:u.Provisional}})}if(!y)return!1;var m=y.geometry.coordinates;this.midPoints.updateAllInPlace({featureCoordinates:m}),this.selectionPoints.updateAllInPlace({featureCoordinates:m}),this.coordinatePoints.updateAllInPlace({featureId:v,featureCoordinates:m}),this.dragPosition=[t.lng,t.lat]}else"Point"===e.type&&(this.mutateFeature.updatePoint({featureId:this.draggedFeatureId,coordinateMutations:{type:nt,coordinates:i},context:{updateType:u.Provisional}}),this.dragPosition=[t.lng,t.lat])}},e}(J),ce=/*#__PURE__*/function(t){function e(e,i,n,r,o,s,a,d,u){var l;return(l=t.call(this,e)||this).config=void 0,l.pixelDistance=void 0,l.selectionPoints=void 0,l.midPoints=void 0,l.coordinatePoints=void 0,l.coordinateSnapping=void 0,l.lineSnapping=void 0,l.readFeature=void 0,l.mutateFeature=void 0,l.draggedCoordinate={id:null,index:-1},l.config=e,l.pixelDistance=i,l.selectionPoints=n,l.midPoints=r,l.coordinatePoints=o,l.coordinateSnapping=s,l.lineSnapping=a,l.readFeature=d,l.mutateFeature=u,l}s(e,t);var i=e.prototype;return i.getClosestCoordinate=function(t,e){var i,n={dist:Infinity,index:-1,isFirstOrLastPolygonCoord:!1};if("LineString"===e.type)i=e.coordinates;else{if("Polygon"!==e.type)return n;i=e.coordinates[0]}for(var r=0;r<i.length;r++){var o=this.pixelDistance.measure(t,i[r]);if(o<this.pointerDistance&&o<n.dist){var s="Polygon"===e.type&&(r===i.length-1||0===r);n.dist=o,n.index=s?0:r,n.isFirstOrLastPolygonCoord=s}}return n},i.getDraggableIndex=function(t,e){var i=this.readFeature.getGeometry(e),n=this.getClosestCoordinate(t,i);return-1===n.index?-1:n.index},i.snapCoordinate=function(t,e,i){var n,r,o,s=this,a=[t.lng,t.lat],d=function(t){return Boolean(t.properties&&t.properties.mode===i.properties.mode&&t.id!==s.draggedCoordinate.id)};return null!=e&&e.toLine&&(n=this.lineSnapping.getSnappable(t,d).coordinate)&&(a=n),e.toCoordinate&&(r=this.coordinateSnapping.getSnappable(t,d).coordinate)&&(a=r),null!=e&&e.toCustom&&(o=e.toCustom(t,{currentCoordinate:this.draggedCoordinate.index,currentId:i.id,getCurrentGeometrySnapshot:i.id?function(){return s.readFeature.getGeometry(i.id)}:function(){return null},project:this.project,unproject:this.unproject}))&&(a=o),a},i.drag=function(t,e,i){var n=this.draggedCoordinate.id;if(null===n)return!1;var r=this.draggedCoordinate.index,o=this.readFeature.getGeometry(n),s=this.readFeature.getProperties(n),a="LineString"===o.type?o.coordinates:o.coordinates[0],d="Polygon"===o.type&&(r===a.length-1||0===r),l=this.snapCoordinate(t,i,{type:"Feature",id:n,geometry:o,properties:s});if(t.lng>180||t.lng<-180||t.lat>90||t.lat<-90)return!1;if(d){var h=a.length-1;a[0]=l,a[h]=l}else a[r]=l;if("Point"!==o.type&&!e&&U({type:"Feature",geometry:o,properties:{}}))return!1;var c=n,p=null;return"Polygon"===o.type?p=this.mutateFeature.updatePolygon({featureId:c,coordinateMutations:{type:nt,coordinates:[a]},context:{updateType:u.Provisional}}):"LineString"===o.type&&(p=this.mutateFeature.updateLineString({featureId:c,coordinateMutations:{type:nt,coordinates:a},context:{updateType:u.Provisional}})),!!p&&(this.midPoints.updateOneAtIndex(r>0?r-1:-1,a),this.midPoints.updateOneAtIndex(r,a),this.selectionPoints.updateOneAtIndex(r,l),this.coordinatePoints.updateOneAtIndex(c,r,l),!0)},i.isDragging=function(){return null!==this.draggedCoordinate.id},i.startDragging=function(t,e){this.draggedCoordinate={id:t,index:e}},i.stopDragging=function(){this.draggedCoordinate={id:null,index:-1}},e}(J);function pe(t){var e=0,i=0,n=0;return("Polygon"===t.geometry.type?t.geometry.coordinates[0].slice(0,-1):t.geometry.coordinates).forEach(function(t){e+=t[0],i+=t[1],n++},!0),[e/n,i/n]}var ge=function(t,e){if(0===e||360===e||-360===e)return t;var i=.017453292519943295*e,n=("Polygon"===t.geometry.type?t.geometry.coordinates[0]:t.geometry.coordinates).map(function(t){return B(t[0],t[1])}),r=n.reduce(function(t,e){return{x:t.x+e.x,y:t.y+e.y}},{x:0,y:0});r.x/=n.length,r.y/=n.length;var o=n.map(function(t){return{x:r.x+(t.x-r.x)*Math.cos(i)-(t.y-r.y)*Math.sin(i),y:r.y+(t.x-r.x)*Math.sin(i)+(t.y-r.y)*Math.cos(i)}}).map(function(t){var e=t.x,i=t.y;return[A(e,i).lng,A(e,i).lat]});return"Polygon"===t.geometry.type?t.geometry.coordinates[0]=o:t.geometry.coordinates=o,t};function fe(t){var e=("Polygon"===t.geometry.type?t.geometry.coordinates[0]:t.geometry.coordinates).map(function(t){var e=B(t[0],t[1]);return[e.x,e.y]});return"Polygon"===t.geometry.type?function(t){for(var e=0,i=0,n=0,r=t.length,o=0;o<r-1;o++){var s=t[o],a=s[0],d=s[1],u=t[o+1],l=u[0],h=u[1],c=a*h-l*d;e+=c,i+=(a+l)*c,n+=(d+h)*c}return{x:i/=6*(e/=2),y:n/=6*e}}(e):function(t){for(var e=t.length,i=0,n=0,r=0;r<e;r++){var o=t[r];i+=o[0],n+=o[1]}return{x:i/e,y:n/e}}(e)}var ve=/*#__PURE__*/function(t){function e(e,i,n,r,o,s){var a;return(a=t.call(this,e)||this).config=void 0,a.selectionPoints=void 0,a.midPoints=void 0,a.coordinatePoints=void 0,a.readFeature=void 0,a.mutateFeature=void 0,a.lastBearing=void 0,a.selectedGeometry=void 0,a.selectedGeometryCentroid=void 0,a.selectedGeometryWebMercatorCentroid=void 0,a.config=e,a.selectionPoints=i,a.midPoints=n,a.coordinatePoints=r,a.readFeature=o,a.mutateFeature=s,a}s(e,t);var i=e.prototype;return i.reset=function(){this.lastBearing=void 0,this.selectedGeometry=void 0,this.selectedGeometryWebMercatorCentroid=void 0,this.selectedGeometryCentroid=void 0},i.rotate=function(t,e){var i=this;this.selectedGeometry||(this.selectedGeometry=this.readFeature.getGeometry(e));var n=this.selectedGeometry;if("Polygon"===n.type||"LineString"===n.type){var r,o=[t.lng,t.lat],s={type:"Feature",geometry:n,properties:{}};if("web-mercator"===this.config.projection){this.selectedGeometryWebMercatorCentroid||(this.selectedGeometryWebMercatorCentroid=fe(s));var a=B(t.lng,t.lat);if(0===(r=It(this.selectedGeometryWebMercatorCentroid,a)))return;if(!this.lastBearing)return void(this.lastBearing=r);ge(s,-(this.lastBearing-r))}else{if("globe"!==this.config.projection)throw new Error("Unsupported projection");if(this.selectedGeometryCentroid||(this.selectedGeometryCentroid=pe({type:"Feature",geometry:n,properties:{}})),r=ee(this.selectedGeometryCentroid,o),!this.lastBearing)return void(this.lastBearing=r+180);!function(t,e){if(0===e||360===e||-360===e)return t;var i=pe(t);("Polygon"===t.geometry.type?t.geometry.coordinates[0]:t.geometry.coordinates).forEach(function(t){var n=ee(i,t)+e,r=function(t,e){t[0]+=t[0]-e[0]>180?-360:e[0]-t[0]>180?360:0;var i=D,n=e[1]*Math.PI/180,r=t[1]*Math.PI/180,o=r-n,s=Math.abs(t[0]-e[0])*Math.PI/180;s>Math.PI&&(s-=2*Math.PI);var a=Math.log(Math.tan(r/2+Math.PI/4)/Math.tan(n/2+Math.PI/4)),d=Math.abs(a)>1e-11?o/a:Math.cos(n);return Math.sqrt(o*o+d*d*s*s)*i}(i,t),o=ie(i,r,n);t[0]=o[0],t[1]=o[1]})}(s,-(this.lastBearing-(r+180)))}var d="Polygon"===n.type?n.coordinates[0]:n.coordinates;d.forEach(function(t){t[0]=k(t[0],i.coordinatePrecision),t[1]=k(t[1],i.coordinatePrecision)});var l={featureId:e,coordinateMutations:{type:nt,coordinates:"Polygon"===n.type?[d]:d},context:{updateType:u.Provisional}},h=null;if("Polygon"===s.geometry.type)h=this.mutateFeature.updatePolygon(l);else{if("LineString"!==s.geometry.type)return;h=this.mutateFeature.updateLineString(l)}if(!h)return!1;var c=h.geometry.coordinates;this.midPoints.updateAllInPlace({featureCoordinates:c}),this.selectionPoints.updateAllInPlace({featureCoordinates:c}),this.coordinatePoints.updateAllInPlace({featureId:e,featureCoordinates:c}),"web-mercator"===this.projection?this.lastBearing=r:"globe"===this.projection&&(this.lastBearing=r+180)}},e}(J),ye=/*#__PURE__*/function(t){function e(e,i){var n;return(n=t.call(this,e)||this).config=void 0,n.dragCoordinateResizeBehavior=void 0,n.config=e,n.dragCoordinateResizeBehavior=i,n}s(e,t);var i=e.prototype;return i.scale=function(t,e){if(!this.dragCoordinateResizeBehavior.isDragging()){var i=this.dragCoordinateResizeBehavior.getDraggableIndex(t,e);this.dragCoordinateResizeBehavior.startDragging(e,i)}this.dragCoordinateResizeBehavior.drag(t,"center-fixed")},i.reset=function(){this.dragCoordinateResizeBehavior.stopDragging()},e}(J);function me(t){var e=t.originX,i=t.originY,n=t.xScale,r=t.yScale;1===n&&1===r||t.coordinates.forEach(function(t){var o=B(t[0],t[1]),s=A(e+(o.x-e)*n,i+(o.y-i)*r),a=s.lat;t[0]=s.lng,t[1]=a})}var Pe=/*#__PURE__*/function(t){function e(e,i,n,r,o,s,a){var d;return(d=t.call(this,e)||this).config=void 0,d.pixelDistance=void 0,d.selectionPoints=void 0,d.midPoints=void 0,d.coordinatePoints=void 0,d.readFeature=void 0,d.mutateFeature=void 0,d.minimumScale=1e-4,d.draggedCoordinate={id:null,index:-1},d.boundingBoxMaps={opposite:{0:4,1:5,2:6,3:7,4:0,5:1,6:2,7:3}},d.config=e,d.pixelDistance=i,d.selectionPoints=n,d.midPoints=r,d.coordinatePoints=o,d.readFeature=s,d.mutateFeature=a,d}s(e,t);var i=e.prototype;return i.getClosestCoordinate=function(t,e){var i,n={dist:Infinity,index:-1,isFirstOrLastPolygonCoord:!1};if("LineString"===e.type)i=e.coordinates;else{if("Polygon"!==e.type)return n;i=e.coordinates[0]}for(var r=0;r<i.length;r++){var o=this.pixelDistance.measure(t,i[r]);if(o<this.pointerDistance&&o<n.dist){var s="Polygon"===e.type&&(r===i.length-1||0===r);n.dist=o,n.index=s?0:r,n.isFirstOrLastPolygonCoord=s}}return n},i.isValidDragWebMercator=function(t,e,i){switch(t){case 0:if(e<=0||i>=0)return!1;break;case 1:if(i>=0)return!1;break;case 2:if(e>=0||i>=0)return!1;break;case 3:if(e>=0)return!1;break;case 4:if(e>=0||i<=0)return!1;break;case 5:if(i<=0)return!1;break;case 6:if(e<=0||i<=0)return!1;break;case 7:if(e<=0)return!1}return!0},i.getSelectedFeatureDataWebMercator=function(){if(!this.draggedCoordinate.id||-1===this.draggedCoordinate.index)return null;var t=this.getFeature(this.draggedCoordinate.id);if(!t)return null;var e=this.getNormalisedCoordinates(t.geometry);return{boundingBox:this.getBBoxWebMercator(e),feature:t,updatedCoords:e,selectedCoordinate:e[this.draggedCoordinate.index]}},i.centerWebMercatorDrag=function(t){var e=this.getSelectedFeatureDataWebMercator();if(!e)return null;var i=e.boundingBox,n=e.updatedCoords,r=e.selectedCoordinate,o=fe(e.feature);if(!o)return null;var s=B(r[0],r[1]),a=this.getIndexesWebMercator(i,s).closestBBoxIndex,d=B(t.lng,t.lat);return this.scaleWebMercator({closestBBoxIndex:a,updatedCoords:n,webMercatorCursor:d,webMercatorSelected:s,webMercatorOrigin:o}),n},i.centerFixedWebMercatorDrag=function(t){var e=this.getSelectedFeatureDataWebMercator();if(!e)return null;var i=e.boundingBox,n=e.updatedCoords,r=e.selectedCoordinate,o=fe(e.feature);if(!o)return null;var s=B(r[0],r[1]),a=this.getIndexesWebMercator(i,s).closestBBoxIndex,d=B(t.lng,t.lat);return this.scaleFixedWebMercator({closestBBoxIndex:a,updatedCoords:n,webMercatorCursor:d,webMercatorSelected:s,webMercatorOrigin:o}),n},i.scaleFixedWebMercator=function(t){var e=t.webMercatorOrigin,i=t.webMercatorSelected,n=t.webMercatorCursor,r=t.updatedCoords;if(!this.isValidDragWebMercator(t.closestBBoxIndex,e.x-n.x,e.y-n.y))return null;var o=dt(e,n)/dt(e,i);return o<0&&(o=this.minimumScale),me({coordinates:r,originX:e.x,originY:e.y,xScale:o,yScale:o}),r},i.oppositeFixedWebMercatorDrag=function(t){var e=this.getSelectedFeatureDataWebMercator();if(!e)return null;var i=e.boundingBox,n=e.updatedCoords,r=e.selectedCoordinate,o=B(r[0],r[1]),s=this.getIndexesWebMercator(i,o),a=s.oppositeBboxIndex,d=s.closestBBoxIndex,u={x:i[a][0],y:i[a][1]},l=B(t.lng,t.lat);return this.scaleFixedWebMercator({closestBBoxIndex:d,updatedCoords:n,webMercatorCursor:l,webMercatorSelected:o,webMercatorOrigin:u}),n},i.oppositeWebMercatorDrag=function(t){var e=this.getSelectedFeatureDataWebMercator();if(!e)return null;var i=e.boundingBox,n=e.updatedCoords,r=e.selectedCoordinate,o=B(r[0],r[1]),s=this.getIndexesWebMercator(i,o),a=s.oppositeBboxIndex,d=s.closestBBoxIndex,u={x:i[a][0],y:i[a][1]},l=B(t.lng,t.lat);return this.scaleWebMercator({closestBBoxIndex:d,updatedCoords:n,webMercatorCursor:l,webMercatorSelected:o,webMercatorOrigin:u}),n},i.scaleWebMercator=function(t){var e=t.closestBBoxIndex,i=t.webMercatorOrigin,n=t.webMercatorSelected,r=t.webMercatorCursor,o=t.updatedCoords,s=i.x-r.x,a=i.y-r.y;if(!this.isValidDragWebMercator(e,s,a))return null;var d=1;0!==s&&1!==e&&5!==e&&(d=1-(i.x-n.x-s)/s);var u=1;return 0!==a&&3!==e&&7!==e&&(u=1-(i.y-n.y-a)/a),this.validateScale(d,u)?(d<0&&(d=this.minimumScale),u<0&&(u=this.minimumScale),this.performWebMercatorScale(o,i.x,i.y,d,u),o):null},i.getFeature=function(t){if(null===this.draggedCoordinate.id)return null;var e=this.readFeature.getGeometry(t);return"Polygon"!==e.type&&"LineString"!==e.type?null:{id:t,type:"Feature",geometry:e,properties:{}}},i.getNormalisedCoordinates=function(t){return"Polygon"===t.type?t.coordinates[0]:t.coordinates},i.validateScale=function(t,e){var i=!isNaN(t)&&e<Number.MAX_SAFE_INTEGER,n=!isNaN(e)&&e<Number.MAX_SAFE_INTEGER;return i&&n},i.performWebMercatorScale=function(t,e,i,n,r){t.forEach(function(t){var o=B(t[0],t[1]),s=A(e+(o.x-e)*n,i+(o.y-i)*r),a=s.lat;t[0]=s.lng,t[1]=a})},i.getBBoxWebMercator=function(t){var e=[Infinity,Infinity,-Infinity,-Infinity];(t=t.map(function(t){var e=B(t[0],t[1]);return[e.x,e.y]})).forEach(function(t){var i=t[0],n=t[1];i<e[0]&&(e[0]=i),n<e[1]&&(e[1]=n),i>e[2]&&(e[2]=i),n>e[3]&&(e[3]=n)});var i=e[0],n=e[1],r=e[2],o=e[3];return[[i,o],[(i+r)/2,o],[r,o],[r,o+(n-o)/2],[r,n],[(i+r)/2,n],[i,n],[i,o+(n-o)/2]]},i.getIndexesWebMercator=function(t,e){for(var i,n=Infinity,r=0;r<t.length;r++){var o=dt({x:e.x,y:e.y},{x:t[r][0],y:t[r][1]});o<n&&(i=r,n=o)}if(void 0===i)throw new Error("No closest coordinate found");return{oppositeBboxIndex:this.boundingBoxMaps.opposite[i],closestBBoxIndex:i}},i.isDragging=function(){return null!==this.draggedCoordinate.id},i.startDragging=function(t,e){this.draggedCoordinate={id:t,index:e}},i.stopDragging=function(){this.draggedCoordinate={id:null,index:-1}},i.getDraggableIndex=function(t,e){var i=this.readFeature.getGeometry(e),n=this.getClosestCoordinate(t,i);return-1===n.index?-1:n.index},i.drag=function(t,e){if(!this.draggedCoordinate.id)return!1;var i=this.getFeature(this.draggedCoordinate.id);if(!i)return!1;var n=null;if("center"===e?n=this.centerWebMercatorDrag(t):"opposite"===e?n=this.oppositeWebMercatorDrag(t):"center-fixed"===e?n=this.centerFixedWebMercatorDrag(t):"opposite-fixed"===e&&(n=this.oppositeFixedWebMercatorDrag(t)),!n)return!1;for(var r=0;r<n.length;r++){var o=n[r];if(o[0]=k(o[0],this.coordinatePrecision),o[1]=k(o[1],this.coordinatePrecision),!j(o,this.coordinatePrecision))return!1}var s=i.id,a=null;if("Polygon"===i.geometry.type?a=this.mutateFeature.updatePolygon({featureId:s,coordinateMutations:{type:nt,coordinates:[n]},context:{updateType:u.Provisional}}):"LineString"===i.geometry.type&&(a=this.mutateFeature.updateLineString({featureId:s,coordinateMutations:{type:nt,coordinates:n},context:{updateType:u.Provisional}})),!a)return!1;var d=Nt(i.geometry.coordinates);return this.midPoints.updateAllInPlace({featureCoordinates:d}),this.selectionPoints.updateAllInPlace({featureCoordinates:d}),this.coordinatePoints.updateAllInPlace({featureId:s,featureCoordinates:d}),!0},e}(J),Ce={deselect:"Escape",delete:"Delete",rotate:["Control","r"],scale:["Control","s"]},Ie={pointerOver:"move",dragStart:"move",dragEnd:"move",insertMidpoint:"crosshair"},Fe=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="select",i.allowManualDeselection=!0,i.dragEventThrottle=5,i.dragEventCount=0,i.selected=[],i.flags={},i.keyEvents=Ce,i.cursors=Ie,i.validations={},i.selectionPoints=void 0,i.midPoints=void 0,i.coordinateSnap=void 0,i.featuresAtMouseEvent=void 0,i.pixelDistance=void 0,i.clickBoundingBox=void 0,i.dragFeature=void 0,i.dragCoordinate=void 0,i.rotateFeature=void 0,i.scaleFeature=void 0,i.dragCoordinateResizeFeature=void 0,i.coordinatePoints=void 0,i.lineSnap=void 0,i.mutateFeature=void 0,i.readFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){if(t.prototype.updateOptions.call(this,e),this.cursors=e&&e.cursors?o({},this.cursors,e.cursors):Ie,null===(null==e?void 0:e.keyEvents)?this.keyEvents={deselect:null,delete:null,rotate:null,scale:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents)),void 0!==(null==e?void 0:e.dragEventThrottle)&&(this.dragEventThrottle=e.dragEventThrottle),void 0!==(null==e?void 0:e.allowManualDeselection)&&(this.allowManualDeselection=e.allowManualDeselection),null!=e&&e.flags)for(var i in this.flags=o({},this.flags,e.flags),this.validations={},this.flags){var n=this.flags[i].feature;n&&n.validation&&(this.validations[i]=n.validation)}},i.selectFeature=function(t){this.select(t,!1)},i.setSelecting=function(){if("started"!==this._state)throw new Error("Mode must be started to move to selecting state");this._state="selecting"},i.registerBehaviors=function(t){var e=this;this.readFeature=new lt(t),this.mutateFeature=new rt(t,{validate:function(t,i){var n=t.properties.mode;return e.validations&&e.validations[n]?e.validations[n](t,i):{valid:!0}}}),this.pixelDistance=new vt(t),this.clickBoundingBox=new ft(t),this.featuresAtMouseEvent=new le(t,this.clickBoundingBox,this.pixelDistance),this.selectionPoints=new ae(t,this.mutateFeature),this.coordinatePoints=new Ht(t,this.readFeature,this.mutateFeature),this.midPoints=new se(t,this.selectionPoints,this.coordinatePoints,this.mutateFeature,this.readFeature),this.coordinateSnap=new yt(t,this.pixelDistance,this.clickBoundingBox),this.lineSnap=new kt(t,this.pixelDistance,this.clickBoundingBox),this.rotateFeature=new ve(t,this.selectionPoints,this.midPoints,this.coordinatePoints,this.readFeature,this.mutateFeature),this.dragFeature=new he(t,this.featuresAtMouseEvent,this.selectionPoints,this.midPoints,this.coordinatePoints,this.readFeature,this.mutateFeature),this.dragCoordinate=new ce(t,this.pixelDistance,this.selectionPoints,this.midPoints,this.coordinatePoints,this.coordinateSnap,this.lineSnap,this.readFeature,this.mutateFeature),this.dragCoordinateResizeFeature=new Pe(t,this.pixelDistance,this.selectionPoints,this.midPoints,this.coordinatePoints,this.readFeature,this.mutateFeature),this.scaleFeature=new ye(t,this.dragCoordinateResizeFeature)},i.deselectFeature=function(){this.deselect()},i.deselect=function(){this.mutateFeature.setDeselected(this.selected),this.onDeselect(this.selected[0]),this.selected=[],this.selectionPoints.delete(),this.midPoints.delete()},i.deleteSelected=function(){this.selected.length&&this.mutateFeature.deleteFeaturesIfPresent(this.selected),this.selected=[]},i.onRightClick=function(t){var e=this;if(this.selectionPoints.ids.length){var i,n=Infinity;if(this.selectionPoints.ids.forEach(function(r){var o=e.readFeature.getGeometry(r),s=e.pixelDistance.measure(t,o.coordinates);s<e.pointerDistance&&s<n&&(n=s,i=e.readFeature.getProperties(r))}),i){var r=i.selectionPointFeatureId,o=i.index,s=this.readFeature.getProperties(r),a=this.flags[s.mode];if(a&&a.feature&&a.feature.coordinates&&a.feature.coordinates.deletable){var d,l=this.readFeature.getGeometry(r);if("Polygon"===l.type){if((d=l.coordinates[0]).length<=4)return}else{if("LineString"!==l.type)return;if((d=l.coordinates).length<=2)return}"Polygon"!==l.type||0!==o&&o!==d.length-1?d.splice(o,1):(d.shift(),d.pop(),d.push([d[0][0],d[0][1]]));var h=null;if("Polygon"===l.type?h=this.mutateFeature.updatePolygon({featureId:r,coordinateMutations:{type:nt,coordinates:[d]},context:{updateType:u.Commit}}):"LineString"===l.type&&(h=this.mutateFeature.updateLineString({featureId:r,coordinateMutations:{type:nt,coordinates:d},context:{updateType:u.Commit}})),h){var p=h.geometry.coordinates;this.mutateFeature.deleteFeaturesIfPresent([].concat(this.midPoints.ids,this.selectionPoints.ids)),s.coordinatePointIds&&this.coordinatePoints.createOrUpdate({featureId:r,featureCoordinates:p}),this.selectionPoints.create({featureCoordinates:p,featureId:r}),a&&a.feature&&a.feature.coordinates&&a.feature.coordinates.midpoints&&this.midPoints.create({featureCoordinates:p,featureId:r}),this.onFinish(r,{action:c,mode:this.mode})}}}}},i.select=function(t,e){if(void 0===e&&(e=!0),this.selected[0]!==t){var i=this.readFeature.getProperties(t),n=this.flags[i.mode];if(n&&n.feature){var r=this.selected[0];if(r){if(r===t)return;this.deselect()}e&&this.setCursor(this.cursors.pointerOver),this.selected=[t],this.mutateFeature.setSelected(t),this.onSelect(t);var o=this.readFeature.getGeometry(t),s=o.type,a=o.coordinates;"LineString"!==s&&"Polygon"!==s||a&&n&&n.feature.coordinates&&(this.selectionPoints.create({featureCoordinates:a,featureId:t}),n.feature.coordinates.midpoints&&this.midPoints.create({featureCoordinates:a,featureId:t}))}}},i.onLeftClick=function(t){var e=this.featuresAtMouseEvent.find(t,this.selected.length>0),i=e.clickedFeature,n=e.clickedMidPoint;if(this.selected.length&&n)return this.midPoints.insert({featureId:this.selected[0],midPointId:n.id}),void this.onFinish(this.selected[0],{action:p,mode:this.mode});if(i&&i.id)this.select(i.id,!0);else if(this.selected.length&&this.allowManualDeselection)return void this.deselect()},i.start=function(){this.setStarted(),this.setSelecting()},i.stop=function(){this.cleanUp(),this.setStarted(),this.setStopped()},i.onClick=function(t){"right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)?this.onRightClick(t):"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)&&this.onLeftClick(t)},i.canScale=function(t){return this.keyEvents.scale&&this.keyEvents.scale.every(function(e){return t.heldKeys.includes(e)})},i.canRotate=function(t){return this.keyEvents.rotate&&this.keyEvents.rotate.every(function(e){return t.heldKeys.includes(e)})},i.preventDefaultKeyEvent=function(t){var e=this.canRotate(t),i=this.canScale(t);(e||i)&&t.preventDefault()},i.onKeyDown=function(t){this.preventDefaultKeyEvent(t)},i.onKeyUp=function(t){if(this.preventDefaultKeyEvent(t),this.keyEvents.delete&&t.key===this.keyEvents.delete){if(!this.selected.length)return;var e=this.selected[0];this.onDeselect(this.selected[0]),this.coordinatePoints.deletePointsByFeatureIds([e]),this.deleteSelected(),this.selectionPoints.delete(),this.midPoints.delete()}else this.keyEvents.deselect&&t.key===this.keyEvents.deselect&&this.cleanUp()},i.cleanUp=function(){this.selected.length&&this.deselect()},i.onDragStart=function(t,e){if(this.allowPointerEvent(this.pointerEvents.onDragStart,t)&&this.selected.length){var i=this.readFeature.getProperties(this.selected[0]),n=this.flags[i.mode];if(n&&n.feature&&(n.feature.draggable||n.feature.coordinates&&n.feature.coordinates.draggable||n.feature.coordinates&&n.feature.coordinates.resizable||n.feature.coordinates&&"object"==typeof n.feature.coordinates.midpoints&&n.feature.coordinates.midpoints.draggable)){this.dragEventCount=0;var r=this.selected[0],o=this.dragCoordinate.getDraggableIndex(t,r);if(n&&n.feature&&n.feature.coordinates&&(n.feature.coordinates.draggable||n.feature.coordinates.resizable)&&-1!==o)return this.setCursor(this.cursors.dragStart),n.feature.coordinates.resizable?this.dragCoordinateResizeFeature.startDragging(r,o):this.dragCoordinate.startDragging(r,o),void e(!1);if(n&&n.feature&&n.feature.coordinates&&"object"==typeof n.feature.coordinates.midpoints&&n.feature.coordinates.midpoints.draggable){var s=this.featuresAtMouseEvent.find(t,this.selected.length>0).clickedMidPoint;if(this.selected.length&&s){this.midPoints.insert({featureId:r,midPointId:s.id}),this.onFinish(this.selected[0],{action:p,mode:this.mode});var a=this.dragCoordinate.getDraggableIndex(t,r);return this.dragCoordinate.startDragging(r,a),void e(!1)}}return n&&n.feature&&n.feature.draggable&&this.dragFeature.canDrag(t,r)?(this.setCursor(this.cursors.dragStart),this.dragFeature.startDragging(t,r),void e(!1)):void 0}}},i.onDrag=function(t,e){if(this.allowPointerEvent(this.pointerEvents.onDrag,t)){var i=this.selected[0];if(i){var n=this.readFeature.getProperties(i),r=this.flags[n.mode],o=!0===(r&&r.feature&&r.feature.selfIntersectable);if(this.dragEventCount++,this.dragEventCount%this.dragEventThrottle!=0){if(r&&r.feature&&r.feature.rotateable&&this.canRotate(t))return e(!1),void this.rotateFeature.rotate(t,i);if(r&&r.feature&&r.feature.scaleable&&this.canScale(t))return e(!1),void this.scaleFeature.scale(t,i);if(this.dragCoordinateResizeFeature.isDragging()&&r.feature&&r.feature.coordinates&&r.feature.coordinates.resizable){if("globe"===this.projection)throw new Error("Globe is currently unsupported projection for resizable");return e(!1),void this.dragCoordinateResizeFeature.drag(t,r.feature.coordinates.resizable)}if(this.dragCoordinate.isDragging()){var s,a=null==(s=r.feature)||null==(s=s.coordinates)?void 0:s.snappable,d={toCoordinate:!1};return!0===a?d={toCoordinate:!0}:"object"==typeof a&&(d=a),void this.dragCoordinate.drag(t,o,d)}this.dragFeature.isDragging()?this.dragFeature.drag(t):e(!0)}}}},i.onDragEnd=function(t,e){this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&(this.setCursor(this.cursors.dragEnd),this.dragCoordinate.isDragging()?this.onFinish(this.selected[0],{mode:this.mode,action:"dragCoordinate"}):this.dragFeature.isDragging()?this.onFinish(this.selected[0],{mode:this.mode,action:"dragFeature"}):this.dragCoordinateResizeFeature.isDragging()&&this.onFinish(this.selected[0],{mode:this.mode,action:"dragCoordinateResize"}),this.dragCoordinate.stopDragging(),this.dragFeature.stopDragging(),this.dragCoordinateResizeFeature.stopDragging(),this.rotateFeature.reset(),this.scaleFeature.reset(),e(!0))},i.onMouseMove=function(t){var e=this;if(this.selected.length){if(!this.dragFeature.isDragging()){var i=!1;this.midPoints.ids.forEach(function(n){if(!i){var r=e.readFeature.getGeometry(n);e.pixelDistance.measure(t,r.coordinates)<e.pointerDistance&&(i=!0)}});var n=!1;if(this.selectionPoints.ids.forEach(function(r){var o=e.readFeature.getGeometry(r);e.pixelDistance.measure(t,o.coordinates)<e.pointerDistance&&(i=!1,n=!0)}),i)this.setCursor(this.cursors.insertMidpoint);else{var r=this.featuresAtMouseEvent.find(t,!0).clickedFeature;this.setCursor(this.selected.length>0&&(r&&r.id===this.selected[0]||n)?this.cursors.pointerOver:"unset")}}}else this.setCursor("unset")},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});if(t.properties.mode===this.mode&&"Point"===t.geometry.type){if(t.properties[f.SELECTION_POINT])return e.pointColor=this.getHexColorStylingValue(this.styles.selectionPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.selectionPointOutlineColor,e.pointOutlineColor,t),e.pointWidth=this.getNumericStylingValue(this.styles.selectionPointWidth,e.pointWidth,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.selectionPointOutlineWidth,2,t),e.zIndex=30,e;if(t.properties[f.MID_POINT])return e.pointColor=this.getHexColorStylingValue(this.styles.midPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.midPointOutlineColor,e.pointOutlineColor,t),e.pointWidth=this.getNumericStylingValue(this.styles.midPointWidth,4,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.midPointOutlineWidth,2,t),e.zIndex=50,e}else if(t.properties[f.SELECTED]){if("Point"===t.geometry.type&&t.properties[v.MARKER])return e.markerUrl=this.getUrlStylingValue(this.styles.selectedMarkerUrl,g,t),e.markerHeight=this.getNumericStylingValue(this.styles.selectedMarkerHeight,40,t),e.markerWidth=this.getNumericStylingValue(this.styles.selectedMarkerWidth,32,t),e;if("Polygon"===t.geometry.type)return e.polygonFillColor=this.getHexColorStylingValue(this.styles.selectedPolygonColor,e.polygonFillColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.selectedPolygonOutlineWidth,e.polygonOutlineWidth,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.selectedPolygonOutlineColor,e.polygonOutlineColor,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.selectedPolygonFillOpacity,e.polygonFillOpacity,t),e.zIndex=y,e;if("LineString"===t.geometry.type)return e.lineStringColor=this.getHexColorStylingValue(this.styles.selectedLineStringColor,e.lineStringColor,t),e.lineStringWidth=this.getNumericStylingValue(this.styles.selectedLineStringWidth,e.lineStringWidth,t),e.zIndex=y,e;if("Point"===t.geometry.type)return e.pointWidth=this.getNumericStylingValue(this.styles.selectedPointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(this.styles.selectedPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.selectedPointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.selectedPointOutlineWidth,e.pointOutlineWidth,t),e.zIndex=y,e}return e},i.afterFeatureUpdated=function(t){if(this.selected.length&&t.id===this.selected[0]){var e,i,n=this.flags[t.properties.mode];if(null==n||null==(e=n.feature)||!e.coordinates)return;var r=t.geometry.type,o=t.id;if(this.selectionPoints.delete(),this.midPoints.delete(),"LineString"!==r&&"Polygon"!==r)return;var s=t.geometry.coordinates;this.selectionPoints.create({featureCoordinates:s,featureId:o}),null!=n&&null!=(i=n.feature)&&null!=(i=i.coordinates)&&i.midpoints&&this.midPoints.create({featureCoordinates:s,featureId:o})}},e}(E),xe=/*#__PURE__*/function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).type=I.Static,e.mode="static",e}s(e,t);var i=e.prototype;return i.start=function(){},i.stop=function(){},i.onKeyUp=function(){},i.onKeyDown=function(){},i.onClick=function(){},i.onDragStart=function(){},i.onDrag=function(){},i.onDragEnd=function(){},i.onMouseMove=function(){},i.cleanUp=function(){},i.styleFeature=function(){return o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0})},e}(S);function Me(t,e,i,n,r){for(;n>i;){if(n-i>600){var o=n-i+1,s=e-i+1,a=Math.log(o),d=.5*Math.exp(2*a/3),u=.5*Math.sqrt(a*d*(o-d)/o)*(s-o/2<0?-1:1);Me(t,e,Math.max(i,Math.floor(e-s*d/o+u)),Math.min(n,Math.floor(e+(o-s)*d/o+u)),r)}var l=t[e],h=i,c=n;for(Se(t,i,e),r(t[n],l)>0&&Se(t,i,n);h<c;){for(Se(t,h,c),h++,c--;r(t[h],l)<0;)h++;for(;r(t[c],l)>0;)c--}0===r(t[i],l)?Se(t,i,c):Se(t,++c,n),c<=e&&(i=c+1),e<=c&&(n=c-1)}}function Se(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function Ee(t,e){we(t,0,t.children.length,e,t)}function we(t,e,i,n,r){r||(r=We([])),r.minX=Infinity,r.minY=Infinity,r.maxX=-Infinity,r.maxY=-Infinity;for(var o=e;o<i;o++){var s=t.children[o];De(r,t.leaf?n(s):s)}return r}function De(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function Oe(t,e){return t.minX-e.minX}function _e(t,e){return t.minY-e.minY}function be(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function ke(t){return t.maxX-t.minX+(t.maxY-t.minY)}function Te(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function Ne(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function We(t){return{children:t,height:1,leaf:!0,minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity}}function Be(t,e,i,n,r){for(var o=[e,i];o.length;)if(!((i=o.pop())-(e=o.pop())<=n)){var s=e+Math.ceil((i-e)/n/2)*n;Me(t,s,e,i,r),o.push(e,s,s,i)}}var Ae=/*#__PURE__*/function(){function t(t){this._maxEntries=void 0,this._minEntries=void 0,this.data=void 0,this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}var e=t.prototype;return e.search=function(t){var e=this.data,i=[];if(!Ne(t,e))return i;for(var n=this.toBBox,r=[];e;){for(var o=0;o<e.children.length;o++){var s=e.children[o],a=e.leaf?n(s):s;Ne(t,a)&&(e.leaf?i.push(s):Te(t,a)?this._all(s,i):r.push(s))}e=r.pop()}return i},e.collides=function(t){var e=this.data;if(Ne(t,e))for(var i=[];e;){for(var n=0;n<e.children.length;n++){var r=e.children[n],o=e.leaf?this.toBBox(r):r;if(Ne(t,o)){if(e.leaf||Te(t,o))return!0;i.push(r)}}e=i.pop()}return!1},e.load=function(t){if(t.length<this._minEntries)for(var e=0;e<t.length;e++)this.insert(t[e]);else{var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var n=this.data;this.data=i,i=n}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i}},e.insert=function(t){this._insert(t,this.data.height-1)},e.clear=function(){this.data=We([])},e.remove=function(t){for(var e,i,n=this.data,r=this.toBBox(t),o=[],s=[],a=!1;n||o.length;){if(n||(n=o.pop(),i=o[o.length-1],e=s.pop(),a=!0),n.leaf){var d=n.children.indexOf(t);-1!==d&&(n.children.splice(d,1),o.push(n),this._condense(o))}a||n.leaf||!Te(n,r)?i?(e++,n=i.children[e],a=!1):n=null:(o.push(n),s.push(e),e=0,i=n,n=n.children[0])}},e.toBBox=function(t){return t},e.compareMinX=function(t,e){return t.minX-e.minX},e.compareMinY=function(t,e){return t.minY-e.minY},e._all=function(t,e){for(var i=[];t;)t.leaf?e.push.apply(e,t.children):i.push.apply(i,t.children),t=i.pop();return e},e._build=function(t,e,i,n){var r,o=i-e+1,s=this._maxEntries;if(o<=s)return Ee(r=We(t.slice(e,i+1)),this.toBBox),r;n||(n=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,n-1))),(r=We([])).leaf=!1,r.height=n;var a=Math.ceil(o/s),d=a*Math.ceil(Math.sqrt(s));Be(t,e,i,d,this.compareMinX);for(var u=e;u<=i;u+=d){var l=Math.min(u+d-1,i);Be(t,u,l,a,this.compareMinY);for(var h=u;h<=l;h+=a){var c=Math.min(h+a-1,l);r.children.push(this._build(t,h,c,n-1))}}return Ee(r,this.toBBox),r},e._chooseSubtree=function(t,e,i,n){for(;n.push(e),!e.leaf&&n.length-1!==i;){for(var r=Infinity,o=Infinity,s=void 0,a=0;a<e.children.length;a++){var d=e.children[a],u=be(d),l=(h=t,c=d,(Math.max(c.maxX,h.maxX)-Math.min(c.minX,h.minX))*(Math.max(c.maxY,h.maxY)-Math.min(c.minY,h.minY))-u);l<o?(o=l,r=u<r?u:r,s=d):l===o&&u<r&&(r=u,s=d)}e=s||e.children[0]}var h,c;return e},e._insert=function(t,e,i){var n=i?t:this.toBBox(t),r=[],o=this._chooseSubtree(n,this.data,e,r);for(o.children.push(t),De(o,n);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(n,r,e)},e._split=function(t,e){var i=t[e],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);var o=this._chooseSplitIndex(i,r,n),s=We(i.children.splice(o,i.children.length-o));s.height=i.height,s.leaf=i.leaf,Ee(i,this.toBBox),Ee(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(i,s)},e._splitRoot=function(t,e){this.data=We([t,e]),this.data.height=t.height+1,this.data.leaf=!1,Ee(this.data,this.toBBox)},e._chooseSplitIndex=function(t,e,i){for(var n,r,o,s,a,d,u,l=Infinity,h=Infinity,c=e;c<=i-e;c++){var p=we(t,0,c,this.toBBox),g=we(t,c,i,this.toBBox),f=(r=p,o=g,s=Math.max(r.minX,o.minX),a=Math.max(r.minY,o.minY),d=Math.min(r.maxX,o.maxX),u=Math.min(r.maxY,o.maxY),Math.max(0,d-s)*Math.max(0,u-a)),v=be(p)+be(g);f<l?(l=f,n=c,h=v<h?v:h):f===l&&v<h&&(h=v,n=c)}return n||i-e},e._chooseSplitAxis=function(t,e,i){var n=t.leaf?this.compareMinX:Oe,r=t.leaf?this.compareMinY:_e;this._allDistMargin(t,e,i,n)<this._allDistMargin(t,e,i,r)&&t.children.sort(n)},e._allDistMargin=function(t,e,i,n){t.children.sort(n);for(var r=this.toBBox,o=we(t,0,e,r),s=we(t,i-e,i,r),a=ke(o)+ke(s),d=e;d<i-e;d++){var u=t.children[d];De(o,t.leaf?r(u):u),a+=ke(o)}for(var l=i-e-1;l>=e;l--){var h=t.children[l];De(s,t.leaf?r(h):h),a+=ke(s)}return a},e._adjustParentBBoxes=function(t,e,i){for(var n=i;n>=0;n--)De(e[n],t)},e._condense=function(t){for(var e,i=t.length-1;i>=0;i--)0===t[i].children.length?i>0?(e=t[i-1].children).splice(e.indexOf(t[i]),1):this.clear():Ee(t[i],this.toBBox)},t}(),Re=/*#__PURE__*/function(){function t(t){this.tree=void 0,this.idToNode=void 0,this.nodeToId=void 0,this.tree=new Ae(t&&t.maxEntries?t.maxEntries:9),this.idToNode=new Map,this.nodeToId=new Map}var e=t.prototype;return e.setMaps=function(t,e){this.idToNode.set(t.id,e),this.nodeToId.set(e,t.id)},e.toBBox=function(t){var e,i=[],n=[];if("Polygon"===t.geometry.type)e=t.geometry.coordinates[0];else if("LineString"===t.geometry.type)e=t.geometry.coordinates;else{if("Point"!==t.geometry.type)throw new Error("Not a valid feature to turn into a bounding box");e=[t.geometry.coordinates]}for(var r=0;r<e.length;r++)n.push(e[r][1]),i.push(e[r][0]);var o=Math.min.apply(Math,n),s=Math.max.apply(Math,n);return{minX:Math.min.apply(Math,i),minY:o,maxX:Math.max.apply(Math,i),maxY:s}},e.insert=function(t){if(this.idToNode.get(String(t.id)))throw new Error("Feature already exists");var e=this.toBBox(t);this.setMaps(t,e),this.tree.insert(e)},e.load=function(t){var e=this,i=[],n=new Set;t.forEach(function(t){var r=e.toBBox(t);if(e.setMaps(t,r),n.has(String(t.id)))throw new Error("Duplicate feature ID found "+t.id);n.add(String(t.id)),i.push(r)}),this.tree.load(i)},e.update=function(t){this.remove(t.id);var e=this.toBBox(t);this.setMaps(t,e),this.tree.insert(e)},e.remove=function(t){var e=this.idToNode.get(t);if(!e)throw new Error(t+" not inserted into the spatial index");this.tree.remove(e)},e.clear=function(){this.tree.clear()},e.search=function(t){var e=this;return this.tree.search(this.toBBox(t)).map(function(t){return e.nodeToId.get(t)})},e.collides=function(t){return this.tree.collides(this.toBBox(t))},t}(),Le={getId:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},isValidId:function(t){return"string"==typeof t&&36===t.length}},Ue={target:"geometry"},Ge={target:"properties"},je=/*#__PURE__*/function(){function t(t){this.idStrategy=void 0,this.tracked=void 0,this.spatialIndex=void 0,this.store=void 0,this._onChange=function(){},this.store={},this.spatialIndex=new Re,this.tracked=!t||!1!==t.tracked,this.idStrategy=t&&t.idStrategy?t.idStrategy:Le}var e=t.prototype;return e.clone=function(t){return JSON.parse(JSON.stringify(t))},e.getId=function(){return this.idStrategy.getId()},e.has=function(t){return Boolean(this.store[t])},e.load=function(t,e,i,n){var r=this;if(0===t.length)return[];var o=this.clone(t),s=[],a=[];o=o.filter(function(t){null==t.id&&(t.id=r.idStrategy.getId());var i=t.id;if(e){var n=e(t);if(!n.valid)return s.push({id:i,valid:!1,reason:n.reason}),!1}if(r.tracked){if(t.properties.createdAt){if(!C(t.properties.createdAt))return s.push({id:t.id,valid:!1,reason:"createdAt is not a valid numeric timestamp"}),!1}else t.properties.createdAt=+new Date;if(t.properties.updatedAt){if(!C(t.properties.updatedAt))return s.push({id:t.id,valid:!1,reason:"updatedAt is not a valid numeric timestamp"}),!1}else t.properties.updatedAt=+new Date}return r.has(i)?(s.push({id:i,valid:!1,reason:"Feature already exists with this id: "+i}),!1):(r.store[i]=t,a.push(t),s.push({id:i,valid:!0}),!0)}),this.spatialIndex.load(o);var d=a.map(function(t){return t.id});return d.length>0&&(this._onChange(d,"create",n),i&&a.forEach(function(t){i(t)})),s},e.search=function(t,e){var i=this,n=this.spatialIndex.search(t).map(function(t){return i.store[t]});return this.clone(e?n.filter(e):n)},e.registerOnChange=function(t){this._onChange=function(e,i,n){t(e,i,n)}},e.getGeometryCopy=function(t){var e=this.store[t];if(!e)throw new Error("No feature with this id ("+t+"), can not get geometry copy");return this.clone(e.geometry)},e.getPropertiesCopy=function(t){var e=this.store[t];if(!e)throw new Error("No feature with this id ("+t+"), can not get properties copy");return this.clone(e.properties)},e.updateProperty=function(t,e){var i=this,n=new Set;t.forEach(function(t){var e=t.id,r=t.property,o=t.value,s=i.store[e];if(!s)throw new Error("No feature with this ("+e+"), can not update geometry");s.properties[r]!==o&&(n.add(e),void 0===o?delete s.properties[r]:s.properties[r]=o,i.tracked&&(s.properties.updatedAt=+new Date))}),this._onChange&&n.size>0&&this._onChange(Array.from(n),"update",e?o({},e,Ge):Ge)},e.updateGeometry=function(t,e){var i=this,n=new Set;t.forEach(function(t){var e=t.id,r=t.geometry;n.add(e);var o=i.store[e];if(!o)throw new Error("No feature with this ("+e+"), can not update geometry");o.geometry=i.clone(r),i.spatialIndex.update(o),i.tracked&&(o.properties.updatedAt=+new Date)}),this._onChange&&n.size>0&&this._onChange(Array.from(n),"update",e?o({},e,Ue):Ue)},e.create=function(t,e){var i=this,n=[];return t.forEach(function(t){var e,r=t.geometry,s=t.properties,a=o({},s);i.tracked&&(e=+new Date,s?(a.createdAt="number"==typeof s.createdAt?s.createdAt:e,a.updatedAt="number"==typeof s.updatedAt?s.updatedAt:e):a={createdAt:e,updatedAt:e});var d=i.getId(),u={id:d,type:"Feature",geometry:r,properties:a};i.store[d]=u,i.spatialIndex.insert(u),n.push(d)}),this._onChange&&this._onChange([].concat(n),"create",e),n},e.delete=function(t,e){var i=this;t.forEach(function(t){if(!i.store[t])throw new Error("No feature with id "+t+", can not delete");delete i.store[t],i.spatialIndex.remove(t)}),this._onChange&&this._onChange([].concat(t),"delete",e)},e.copy=function(t){return this.clone(this.store[t])},e.copyAll=function(){var t=this;return this.clone(Object.keys(this.store).map(function(e){return t.store[e]}))},e.copyAllWhere=function(t){var e=this;return this.clone(Object.keys(this.store).map(function(t){return e.store[t]}).filter(function(e){return e.properties&&t(e.properties)}))},e.clear=function(){this.store={},this.spatialIndex.clear()},e.size=function(){return Object.keys(this.store).length},t}();function Ve(t){var e=t.coordinates,i=0;if(e&&e.length>0){i+=Math.abs(Ke(e[0]));for(var n=1;n<e.length;n++)i-=Math.abs(Ke(e[n]))}return i}var Ye=20294876564838.72,ze=Math.PI/180;function Ke(t){var e=t.length;if(e<=2)return 0;for(var i=0,n=0;n<e;)i+=(t[n+2>=e?(n+2)%e:n+2][0]*ze-t[n][0]*ze)*Math.sin(t[n+1===e?0:n+1][1]*ze),n++;return i*Ye}var He="Feature is smaller than the minimum area",Xe="Feature is not a Polygon or LineString",qe="Feature intersects itself";function Ze(t,e,i){var n=It(t,e),r=It(e,i)-n;return r<0&&(r+=360),180-Math.abs(r-90-90)}var Je={cancel:"Escape",finish:"Enter"},$e={start:"crosshair",close:"pointer"},Qe=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="angled-rectangle",i.currentCoordinate=0,i.currentId=void 0,i.keyEvents=Je,i.cursors=$e,i.mouseMove=!1,i.mutateFeature=void 0,i.readFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors)),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents))},i.close=function(){var t;if(void 0!==this.currentId&&this.mutateFeature.updatePolygon({featureId:this.currentId,propertyMutations:(t={},t[v.CURRENTLY_DRAWING]=void 0,t),context:{updateType:u.Finish,action:l}})){var e=this.currentId;this.currentCoordinate=0,this.currentId=void 0,"drawing"===this.state&&this.setStarted(),this.onFinish(e,{mode:this.mode,action:l})}},i.start=function(){this.setStarted(),this.setCursor(this.cursors.start)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onMouseMove=function(t){if(this.mouseMove=!0,this.setCursor(this.cursors.start),void 0!==this.currentId&&0!==this.currentCoordinate){var e=[];if(1===this.currentCoordinate)e=this.getUpdateForSecondCoordinate(t);else{if(2!==this.currentCoordinate)return;e=this.getNewSecondAndThirdCoordinates(t)}this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:e,context:{updateType:u.Provisional}})}},i.getUpdateForSecondCoordinate=function(t){var e=this.mutateFeature.epsilonOffset();return[{type:et,index:1,coordinate:[t.lng,t.lat]},{type:et,index:2,coordinate:[t.lng,t.lat-e]}]},i.getNewSecondAndThirdCoordinates=function(t){if(!this.currentId)throw new Error("No current feature being drawn");var e,i,n,r,o=this.readFeature.getCoordinate(this.currentId,0),s=this.readFeature.getCoordinate(this.currentId,1),a=ne(o,s,this.coordinatePrecision,this.project,this.unproject),d=B(o[0],o[1]),u=B(a[0],a[1]),l=B(s[0],s[1]),h=B(t.lng,t.lat),c=dt(h,d)<dt(h,l),p=Ze(d,u,h),g=c?90-p:Ze(d,u,h)-90,f=dt(u,h),v=Math.cos(O(g))*f,y=It(d,l)+("right"==((r=((n=h).x-(i=l).x)*((e=d).y-i.y)-(n.y-i.y)*(e.x-i.x))>1e-10?"left":r<-1e-10?"right":"left")?-90:90),m=Pt(d,v,y),P=Pt(l,v,y),C=A(m.x,m.y),I=A(P.x,P.y);return[{type:et,index:2,coordinate:[k(I.lng,this.coordinatePrecision),k(I.lat,this.coordinatePrecision)]},{type:et,index:3,coordinate:[k(C.lng,this.coordinatePrecision),k(C.lat,this.coordinatePrecision)]}]},i.onClick=function(t){if("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t))if(this.currentCoordinate>0&&!this.mouseMove&&this.onMouseMove(t),this.mouseMove=!1,0===this.currentCoordinate){var e,i=this.mutateFeature.createPolygon({coordinates:[[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat]],properties:(e={mode:this.mode},e[v.CURRENTLY_DRAWING]=!0,e)});this.currentId=i.id,this.currentCoordinate++,this.setDrawing()}else if(1===this.currentCoordinate&&this.currentId){var n=this.readFeature.getCoordinate(this.currentId,0);if(ut([t.lng,t.lat],n))return;if(!this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:[{type:et,index:1,coordinate:[t.lng,t.lat]},{type:tt,index:1,coordinate:[t.lng,t.lat]}],context:{updateType:u.Commit}}))return;this.currentCoordinate++}else 2===this.currentCoordinate&&this.currentId&&this.close()},i.onKeyUp=function(t){if(t.key===this.keyEvents.cancel)this.cleanUp();else if(t.key===this.keyEvents.finish){if(this.currentCoordinate<2)return void this.cleanUp();this.close()}},i.onKeyDown=function(){},i.onDragStart=function(){},i.onDrag=function(){},i.onDragEnd=function(){},i.cleanUp=function(){var t=this.currentId;this.currentId=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted(),this.mutateFeature.deleteFeatureIfPresent(t)},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return t.properties.mode===this.mode&&"Polygon"===t.geometry.type&&(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=y),e},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return Z(t,e.coordinatePrecision)})},i.afterFeatureUpdated=function(t){this.currentId===t.id&&(this.currentId=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted())},i.registerBehaviors=function(t){this.readFeature=new lt(t),this.mutateFeature=new rt(t,{validate:this.validate})},e}(S);function ti(t,e,i){return(e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x)<=0}var ei={cancel:"Escape",finish:"Enter"},ii={start:"crosshair",close:"pointer"},ni=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="sector",i.currentCoordinate=0,i.currentId=void 0,i.keyEvents=ei,i.direction=void 0,i.arcPoints=64,i.cursors=ii,i.mouseMove=!1,i.readFeature=void 0,i.mutateFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors)),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents)),null!=e&&e.arcPoints&&(this.arcPoints=e.arcPoints)},i.close=function(){var t;if(void 0!==this.currentId&&this.mutateFeature.updatePolygon({featureId:this.currentId,propertyMutations:(t={},t[v.CURRENTLY_DRAWING]=void 0,t),coordinateMutations:{coordinates:this.readFeature.getGeometry(this.currentId).coordinates,type:nt},context:{updateType:u.Finish,action:l}})){var e=this.currentId;this.currentCoordinate=0,this.currentId=void 0,this.direction=void 0,"drawing"===this.state&&this.setStarted(),this.onFinish(e,{mode:this.mode,action:l})}},i.getSectorCoordinates=function(t){var e=this.readFeature.getCoordinates(this.currentId),i=e[0],n=e[1],r=[t.lng,t.lat],o=B(i[0],i[1]),s=B(n[0],n[1]),a=B(r[0],r[1]);if(void 0===this.direction){var d=ti(o,s,a);this.direction=d?"clockwise":"anticlockwise"}var u,l=dt(o,s),h=It(o,s),c=It(o,a),p=this.arcPoints,g=[i],f=Ft(h),v=Ft(c);"anticlockwise"===this.direction?(u=v-f)<0&&(u+=360):(u=f-v)<0&&(u+=360);var y=("anticlockwise"===this.direction?1:-1)*u/p;g.push(n);for(var m=0;m<=p;m++){var P=Pt(o,l,f+m*y),C=A(P.x,P.y),I=C.lat,F=[k(C.lng,this.coordinatePrecision),k(I,this.coordinatePrecision)];F[0]!==g[g.length-1][0]&&F[1]!==g[g.length-1][1]&&g.push(F)}return g.push(i),g},i.start=function(){this.setStarted(),this.setCursor(this.cursors.start)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onMouseMove=function(t){if(this.mouseMove=!0,this.setCursor(this.cursors.start),void 0!==this.currentId&&0!==this.currentCoordinate){var e;if(1===this.currentCoordinate){var i=this.mutateFeature.epsilonOffset();e=[{type:et,index:1,coordinate:[t.lng,t.lat]},{type:et,index:2,coordinate:[t.lng,t.lat-i]}]}else{if(2!==this.currentCoordinate)return;var n=this.getSectorCoordinates(t);if(!n)return;e={type:nt,coordinates:[n]}}this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:e,context:{updateType:u.Provisional}})}},i.onClick=function(t){if("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t))if(this.currentCoordinate>0&&!this.mouseMove&&this.onMouseMove(t),this.mouseMove=!1,0===this.currentCoordinate){var e,i=this.mutateFeature.createPolygon({coordinates:[[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat]],properties:(e={mode:this.mode},e[v.CURRENTLY_DRAWING]=!0,e)});this.currentId=null==i?void 0:i.id,this.currentCoordinate++,this.setDrawing()}else if(1===this.currentCoordinate&&this.currentId){if(this.readFeature.coordinateAtIndexIsIdentical({featureId:this.currentId,index:0,newCoordinate:[t.lng,t.lat]}))return;if(!this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:[{type:et,index:1,coordinate:[t.lng,t.lat]},{type:et,index:2,coordinate:[t.lng,t.lat]}],context:{updateType:u.Provisional}}))return;this.currentCoordinate++}else 2===this.currentCoordinate&&this.currentId&&this.close()},i.onKeyUp=function(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()},i.onKeyDown=function(){},i.onDragStart=function(){},i.onDrag=function(){},i.onDragEnd=function(){},i.cleanUp=function(){var t=this.currentId;this.currentId=void 0,this.direction=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted(),this.mutateFeature.deleteFeatureIfPresent(t)},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return t.properties.mode===this.mode&&"Polygon"===t.geometry.type&&(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=y),e},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return Z(t,e.coordinatePrecision)})},i.afterFeatureUpdated=function(t){this.currentId===t.id&&(this.currentId=void 0,this.direction=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted())},i.registerBehaviors=function(t){this.readFeature=new lt(t),this.mutateFeature=new rt(t,{validate:this.validate})},e}(S),ri={cancel:"Escape",finish:"Enter"},oi={start:"crosshair",close:"pointer"},si=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="sensor",i.currentCoordinate=0,i.currentId=void 0,i.currentInitialArcId=void 0,i.currentStartingPointId=void 0,i.keyEvents=ri,i.direction=void 0,i.arcPoints=64,i.cursors=oi,i.mouseMove=!1,i.readFeature=void 0,i.mutateFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors)),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents)),null!=e&&e.arcPoints&&(this.arcPoints=e.arcPoints)},i.start=function(){this.setStarted(),this.setCursor(this.cursors.start)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onMouseMove=function(t){if(this.mouseMove=!0,this.setCursor(this.cursors.start),void 0!==this.currentInitialArcId&&void 0!==this.currentStartingPointId&&0!==this.currentCoordinate)if(2===this.currentCoordinate){var e=this.getUpdatedLineStringCoordinates(t);if(!e)return;this.mutateFeature.updateLineString({featureId:this.currentInitialArcId,coordinateMutations:{type:nt,coordinates:e},context:{updateType:u.Provisional}})}else if(3===this.currentCoordinate){var i=this.getUpdatedPolygonCoordinates(t);if(!i)return;if(this.currentId)this.mutateFeature.updatePolygon({featureId:this.currentId,coordinateMutations:{type:nt,coordinates:[i]},context:{updateType:u.Provisional}});else{var n,r=this.mutateFeature.createPolygon({coordinates:i,properties:(n={mode:this.mode},n[v.CURRENTLY_DRAWING]=!0,n)});if(!r)return;this.currentId=r.id}}},i.onClick=function(t){if("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t))if(this.currentCoordinate>0&&!this.mouseMove&&this.onMouseMove(t),this.mouseMove=!1,0===this.currentCoordinate){var e=this.mutateFeature.createPoint({coordinates:[t.lng,t.lat],properties:{mode:this.mode}});if(!e)return;this.currentStartingPointId=e.id,this.currentCoordinate++,this.setDrawing()}else if(1===this.currentCoordinate&&this.currentStartingPointId){var i=this.mutateFeature.createLineString({coordinates:[[t.lng,t.lat],[t.lng,t.lat]],properties:{mode:this.mode}});if(!i)return;this.currentInitialArcId=i.id,this.currentCoordinate++}else 2===this.currentCoordinate&&this.currentStartingPointId?this.currentCoordinate++:3===this.currentCoordinate&&this.currentStartingPointId&&this.close()},i.onKeyUp=function(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()},i.onKeyDown=function(){},i.onDragStart=function(){},i.onDrag=function(){},i.onDragEnd=function(){},i.cleanUp=function(){this.mutateFeature.deleteFeatureIfPresent(this.currentStartingPointId),this.mutateFeature.deleteFeatureIfPresent(this.currentInitialArcId),this.mutateFeature.deleteFeatureIfPresent(this.currentId),this.currentStartingPointId=void 0,this.direction=void 0,this.currentId=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted()},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return t.properties.mode===this.mode&&("Polygon"===t.geometry.type?(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=y):"LineString"===t.geometry.type?(e.lineStringColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.lineStringWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.zIndex=y):"Point"===t.geometry.type&&(e.pointColor=this.getHexColorStylingValue(this.styles.centerPointColor,e.pointColor,t),e.pointWidth=this.getNumericStylingValue(this.styles.centerPointWidth,e.pointWidth,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.centerPointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.centerPointOutlineWidth,e.pointOutlineWidth,t),e.zIndex=20)),e},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return Z(t,e.coordinatePrecision)})},i.afterFeatureUpdated=function(t){this.currentId===t.id&&(this.mutateFeature.deleteFeatureIfPresent(this.currentStartingPointId),this.mutateFeature.deleteFeatureIfPresent(this.currentInitialArcId),this.currentStartingPointId=void 0,this.direction=void 0,this.currentId=void 0,this.currentCoordinate=0,"drawing"===this.state&&this.setStarted())},i.registerBehaviors=function(t){this.readFeature=new lt(t),this.mutateFeature=new rt(t,{validate:this.validate})},i.close=function(){if(void 0!==this.currentStartingPointId){var t,e=this.currentStartingPointId,i=this.currentInitialArcId;if(this.currentId&&!this.mutateFeature.updatePolygon({featureId:this.currentId,propertyMutations:(t={},t[v.CURRENTLY_DRAWING]=void 0,t),coordinateMutations:{coordinates:this.readFeature.getGeometry(this.currentId).coordinates,type:nt},context:{updateType:u.Finish,action:l}}))return;var n=this.currentId;this.mutateFeature.deleteFeatureIfPresent(e),this.mutateFeature.deleteFeatureIfPresent(i),this.currentCoordinate=0,this.currentStartingPointId=void 0,this.currentInitialArcId=void 0,this.currentId=void 0,this.direction=void 0,"drawing"===this.state&&this.setStarted(),n&&this.onFinish(n,{mode:this.mode,action:l})}},i.getUpdatedPolygonCoordinates=function(t){if(!(void 0===this.currentInitialArcId||void 0===this.currentStartingPointId||this.currentCoordinate<3)){var e=this.readFeature.getCoordinates(this.currentInitialArcId);if(!(e.length<2)&&this.direction){var i=this.readFeature.getGeometry(this.currentStartingPointId).coordinates,n=e[0],r=e[e.length-1],o=B(t.lng,t.lat),s=B(n[0],n[1]),a=B(r[0],r[1]),d=B(i[0],i[1]),u=dt(d,s),l=dt(d,o)<u?s:o,h=It(d,o),c=It(d,s),p=It(d,a),g=Ft(c),f=Ft(p),v=Ft(h);if(!this.notInSector({normalizedCursor:v,normalizedStart:g,normalizedEnd:f,direction:this.direction})){for(var y=this.getDeltaBearing(this.direction,g,f),m=this.arcPoints,P=("anticlockwise"===this.direction?1:-1)*y/m,C=dt(d,l),I=[],F=0;F<=m;F++){var x=Pt(d,C,g+F*P),M=A(x.x,x.y),S=M.lat,E=[k(M.lng,this.coordinatePrecision),k(S,this.coordinatePrecision)];E[0]!==e[e.length-1][0]&&E[1]!==e[e.length-1][1]&&I.unshift(E)}return e.push.apply(e,I),e.push(e[0]),e}}}},i.getUpdatedLineStringCoordinates=function(t){if(!(void 0===this.currentInitialArcId||void 0===this.currentStartingPointId||this.currentCoordinate<2)){var e=this.readFeature.getGeometry(this.currentInitialArcId).coordinates,i=this.readFeature.getGeometry(this.currentStartingPointId).coordinates,n=e[0],r=[t.lng,t.lat],o=B(n[0],n[1]),s=B(r[0],r[1]),a=B(i[0],i[1]),d=dt(a,o);if(void 0===this.direction){var u=ti(a,o,s);this.direction=u?"clockwise":"anticlockwise"}var l,h=It(a,o),c=It(a,s),p=this.arcPoints,g=[n],f=Ft(h),v=Ft(c);"anticlockwise"===this.direction?(l=v-f)<0&&(l+=360):(l=f-v)<0&&(l+=360);for(var y=("anticlockwise"===this.direction?1:-1)*l/p,m=0;m<=p;m++){var P=Pt(a,d,f+m*y),C=A(P.x,P.y),I=C.lat,F=[k(C.lng,this.coordinatePrecision),k(I,this.coordinatePrecision)];F[0]!==g[g.length-1][0]&&F[1]!==g[g.length-1][1]&&g.push(F)}return g}},i.getDeltaBearing=function(t,e,i){var n;return"anticlockwise"===t?(n=i-e)<0&&(n+=360):(n=e-i)<0&&(n+=360),n},i.notInSector=function(t){var e=t.normalizedCursor,i=t.normalizedStart,n=t.normalizedEnd;return"clockwise"===t.direction?i<=n?e>=i&&e<=n:e>=i||e<=n:i>=n?e<=i&&e>=n:e<=i||e>=n},e}(S),ai=function(t){var e=this,i=t.name,n=t.callback,r=t.unregister,o=t.register;this.name=void 0,this.callback=void 0,this.registered=!1,this.register=void 0,this.unregister=void 0,this.name=i,this.register=function(){e.registered||(e.registered=!0,o(n))},this.unregister=function(){e.register&&(e.registered=!1,r(n))},this.callback=n},di={__proto__:null,GeoJSONStore:je,TerraDrawBaseDrawMode:S,TerraDrawBaseSelectMode:E,TerraDrawBaseAdapter:/*#__PURE__*/function(){function t(t){this._nextKeyUpIsContextMenu=!1,this._lastPointerDownEventTarget=void 0,this._ignoreMismatchedPointerEvents=!1,this._minPixelDragDistance=void 0,this._minPixelDragDistanceDrawing=void 0,this._minPixelDragDistanceSelecting=void 0,this._lastDrawEvent=void 0,this._coordinatePrecision=void 0,this._heldKeys=new Set,this._listeners=[],this._dragState="not-dragging",this._currentModeCallbacks=void 0,this._ignoreMismatchedPointerEvents="boolean"==typeof t.ignoreMismatchedPointerEvents&&t.ignoreMismatchedPointerEvents,this._minPixelDragDistance="number"==typeof t.minPixelDragDistance?t.minPixelDragDistance:1,this._minPixelDragDistanceSelecting="number"==typeof t.minPixelDragDistanceSelecting?t.minPixelDragDistanceSelecting:1,this._minPixelDragDistanceDrawing="number"==typeof t.minPixelDragDistanceDrawing?t.minPixelDragDistanceDrawing:8,this._coordinatePrecision="number"==typeof t.coordinatePrecision?t.coordinatePrecision:9}var e=t.prototype;return e.getButton=function(t){return-1===t.button?"neither":0===t.button?"left":1===t.button?"middle":2===t.button?"right":"neither"},e.getMapElementXYPosition=function(t){var e=this.getMapEventElement(t.type).getBoundingClientRect();return{containerX:t.clientX-e.left,containerY:t.clientY-e.top}},e.getDrawEventFromEvent=function(t,e){void 0===e&&(e=!1);var i=this.getLngLatFromEvent(t);if(!i)return null;var n=i.lng,r=i.lat,o=this.getMapElementXYPosition(t),s=o.containerX,a=o.containerY,d=this.getButton(t),u=Array.from(this._heldKeys);return{lng:k(n,this._coordinatePrecision),lat:k(r,this._coordinatePrecision),containerX:s,containerY:a,button:d,heldKeys:u,isContextMenu:e}},e.register=function(t){this._currentModeCallbacks=t,this._listeners=this.getAdapterListeners(),this._listeners.forEach(function(t){t.register()})},e.getCoordinatePrecision=function(){return this._coordinatePrecision},e.getAdapterListeners=function(){var t=this;return[new ai({name:"pointerdown",callback:function(e){if(t._currentModeCallbacks&&e.isPrimary){var i=t.getDrawEventFromEvent(e);i&&(t._dragState="pre-dragging",t._lastDrawEvent=i,t._lastPointerDownEventTarget=e.target?e.target:void 0)}},register:function(e){t.getMapEventElement("pointerdown").addEventListener("pointerdown",e)},unregister:function(e){t.getMapEventElement("pointerdown").removeEventListener("pointerdown",e)}}),new ai({name:"pointermove",callback:function(e){if(t._currentModeCallbacks&&e.isPrimary){e.preventDefault();var i=t.getDrawEventFromEvent(e);if(i)if("not-dragging"===t._dragState)t._currentModeCallbacks.onMouseMove(i),t._lastDrawEvent=i;else if("pre-dragging"===t._dragState){if(!t._lastDrawEvent)return;var n={x:t._lastDrawEvent.containerX,y:t._lastDrawEvent.containerY},r={x:i.containerX,y:i.containerY},o=t._currentModeCallbacks.getState(),s=dt(n,r);if("drawing"===o?s<t._minPixelDragDistanceDrawing:"selecting"===o?s<t._minPixelDragDistanceSelecting:s<t._minPixelDragDistance)return;t._nextKeyUpIsContextMenu=!1,t._dragState="dragging",t._currentModeCallbacks.onDragStart(i,function(e){t.setDraggability.bind(t)(e)})}else"dragging"===t._dragState&&t._currentModeCallbacks.onDrag(i,function(e){t.setDraggability.bind(t)(e)})}},register:function(e){t.getMapEventElement("pointermove").addEventListener("pointermove",e)},unregister:function(e){t.getMapEventElement("pointermove").removeEventListener("pointermove",e)}}),new ai({name:"contextmenu",callback:function(e){t._currentModeCallbacks&&(e.preventDefault(),t._nextKeyUpIsContextMenu=!0)},register:function(e){t.getMapEventElement("contextmenu").addEventListener("contextmenu",e)},unregister:function(e){t.getMapEventElement("contextmenu").removeEventListener("contextmenu",e)}}),new ai({name:"pointerup",callback:function(e){if(t._currentModeCallbacks&&e.target===t.getMapEventElement("pointerup")&&(!t._ignoreMismatchedPointerEvents||t._lastPointerDownEventTarget===e.target)&&(t._lastPointerDownEventTarget=void 0,e.isPrimary)){var i=t.getDrawEventFromEvent(e);i&&("dragging"===t._dragState?t._currentModeCallbacks.onDragEnd(i,function(e){t.setDraggability.bind(t)(e)}):"not-dragging"!==t._dragState&&"pre-dragging"!==t._dragState||(t._nextKeyUpIsContextMenu&&(i.isContextMenu=!0,t._nextKeyUpIsContextMenu=!1),t._currentModeCallbacks.onClick(i)),t._dragState="not-dragging",t.setDraggability(!0))}},register:function(e){t.getMapEventElement("pointerup").addEventListener("pointerup",e)},unregister:function(e){t.getMapEventElement("pointerup").removeEventListener("pointerup",e)}}),new ai({name:"keyup",callback:function(e){t._currentModeCallbacks&&(t._heldKeys.delete(e.key),t._currentModeCallbacks.onKeyUp({key:e.key,heldKeys:Array.from(t._heldKeys),preventDefault:function(){return e.preventDefault()}}))},register:function(e){t.getMapEventElement("keyup").addEventListener("keyup",e)},unregister:function(e){t.getMapEventElement("keyup").removeEventListener("keyup",e)}}),new ai({name:"keydown",callback:function(e){t._currentModeCallbacks&&(t._heldKeys.add(e.key),t._currentModeCallbacks.onKeyDown({key:e.key,heldKeys:Array.from(t._heldKeys),preventDefault:function(){return e.preventDefault()}}))},register:function(e){t.getMapEventElement("keydown").addEventListener("keydown",e)},unregister:function(e){t.getMapEventElement("keydown").removeEventListener("keydown",e)}})]},e.unregister=function(){this._listeners.forEach(function(t){t.unregister()}),this.clear(),this._currentModeCallbacks=void 0,this._lastDrawEvent=void 0,this._lastPointerDownEventTarget=void 0,this._nextKeyUpIsContextMenu=!1},t}(),getDefaultStyling:function(){return{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0}},SELECT_PROPERTIES:f},ui={ValidationReasonFeatureNotPoint:Ut,ValidationReasonFeatureInvalidCoordinates:Gt,ValidationReasonFeatureInvalidCoordinatePrecision:jt,ValidationReasonFeatureNotPolygon:F,ValidationReasonFeatureHasHoles:z,ValidationReasonFeatureLessThanFourCoordinates:K,ValidationReasonFeatureHasInvalidCoordinates:H,ValidationReasonFeatureCoordinatesNotClosed:X,ValidationReasonFeatureNotPolygonOrLineString:Xe,ValidationReasonFeatureSelfIntersects:qe,ValidationReasonFeatureLessThanMinSize:He,ValidationReasonModeMismatch:x},li={cancel:"Escape",finish:"Enter"},hi={start:"crosshair",close:"pointer"},ci=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="freehand-linestring",i.canClose=!1,i.currentId=void 0,i.minDistance=20,i.keyEvents=li,i.cursors=hi,i.preventNewFeature=!1,i.mutateFeature=void 0,i.readFeature=void 0,i.pixelDistance=void 0,i.closingPoints=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.minDistance&&(this.minDistance=e.minDistance),null===(null==e?void 0:e.keyEvents)?this.keyEvents={cancel:null,finish:null}:null!=e&&e.keyEvents&&(this.keyEvents=o({},this.keyEvents,e.keyEvents)),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors))},i.close=function(){var t;if(void 0!==this.currentId&&this.mutateFeature.updateLineString({featureId:this.currentId,propertyMutations:(t={},t[v.CURRENTLY_DRAWING]=void 0,t),context:{updateType:u.Finish,action:l}})){var e=this.currentId;this.closingPoints.delete(),this.canClose=!1,this.currentId=void 0,"drawing"===this.state&&this.setStarted(),this.onFinish(e,{mode:this.mode,action:l})}},i.start=function(){this.setStarted(),this.setCursor(this.cursors.start)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onMouseMove=function(t){if(void 0!==this.currentId&&!1!==this.canClose){var e=this.readFeature.getCoordinate(this.currentId,-2),i=this.project(e[0],e[1]),n=dt({x:i.x,y:i.y},{x:t.containerX,y:t.containerY}),r=this.readFeature.getCoordinate(this.currentId,-1),o=this.project(r[0],r[1]),s=dt({x:o.x,y:o.y},{x:t.containerX,y:t.containerY});if(this.setCursor(s<this.pointerDistance?this.cursors.close:this.cursors.start),!(n<this.minDistance)){var a=this.mutateFeature.updateLineString({featureId:this.currentId,coordinateMutations:[{type:tt,index:-1,coordinate:[t.lng,t.lat]}],context:{updateType:u.Provisional}});a&&this.closingPoints.update(a.geometry.coordinates)}}else this.setCursor(this.cursors.start)},i.onClick=function(t){if("right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)){if(this.preventNewFeature)return;if(!1===this.canClose){var e,i=this.mutateFeature.createLineString({coordinates:[[t.lng,t.lat],[t.lng,t.lat]],properties:(e={mode:this.mode},e[v.CURRENTLY_DRAWING]=!0,e)}),n=i.id;return this.closingPoints.create(i.geometry.coordinates),this.currentId=n,this.canClose=!0,void("drawing"!==this.state&&this.setDrawing())}this.close()}},i.onKeyDown=function(){},i.onKeyUp=function(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&!0===this.canClose&&this.close()},i.onDragStart=function(){},i.onDrag=function(){},i.onDragEnd=function(){},i.cleanUp=function(){var t=this.currentId;this.currentId=void 0,this.canClose=!1,"drawing"===this.state&&this.setStarted(),this.mutateFeature.deleteFeatureIfPresent(t),this.closingPoints.delete()},i.styleFeature=function(t){var e=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return"Feature"===t.type&&"LineString"===t.geometry.type&&t.properties.mode===this.mode?(e.lineStringColor=this.getHexColorStylingValue(this.styles.lineStringColor,e.lineStringColor,t),e.lineStringWidth=this.getNumericStylingValue(this.styles.lineStringWidth,e.lineStringWidth,t),e.zIndex=y,e):"Feature"===t.type&&"Point"===t.geometry.type&&t.properties.mode===this.mode?(e.pointWidth=this.getNumericStylingValue(this.styles.closingPointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(this.styles.closingPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.closingPointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.closingPointOutlineWidth,2,t),e.zIndex=50,e):e},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return wt(t,e.coordinatePrecision)})},i.afterFeatureUpdated=function(t){this.currentId===t.id&&(this.closingPoints.delete(),this.canClose=!1,this.currentId=void 0)},i.registerBehaviors=function(t){this.readFeature=new lt(t),this.mutateFeature=new rt(t,{validate:this.validate}),this.pixelDistance=new vt(t),this.closingPoints=new Bt(t,this.pixelDistance,this.mutateFeature,this.readFeature)},e}(S);function pi(t){if(null===t)return!0;if("boolean"==typeof t)return!0;if("string"==typeof t)return!0;if(void 0===t)return!1;if("number"==typeof t)return Number.isFinite(t);if("bigint"==typeof t)return!1;if("symbol"==typeof t)return!1;if("function"==typeof t)return!1;if(t instanceof RegExp)return!1;if(t instanceof Map)return!1;if(t instanceof Set)return!1;if(t instanceof Date)return!1;if("object"==typeof t&&null!==t&&!Array.isArray(t)){var e=Object.getPrototypeOf(t);if(e!==Object.prototype&&null!==e)return!1}if(ArrayBuffer.isView(t)&&!(t instanceof DataView))return!1;if(Array.isArray(t))for(var i,n=r(t);!(i=n()).done;)if(!pi(i.value))return!1;return"object"==typeof t&&Object.keys(t).every(function(e){return"string"==typeof e&&pi(t[e])})}var gi={create:"crosshair",dragStart:"grabbing",dragEnd:"crosshair"},fi=/*#__PURE__*/function(t){function e(e){var i;return(i=t.call(this,e,!0)||this).mode="marker",i.cursors=gi,i.editable=!1,i.editedFeatureId=void 0,i.pixelDistance=void 0,i.clickBoundingBox=void 0,i.pointSearch=void 0,i.mutateFeature=void 0,i.updateOptions(e),i}s(e,t);var i=e.prototype;return i.updateOptions=function(e){t.prototype.updateOptions.call(this,e),null!=e&&e.cursors&&(this.cursors=o({},this.cursors,e.cursors)),null!=e&&e.editable&&(this.editable=e.editable)},i.start=function(){this.setStarted(),this.setCursor(this.cursors.create)},i.stop=function(){this.cleanUp(),this.setStopped(),this.setCursor("unset")},i.onClick=function(t){"right"===t.button&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)?this.onRightClick(t):"left"===t.button&&this.allowPointerEvent(this.pointerEvents.leftClick,t)&&this.onLeftClick(t)},i.onMouseMove=function(){},i.onKeyDown=function(){},i.onKeyUp=function(){},i.cleanUp=function(){this.editedFeatureId=void 0},i.onDragStart=function(t,e){if(this.allowPointerEvent(this.pointerEvents.onDragStart,t)){if(this.editable){var i=this.pointSearch.getNearestPointFeature(t);this.editedFeatureId=null==i?void 0:i.id}this.editedFeatureId&&(this.setCursor(this.cursors.dragStart),e(!1))}},i.onDrag=function(t,e){var i;this.allowPointerEvent(this.pointerEvents.onDrag,t)&&void 0!==this.editedFeatureId&&this.mutateFeature.updatePoint({featureId:this.editedFeatureId,coordinateMutations:{type:nt,coordinates:[t.lng,t.lat]},propertyMutations:(i={},i[v.EDITED]=!0,i),context:{updateType:u.Provisional}})},i.onDragEnd=function(t,e){var i;if(this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&void 0!==this.editedFeatureId&&this.mutateFeature.updatePoint({featureId:this.editedFeatureId,propertyMutations:(i={mode:this.mode},i[v.EDITED]=!1,i),context:{updateType:u.Finish,action:"edit"}})){var n=this.editedFeatureId;this.setCursor(this.cursors.dragEnd),this.editedFeatureId=void 0,e(!0),this.onFinish(n,{mode:this.mode,action:l})}},i.registerBehaviors=function(t){this.pixelDistance=new vt(t),this.clickBoundingBox=new ft(t),this.pointSearch=new Yt(t,this.pixelDistance,this.clickBoundingBox),this.mutateFeature=new rt(t,{validate:this.validate})},i.styleFeature=function(t){var e,i,n,r=o({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return"Feature"===t.type&&"Point"===t.geometry.type&&t.properties.mode===this.mode&&(r.zIndex=30,r.markerHeight=this.getNumericStylingValue(null==(e=this.styles)?void 0:e.markerHeight,40,t),r.markerWidth=this.getNumericStylingValue(null==(i=this.styles)?void 0:i.markerWidth,32,t),r.markerUrl=this.getUrlStylingValue(null==(n=this.styles)?void 0:n.markerUrl,g,t)),r},i.validateFeature=function(t){var e=this;return this.validateModeFeature(t,function(t){return Vt(t,e.coordinatePrecision)})},i.onLeftClick=function(t){var e,i=this.mutateFeature.createPoint({coordinates:[t.lng,t.lat],properties:(e={mode:this.mode},e[v.MARKER]=!0,e),context:{updateType:u.Finish,action:l}});i&&this.onFinish(i.id,{mode:this.mode,action:l})},i.onRightClick=function(t){if(this.editable){var e=this.pointSearch.getNearestPointFeature(t);e&&this.mutateFeature.deleteFeatureIfPresent(e.id)}},i.afterFeatureUpdated=function(t){this.editedFeatureId===t.id&&(this.editedFeatureId=void 0,this.setCursor(this.cursors.create))},e}(S);t.TerraDraw=/*#__PURE__*/function(){function t(t){var e=this;this._modes=void 0,this._mode=void 0,this._adapter=void 0,this._enabled=!1,this._store=void 0,this._eventListeners=void 0,this._instanceSelectMode=void 0,this._adapter=t.adapter,this._mode=new xe;var i=new Set,n=t.modes.reduce(function(t,e){if(i.has(e.mode))throw new Error("There is already a "+e.mode+" mode provided");return i.add(e.mode),t[e.mode]=e,t},{}),r=Object.keys(n);if(0===r.length)throw new Error("No modes provided");r.forEach(function(t){if(n[t].type===I.Select){if(e._instanceSelectMode)throw new Error("only one type of select mode can be provided");e._instanceSelectMode=t}}),this._modes=o({},n,{static:this._mode}),this._eventListeners={change:[],select:[],deselect:[],finish:[],ready:[]},this._store=new je({tracked:!!t.tracked,idStrategy:t.idStrategy?t.idStrategy:void 0});var s=function(t){var i=[],n=e._store.copyAll().filter(function(e){return!t.includes(e.id)||(i.push(e),!1)});return{changed:i,unchanged:n}},a=function(t,i){e._enabled&&e._eventListeners.finish.forEach(function(e){e(t,i)})},d=function(t,i,n){if(e._enabled){e._eventListeners.change.forEach(function(e){e(t,i,n)});var r=s(t),o=r.changed,a=r.unchanged;"create"===i?e._adapter.render({created:o,deletedIds:[],unchanged:a,updated:[]},e.getModeStyles()):"update"===i?e._adapter.render({created:[],deletedIds:[],unchanged:a,updated:o},e.getModeStyles()):"delete"===i?e._adapter.render({created:[],deletedIds:t,unchanged:a,updated:[]},e.getModeStyles()):"styling"===i&&e._adapter.render({created:[],deletedIds:[],unchanged:a,updated:[]},e.getModeStyles())}},u=function(t){if(e._enabled){e._eventListeners.select.forEach(function(e){e(t)});var i=s([t]);e._adapter.render({created:[],deletedIds:[],unchanged:i.unchanged,updated:i.changed},e.getModeStyles())}},l=function(t){if(e._enabled){e._eventListeners.deselect.forEach(function(t){t()});var i=s([t]),n=i.changed;n&&e._adapter.render({created:[],deletedIds:[],unchanged:i.unchanged,updated:n},e.getModeStyles())}};Object.keys(this._modes).forEach(function(t){e._modes[t].register({mode:t,store:e._store,setCursor:e._adapter.setCursor.bind(e._adapter),project:e._adapter.project.bind(e._adapter),unproject:e._adapter.unproject.bind(e._adapter),setDoubleClickToZoom:e._adapter.setDoubleClickToZoom.bind(e._adapter),onChange:d,onSelect:u,onDeselect:l,onFinish:a,coordinatePrecision:e._adapter.getCoordinatePrecision()})})}var e=t.prototype;return e.checkEnabled=function(){if(!this._enabled)throw new Error("Terra Draw is not enabled")},e.getModeStyles=function(){var t=this,e={};return Object.keys(this._modes).forEach(function(i){e[i]=function(e){return t._instanceSelectMode&&e.properties[f.SELECTED]?t._modes[t._instanceSelectMode].styleFeature.bind(t._modes[t._instanceSelectMode])(e):t._modes[i].styleFeature.bind(t._modes[i])(e)}}),e},e.featuresAtLocation=function(t,e){var i=t.lng,n=t.lat,o=e&&void 0!==e.pointerDistance?e.pointerDistance:30,s=!e||void 0===e.ignoreSelectFeatures||e.ignoreSelectFeatures,a=!(!e||void 0===e.ignoreCoordinatePoints)&&e.ignoreCoordinatePoints,d=!(!e||void 0===e.ignoreCurrentlyDrawing)&&e.ignoreCurrentlyDrawing,u=!(!e||void 0===e.ignoreClosingPoints)&&e.ignoreClosingPoints,l=!(!e||void 0===e.ignoreSnappingPoints)&&e.ignoreSnappingPoints,h=this._adapter.unproject.bind(this._adapter),c=this._adapter.project.bind(this._adapter),p=c(i,n),g=gt({unproject:h,point:p,pointerDistance:o});return this._store.search(g).filter(function(t){if(s&&(t.properties[f.MID_POINT]||t.properties[f.SELECTION_POINT]))return!1;if(a&&t.properties[v.COORDINATE_POINT])return!1;if(u&&t.properties[v.CLOSING_POINT])return!1;if(d&&t.properties[v.CURRENTLY_DRAWING])return!1;if(l&&t.properties[v.SNAPPING_POINT])return!1;if("Point"===t.geometry.type){var h=t.geometry.coordinates,g=c(h[0],h[1]);return dt(p,g)<o}if("LineString"===t.geometry.type){for(var y=t.geometry.coordinates,m=0;m<y.length-1;m++){var P=y[m],C=y[m+1];if(ue(p,c(P[0],P[1]),c(C[0],C[1]))<o)return!0}return!1}if(de([i,n],t.geometry.coordinates))return!0;if(null!=e&&e.includePolygonsWithinPointerDistance)for(var I,F=r(t.geometry.coordinates);!(I=F()).done;)for(var x=I.value,M=0;M<x.length-1;M++){var S=x[M],E=x[M+1],w=c(S[0],S[1]),D=c(E[0],E[1]);if(ue(p,w,D)<o)return!0}return!1}).map(function(t){if(null==e||!e.addClosestCoordinateInfoToProperties)return t;var r;if("Polygon"===t.geometry.type)r=t.geometry.coordinates[0].slice(0,-1);else{if("LineString"!==t.geometry.type)return t;r=t.geometry.coordinates}for(var o,s=-1,a=Infinity,d=0;d<r.length;d++){var u=r[d],l=dt(c(u[0],u[1]),p);l<a&&(s=d,a=l,o=u)}return t.properties.closestCoordinateIndexToEvent=s,t.properties.closestCoordinatePixelDistanceToEvent=a,t.properties.closestCoordinateDistanceKmToEvent=w(o,[i,n]),t})},e.getSelectModeOrThrow=function(){var t=this.getSelectMode({switchToSelectMode:!0});if(!t)throw new Error("No select mode defined in instance");return t},e.getSelectMode=function(t){var e=t.switchToSelectMode;if(this.checkEnabled(),!this._instanceSelectMode)return null;var i=this.getMode();return e&&i!==this._instanceSelectMode&&this.setMode(this._instanceSelectMode),this._modes[this._instanceSelectMode]},e.isGuidanceFeature=function(t){return Boolean(t.properties[f.MID_POINT]||t.properties[f.SELECTION_POINT]||t.properties[v.COORDINATE_POINT]||t.properties[v.SNAPPING_POINT])},e.setModeStyles=function(t,e){if(this.checkEnabled(),!this._modes[t])throw new Error("No mode with this name present");this._modes[t].styles=e},e.updateModeOptions=function(t,e){if(this.checkEnabled(),!this._modes[t])throw new Error("No mode with this name present");this._modes[t].updateOptions(e)},e.getSnapshot=function(){return this._store.copyAll()},e.getSnapshotFeature=function(t){if(this._store.has(t))return this._store.copy(t)},e.clear=function(){this.checkEnabled(),this._adapter.clear()},e.getMode=function(){return this._mode.mode},e.getModeState=function(){return this._mode.state},e.setMode=function(t){if(this.checkEnabled(),!this._modes[t])throw new Error("No mode with this name present");this._mode.stop(),this._mode=this._modes[t],this._mode.start()},e.removeFeatures=function(t){var e=this;this.checkEnabled();var i=[],n=[],r=void 0;t.forEach(function(t){if(!e._store.has(t))throw new Error("No feature with id "+t+", can not delete");var o=e._store.getPropertiesCopy(t);o[f.SELECTED]&&e.deselectFeature(t),o[v.CURRENTLY_DRAWING]&&e._modes[o.mode]?r=o.mode:(o[v.COORDINATE_POINT_IDS]&&i.push.apply(i,o[v.COORDINATE_POINT_IDS]),n.push(t))}),this._store.delete([].concat(n,i),{origin:"api"}),r&&this._modes[r]&&this._modes[r].cleanUp()&&this._modes[r].cleanUp()},e.selectFeature=function(t){this.getSelectModeOrThrow().selectFeature(t)},e.deselectFeature=function(t){this.getSelectModeOrThrow().deselectFeature(t)},e.getFeatureId=function(){return this._store.getId()},e.hasFeature=function(t){return this._store.has(t)},e.checkIsReservedProperty=function(t){return![].concat(Object.values(f),Object.values(v)).includes(t)},e.updateFeatureProperties=function(t,e){var i=this;if(!this._store.has(t))throw new Error("No feature with id "+t+" present in store");var n=this._store.copy(t);if(this.isGuidanceFeature(n))throw new Error("Guidance features are not allowed to be updated directly.");var r=n.properties.mode;if(!this._modes[r])throw new Error("No mode with name "+r+" present in instance");var o=Object.entries(e);o.forEach(function(t){var e=t[0],n=t[1];if(!i.checkIsReservedProperty(e))throw new Error("You are trying to update a reserved property name: "+e+". Please choose another name.");if(void 0!==n&&!pi(n))throw new Error("Invalid JSON value provided for property "+e)}),this._store.updateProperty(o.map(function(t){return{id:n.id,property:t[0],value:t[1]}}),{origin:"api"})},e.updateFeatureGeometry=function(t,e){if(!this._store.has(t))throw new Error("No feature with id "+t+" present in store");var i=this._store.copy(t);if(this.isGuidanceFeature(i))throw new Error("Guidance features are not allowed to be updated directly.");if(!(i&&e&&e.type&&e.coordinates))throw new Error("Invalid geometry provided");if(e.type!==i.geometry.type)throw new Error("Geometry type mismatch: expected "+i.geometry.type+", got "+e.type);var n=i.properties.mode,r=this._modes[n];if(!r)throw new Error("No mode with name "+n+" present in instance");var s=o({},i,{geometry:e}),a=r.validateFeature(s);if(!a.valid)throw new Error("Feature validation failed: "+(a.reason||"Unknown reason"));if(this._store.updateGeometry([{id:i.id,geometry:e}],{origin:"api"}),r.afterFeatureUpdated){r.afterFeatureUpdated(s);var d=s.properties[f.SELECTED],u=this.getSelectMode({switchToSelectMode:!1});u&&d&&u.afterFeatureUpdated(s)}},e.transformFeatureGeometry=function(t,e){var i=this;if(!this._store.has(t))throw new Error("No feature with id "+t+" present in store");var n=this._store.copy(t);if(this.isGuidanceFeature(n))throw new Error("Guidance features are not allowed to be updated directly.");var r,o=n.properties.mode,s=this._modes[o];if(!s)throw new Error("No mode with name "+o+" present in instance");if("Polygon"===n.geometry.type)r=n.geometry.coordinates[0];else{if("LineString"!==n.geometry.type)throw new Error("Feature geometry type "+n.geometry.type+" is not supported for transformation");r=n.geometry.coordinates}if("web-mercator"!=e.projection)throw new Error("Projection "+e.projection+" is not currently supported for transformation");if("scale"===e.type){var a=B(e.origin[0],e.origin[1]);me({coordinates:r,originX:a.x,originY:a.y,xScale:e.options.xScale||1,yScale:e.options.yScale||1})}else"rotate"===e.type&&(r="Polygon"===(n=ge(n,e.options.angle||0)).geometry.type?n.geometry.coordinates[0]:n.geometry.coordinates);if(r=r.map(function(t){return[k(t[0],i._adapter.getCoordinatePrecision()),k(t[1],i._adapter.getCoordinatePrecision())]}),n.geometry.coordinates="Polygon"===n.geometry.type?[r]:r,this._store.updateGeometry([{id:n.id,geometry:n.geometry}],{origin:"api"}),s.afterFeatureUpdated){s.afterFeatureUpdated(n);var d=n.properties[f.SELECTED],u=this.getSelectMode({switchToSelectMode:!1});u&&d&&u.afterFeatureUpdated(n)}},e.addFeatures=function(t){var e=this;return this.checkEnabled(),0===t.length?[]:this._store.load(t,function(t){if(P(t)){var i=t.properties.mode,n=e._modes[i];if(!n)return{id:t.id,valid:!1,reason:i+" mode is not in the list of instantiated modes"};var r=n.validateFeature.bind(n)(t);return{id:t.id,valid:r.valid,reason:r.reason?r.reason:r.valid?void 0:"Feature is invalid"}}return{id:t.id,valid:!1,reason:"Mode property does not exist"}},function(t){if(P(t)){var i=e._modes[t.properties.mode];i&&i.afterFeatureAdded&&i.afterFeatureAdded(t)}},{origin:"api"})},e.start=function(){var t=this;this._enabled||(this._enabled=!0,this._adapter.register({onReady:function(){t._eventListeners.ready.forEach(function(t){t()})},getState:function(){return t._mode.state},onClick:function(e){t._mode.onClick(e)},onMouseMove:function(e){t._mode.onMouseMove(e)},onKeyDown:function(e){t._mode.onKeyDown(e)},onKeyUp:function(e){t._mode.onKeyUp(e)},onDragStart:function(e,i){t._mode.onDragStart(e,i)},onDrag:function(e,i){t._mode.onDrag(e,i)},onDragEnd:function(e,i){t._mode.onDragEnd(e,i)},onClear:function(){t._mode.cleanUp(),t._store.clear()}}))},e.getFeaturesAtLngLat=function(t,e){return this.featuresAtLocation({lng:t.lng,lat:t.lat},e)},e.getFeaturesAtPointerEvent=function(t,e){var i=this._adapter.getLngLatFromEvent.bind(this._adapter)(t);return null===i?[]:this.featuresAtLocation(i,e)},e.stop=function(){this._enabled&&(this._enabled=!1,this._adapter.unregister())},e.on=function(t,e){var i=this._eventListeners[t];i.includes(e)||i.push(e)},e.off=function(t,e){var i=this._eventListeners[t];i.includes(e)&&i.splice(i.indexOf(e),1)},n(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){throw new Error("Enabled is read only")}}])}(),t.TerraDrawAngledRectangleMode=Qe,t.TerraDrawCircleMode=at,t.TerraDrawExtend=di,t.TerraDrawFreehandLineStringMode=ci,t.TerraDrawFreehandMode=pt,t.TerraDrawLineStringMode=Lt,t.TerraDrawMarkerMode=fi,t.TerraDrawPointMode=Kt,t.TerraDrawPolygonMode=Zt,t.TerraDrawRectangleMode=Qt,t.TerraDrawRenderMode=te,t.TerraDrawSectorMode=ni,t.TerraDrawSelectMode=Fe,t.TerraDrawSensorMode=si,t.ValidateMaxAreaSquareMeters=function(t,e){return"Polygon"!==t.geometry.type?{valid:!1,reason:F}:Ve(t.geometry)>e?{valid:!1,reason:"Feature is larger than the maximum area"}:{valid:!0}},t.ValidateMinAreaSquareMeters=function(t,e){return"Polygon"!==t.geometry.type?{valid:!1,reason:F}:Ve(t.geometry)<e?{valid:!1,reason:He}:{valid:!0}},t.ValidateNotSelfIntersecting=function(t){return"Polygon"!==t.geometry.type&&"LineString"!==t.geometry.type?{valid:!1,reason:Xe}:U(t)?{valid:!1,reason:qe}:{valid:!0}},t.ValidationReasons=ui});
//# sourceMappingURL=terra-draw.umd.js.map
