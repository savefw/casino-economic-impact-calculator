@inject IJSRuntime JSRuntime
@inject HttpClient Http
@using SaveFW.Shared
@using SaveFW.Client.Components

<style>
    .leaflet-control-zoom-in {
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        border-bottom: 1px solid rgba(255,255,255,0.05) !important;
        background-color: rgba(2, 6, 23, 0.4) !important;
        color: white !important;
        backdrop-filter: blur(4px);
    }
    .leaflet-control-zoom-out {
        border-bottom-left-radius: 12px !important;
        border-bottom-right-radius: 12px !important;
        border-top-left-radius: 0 !important;
        border-top-right-radius: 0 !important;
        background-color: rgba(2, 6, 23, 0.4) !important;
        color: white !important;
        backdrop-filter: blur(4px);
    }
    .leaflet-control-zoom {
        border: 1px solid rgba(255,255,255,0.05) !important;
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    }
    .leaflet-control-zoom-in:hover, .leaflet-control-zoom-out:hover {
        background-color: rgba(2, 6, 23, 0.6) !important;
        color: white !important;
    }
    #impact-visualizer button,
    #impact-visualizer .cursor-pointer,
    #impact-visualizer [onclick] {
        user-select: none !important;
        -webkit-user-select: none !important;
    }
</style>

<div id="impact-visualizer" class="mb-12">
    <div class="bg-slate-800 border border-slate-700 rounded-3xl p-8 shadow-sm">
        <h3 class="text-xl font-bold text-slate-300 dark:text-white mb-2">
            <span class="material-symbols-outlined text-blue-500">map</span>
            Casino Impact Zone Visualizer
        </h3>
        <p class="text-slate-400 leading-relaxed mb-8">
            This interactive tool visualizes the geographic reach of gambling-related risks. You can drag the 
            casino marker to any Indiana location on the map to see how the
            proximity-based risk zones shift. Moving the pin automatically recalculates the population
            distribution across the three impact tiers (High, Elevated, and Baseline Risk) shown in the
            cards below, which in turn updates the Net Impact Analysis.
        </p>
        <p class="text-slate-400 dark:text-slate-400 leading-relaxed border-t border-slate-700 pt-4 mb-8">
            You may use the Assessed State and Assessed County dropdown menus to select a county, in which a map marker will be placed in the center of the selected county. 
            Alternatively, you may interact with the map by selecting the desired state and county, followed by moving the map marker.
        </p>

        <!-- Tiered Risk Controls -->
        <div class="mb-8 rounded-2xl p-6">
            <!-- Impacted County Display -->
            <div class="mb-6 pb-4 relative z-[150]">
                <!-- Methodology Button -->
                <button onclick="openMethodologyModal()"
                    class="w-full mb-6 bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-blue-500/20 border border-blue-400/30 flex items-center justify-between group transition-all transform active:scale-95">
                    <div class="flex items-center gap-3">
                        <div class="bg-white/20 p-2 rounded-lg">
                            <span class="material-symbols-outlined text-white">science</span>
                        </div>
                        <div class="text-left">
                            <div class="uppercase tracking-wide text-xs font-bold text-blue-100 mb-0.5">Science</div>
                            <div class="text-lg leading-none">View Methodology</div>
                        </div>
                    </div>
                    <span
                        class="material-symbols-outlined group-hover:translate-x-1 transition-transform">arrow_forward</span>
                </button>

                <label class="text-base font-bold text-slate-300 mb-2 block">Assessed State</label>
                <div class="mb-4">
                    <SortableDropdownMenu Id="input-state" Placeholder="Select a state" Icon="map"
                                          Items="@StateOptions" OnSelected="@OnStateSelected" />
                </div>

                <label class="text-base font-bold text-slate-300 mb-2 block">Assessed County</label>
                <div class="mb-4">
                    <SortableDropdownMenu Id="input-county" Placeholder="Select a county" Icon="location_on"
                                          Items="@CountyOptions" OnSelected="@OnCountySelected"
                                          SelectedValue="@SelectedCountyId" />
                </div>
            </div>

            <!-- Map Container -->
            <div class="relative w-full h-[600px] mb-6 rounded-2xl overflow-hidden group border border-slate-700 shadow-2xl">
                <!-- Three-Step Navigation Mechanism -->
                <div id="map-navigation-overlay" class="absolute top-4 left-1/2 -translate-x-1/2 z-[90] w-auto sm:w-full max-w-[200px] sm:max-w-xl px-1 sm:px-4">
                    <div class="bg-slate-950/40 backdrop-blur-sm p-2 rounded-2xl border border-white/5">
                        <div class="grid grid-cols-3 gap-3">
                            <!-- Step 1: Nationwide -->
                            <div class="flex flex-col gap-1.5 group cursor-pointer" onclick="window.ImpactMap && window.ImpactMap.navigateToStep(1)">
                                <div id="map-nav-bar-1"
                                    class="h-1.5 w-full bg-blue-500 rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(59,130,246,0.5)]">
                                </div>
                                <span id="map-nav-label-1"
                                    class="text-[9px] sm:text-[10px] font-bold text-blue-400 uppercase tracking-widest text-center transition-colors duration-300"><span class="sm:hidden">Ntl.</span><span class="hidden sm:inline">Nationwide</span></span>
                            </div>
                            <!-- Step 2: State -->
                            <div class="flex flex-col gap-1.5 group cursor-pointer" onclick="window.ImpactMap && window.ImpactMap.navigateToStep(2)">
                                <div id="map-nav-bar-2"
                                    class="h-1.5 w-full bg-slate-700 rounded-full transition-all duration-300"></div>
                                <span id="map-nav-label-2"
                                    class="text-[9px] sm:text-[10px] font-bold text-slate-600 uppercase tracking-widest text-center transition-colors duration-300"><span class="sm:hidden">St.</span><span class="hidden sm:inline">State</span></span>
                            </div>
                            <!-- Step 3: County -->
                            <div class="flex flex-col gap-1.5 group cursor-pointer" onclick="window.ImpactMap && window.ImpactMap.navigateToStep(3)">
                                <div id="map-nav-bar-3"
                                    class="h-1.5 w-full bg-slate-700 rounded-full transition-all duration-300"></div>
                                <span id="map-nav-label-3"
                                    class="text-[9px] sm:text-[10px] font-bold text-slate-600 uppercase tracking-widest text-center transition-colors duration-300">County</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map Zoom Hint Overlay -->
                <div id="map-zoom-hint"
                    class="absolute inset-0 z-[100] bg-black/50 flex items-center justify-center opacity-0 transition-opacity duration-300 pointer-events-none backdrop-blur-sm">
                    <div class="bg-black/80 text-white px-4 py-2 rounded-lg font-bold shadow-xl">
                        Use CTRL + Scroll to Zoom
                    </div>
                </div>

                <div id="impact-map" class="w-full h-full z-0 transition-all duration-500"></div>

                <!-- Map Overlay Panel (Layers) -->
                <div id="map-overlay-panel"
                    class="absolute top-4 right-4 z-[80] bg-white/95 dark:bg-slate-900/95 backdrop-blur-md p-4 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 w-64 transform transition-transform duration-300 translate-x-[120%]">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-slate-900 dark:text-white text-sm uppercase tracking-wide">Map
                            Layers</h4>
                        <button onclick="toggleMapOverlay()"
                            class="text-slate-500 hover:text-slate-700 dark:hover:text-white">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="layer-zones" checked onchange="toggleLayer('zones')"
                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span
                                class="text-sm text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white">Impact
                                Zones</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="layer-heatmap" onchange="toggleLayer('heatmap')"
                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span
                                class="text-sm text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white">Population
                                Heatmap</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="layer-blocks" onchange="toggleLayer('blocks')"
                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span
                                class="text-sm text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white">Block
                                Groups</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="layer-tracts" onchange="toggleLayer('tracts')"
                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span
                                class="text-sm text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white">Census
                                Tracts</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="layer-streets" onchange="toggleLayer('streets')"
                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span
                                class="text-sm text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white">Street
                                View</span>
                        </label>
                    </div>
                </div>

                <!-- Toggle Overlay Button -->
                <button id="map-layers-button" onclick="toggleMapOverlay()"
                    class="absolute bottom-28 right-[12px] z-[70] bg-slate-950/40 backdrop-blur-sm w-[30px] h-[30px] flex items-center justify-center rounded-lg shadow-lg border border-white/5 text-white hover:bg-slate-900/60 transition-colors">
                    <span class="material-symbols-outlined">layers</span>
                </button>
            </div>

            <!-- Problem Gambling Slider -->
            <div class="mb-12 mt-10">
                 <SliderInput Id="rate" Label="Baseline Gambling Prevalence Rate" Value="2.3"
                             MinValue="0" MaxValue="10" Step="0.1"
                             InputType="Percent" DecimalPlaces="1"
                             MajorTickInterval="2" MinorTickInterval="0.5"
                             Tooltip="The percentage of the adult population that develops problem gambling behaviors."
                             Markers='@(new List<SliderMarker> { 
                                 new() { Label="Diagnosed", Value=2.3, TooltipDescription="Hoosiers meeting clinical criteria for Gambling Disorder (2023)." },
                                 new() { Label="Problem", Value=3.0, TooltipDescription="Self-reported \"problems with gambling\" in state surveys." },
                                 new() { Label="At-Risk", Value=5.5, TooltipDescription="Broader Combined At-Risk & Problem Rate (National Average)." }
                             })' />
            </div>
            <!-- END SLIDER SECTION -->

            <!-- Impact Stats Grid -->
            <!-- ... (Keeping existing Stats Grid HTML as it relies on IDs populated by JS) ... -->
            <!-- I am keeping the stats grid from lines ~370-550 of original file. -->
            <!-- Since I am writing the WHOLE file, I must include it. -->
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-4">
                <div class="p-4 bg-blue-900/20 rounded-xl border border-blue-800 relative overflow-hidden group flex flex-col">
                    <div class="absolute top-0 right-0 bg-blue-500/40 backdrop-blur-sm text-white text-[10px] px-2 py-0.5 rounded-bl-lg font-bold">2.0x Risk</div>
                    <div class="flex-1">
                        <div class="text-xs font-bold text-blue-500 uppercase tracking-wider mb-2">0-10 Miles (High Risk)</div>
                        <div class="text-lg font-black text-white mb-1" id="val-t1">-</div>
                        <div class="text-[11px] text-white mb-2">Adult Population (18+) — State Total</div>
                        <div class="text-[10px] text-white leading-tight mb-2">
                            <div class="flex justify-between gap-2"><span>County</span><span class="font-mono text-white" id="val-t1-county">-</span></div>
                            <div class="flex justify-between gap-2"><span>Other Counties</span><span class="font-mono text-white" id="val-t1-other">-</span></div>
                        </div>
                    </div>
                    <div class="bg-black/20 rounded-lg p-2 border border-blue-900/30">
                        <div class="flex justify-between items-center text-[10px] mb-1"><span class="text-white">Rate (Post):</span><span class="font-mono font-bold text-white" id="rate-t1">-</span></div>
                        <div class="flex justify-between items-center border-t border-blue-800 pt-1"><span class="text-white font-bold uppercase text-[9px]">Total Estimated</span><span class="font-mono font-black text-white text-xs" id="victims-t1">-</span></div>
                        <div class="mt-1 text-[10px] text-white leading-tight mb-2">
                            <div class="flex justify-between gap-2"><span>County</span><span class="font-mono text-white" id="victims-t1-county">-</span></div>
                            <div class="flex justify-between gap-2"><span>Other Counties</span><span class="font-mono text-white" id="victims-t1-other">-</span></div>
                        </div>
                        <div class="flex justify-between items-center border-t border-blue-800 pt-1"><span class="text-white font-bold uppercase text-[9px]">Net New (Attr.)</span><span class="font-mono font-black text-white text-xs" id="net-new-t1">-</span></div>
                        <div class="mt-1 text-[10px] text-white leading-tight">
                            <div class="flex justify-between gap-2"><span>County</span><span class="font-mono text-white" id="net-new-t1-county">-</span></div>
                            <div class="flex justify-between gap-2"><span>Other Counties</span><span class="font-mono text-white" id="net-new-t1-other">-</span></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-red-900/20 rounded-xl border border-red-800 relative overflow-hidden group flex flex-col">
                    <div class="absolute top-0 right-0 bg-red-500/40 backdrop-blur-sm text-white text-[10px] px-2 py-0.5 rounded-bl-lg font-bold">1.5x Risk</div>
                    <div class="flex-1">
                        <div class="text-xs font-bold text-red-500 uppercase tracking-wider mb-2">10-20 Miles (Elevated)</div>
                        <div class="text-lg font-black text-white mb-1" id="val-t2">-</div>
                        <div class="text-[11px] text-white mb-2">Adult Population (18+) — State Total</div>
                        <div class="text-[10px] text-white leading-tight mb-2">
                            <div class="flex justify-between gap-2"><span>County</span><span class="font-mono text-white" id="val-t2-county">-</span></div>
                            <div class="flex justify-between gap-2"><span>Other Counties</span><span class="font-mono text-white" id="val-t2-other">-</span></div>
                        </div>
                    </div>
                    <div class="bg-black/20 rounded-lg p-2 border border-red-900/30">
                        <div class="flex justify-between items-center text-[10px] mb-1"><span class="text-white">Rate (Post):</span><span class="font-mono font-bold text-white" id="rate-t2">-</span></div>
                        <div class="flex justify-between items-center border-t border-red-800 pt-1"><span class="text-white font-bold uppercase text-[9px]">Total Estimated</span><span class="font-mono font-black text-white text-xs" id="victims-t2">-</span></div>
                        <div class="mt-1 text-[10px] text-white leading-tight mb-2">
                            <div class="flex justify-between gap-2"><span>County</span><span class="font-mono text-white" id="victims-t2-county">-</span></div>
                            <div class="flex justify-between gap-2"><span>Other Counties</span><span class="font-mono text-white" id="victims-t2-other">-</span></div>
                        </div>
                        <div class="flex justify-between items-center border-t border-red-800 pt-1"><span class="text-white font-bold uppercase text-[9px]">Net New (Attr.)</span><span class="font-mono font-black text-white text-xs" id="net-new-t2">-</span></div>
                        <div class="mt-1 text-[10px] text-white leading-tight">
                            <div class="flex justify-between gap-2"><span>County</span><span class="font-mono text-white" id="net-new-t2-county">-</span></div>
                            <div class="flex justify-between gap-2"><span>Other Counties</span><span class="font-mono text-white" id="net-new-t2-other">-</span></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-orange-900/20 rounded-xl border border-orange-800 relative overflow-hidden group flex flex-col">
                    <div class="absolute top-0 right-0 bg-orange-500/40 backdrop-blur-sm text-white text-[10px] px-2 py-0.5 rounded-bl-lg font-bold">1.0x Risk</div>
                    <div class="flex-1">
                        <div class="text-xs font-bold text-orange-500 uppercase tracking-wider mb-2">20-50 Miles (Baseline)</div>
                        <div class="text-lg font-black text-white mb-1" id="val-t3">-</div>
                        <div class="text-[11px] text-white mb-2" id="label-t3">Adult Population (18+) — State Total</div>
                        <div class="text-[10px] text-white leading-tight mb-2">
                            <div class="flex justify-between gap-2"><span>County</span><span class="font-mono text-white" id="val-t3-county">-</span></div>
                            <div class="flex justify-between gap-2"><span>Other Counties</span><span class="font-mono text-white" id="val-t3-other">-</span></div>
                        </div>
                    </div>
                    <div class="bg-black/20 rounded-lg p-2 border border-orange-800">
                        <div class="flex justify-between items-center text-[10px] mb-1"><span class="text-white">Rate (Post):</span><span class="font-mono font-bold text-white" id="rate-t3">-</span></div>
                        <div class="flex justify-between items-center border-t border-orange-600 pt-1"><span class="text-white font-bold uppercase text-[9px]">Total Estimated</span><span class="font-mono font-black text-white text-xs" id="victims-t3">-</span></div>
                        <div class="mt-1 text-[10px] text-white leading-tight mb-2">
                            <div class="flex justify-between gap-2"><span>County</span><span class="font-mono text-white" id="victims-t3-county">-</span></div>
                            <div class="flex justify-between gap-2"><span>Other Counties</span><span class="font-mono text-white" id="victims-t3-other">-</span></div>
                        </div>
                        <div class="flex justify-between items-center border-t border-orange-600 pt-1"><span class="text-white font-bold uppercase text-[9px]">Net New (Attr.)</span><span class="font-mono font-black text-white text-xs" id="net-new-t3">-</span></div>
                        <div class="mt-1 text-[10px] text-white leading-tight">
                            <div class="flex justify-between gap-2"><span>County</span><span class="font-mono text-white" id="net-new-t3-county">-</span></div>
                            <div class="flex justify-between gap-2"><span>Other Counties</span><span class="font-mono text-white" id="net-new-t3-other">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Impact Summary -->
            <div class="bg-slate-900/50 text-white rounded-xl p-4 shadow-lg border border-slate-600 flex flex-col gap-0">
                <!-- 1. County Population -->
                <div class="flex flex-col sm:flex-row items-center justify-between py-1">
                    <div class="flex items-center gap-3 mb-2 sm:mb-0">
                        <div class="p-2 bg-blue-500/20 rounded-full text-blue-400"><span class="material-symbols-outlined">location_city</span></div>
                        <div class="text-left"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest">Total County Population*</div><div class="text-sm text-slate-500">(All Ages)</div></div>
                    </div>
                    <div class="text-xl font-mono text-slate-200 text-right" id="disp-pop-impact-zones">-</div>
                </div>
                <!-- 1b. County Adult Population -->
                <div class="flex flex-col sm:flex-row items-center justify-between py-1 border-t border-slate-800/50 mt-1 pt-2">
                    <div class="flex items-center gap-3 mb-2 sm:mb-0">
                        <div class="p-2 bg-indigo-500/20 rounded-full text-indigo-400"><span class="material-symbols-outlined">person</span></div>
                        <div class="text-left"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest">Adult Population</div><div class="text-sm text-slate-500">(18+ Only)</div></div>
                    </div>
                    <div class="text-xl font-mono text-indigo-300 text-right" id="disp-pop-adults">-</div>
                </div>
                <div class="h-px bg-slate-700 my-3"></div>
                <!-- 2. Effective Rate -->
                <div class="flex flex-col sm:flex-row items-center justify-between py-1">
                    <div class="flex items-center gap-3 mb-2 sm:mb-0">
                        <div class="p-2 bg-orange-500/20 rounded-full text-orange-400"><span class="material-symbols-outlined">trending_up</span></div>
                        <div class="text-left"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest">Effective Rate</div><div class="text-sm text-slate-500">Adult Population (18+)</div></div>
                    </div>
                    <div class="text-xl font-mono text-orange-400 text-right" id="disp-rate-adult">-</div>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-between py-1 border-t border-slate-800/50 mt-1 pt-2">
                    <div class="flex items-center gap-3 mb-2 sm:mb-0">
                        <div class="p-2 bg-orange-500/10 rounded-full text-orange-400/70"><span class="material-symbols-outlined text-[20px]">trending_flat</span></div>
                        <div class="text-left"><div class="text-xs text-slate-500 uppercase font-bold tracking-widest">Effective Rate</div><div class="text-sm text-slate-600">Total Population (All Ages)</div></div>
                    </div>
                    <div class="text-xl font-mono text-orange-400/70 text-right" id="disp-rate-total">-</div>
                </div>
                <div class="h-px bg-slate-700 my-3"></div>
                <!-- 3. Total Problem Gamblers -->
                <div class="flex flex-col sm:flex-row items-center justify-between">
                    <div class="flex items-center gap-3 mb-2 sm:mb-0">
                        <div class="p-2 bg-red-500/20 rounded-full text-red-400"><span class="material-symbols-outlined">groups</span></div>
                        <div class="text-left"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest">Net New Problem Gamblers (Attributable)*</div><div class="text-sm text-slate-500">Within 50 miles (county residents)</div></div>
                    </div>
                    <div class="text-right"><div class="text-2xl font-black font-mono text-white leading-none mb-1" id="total-gamblers">-</div></div>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-between py-1 border-t border-slate-800/50 mt-1 pt-2">
                    <div class="flex items-center gap-3 mb-2 sm:mb-0">
                        <div class="p-2 bg-red-500/10 rounded-full text-red-400/80"><span class="material-symbols-outlined text-[20px]">person_add</span></div>
                        <div class="text-left"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest">Regional Net New Problem Gamblers (Attr.)*</div><div class="text-sm text-slate-500">Within 50 miles (outside county)</div></div>
                    </div>
                    <div class="text-xl font-mono text-red-300/90 text-right" id="disp-victims-regional-other">-</div>
                </div>
                <div class="h-px bg-slate-700 my-3"></div>
                <!-- Regional Summary -->
                <div class="flex flex-col sm:flex-row items-center justify-between py-1">
                    <div class="flex items-center gap-3 mb-2 sm:mb-0">
                        <div class="p-2 bg-slate-500/20 rounded-full text-slate-300"><span class="material-symbols-outlined">public</span></div>
                        <div class="text-left"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest">Regional Adults (Within 50 Miles)</div><div class="text-sm text-slate-500">Same-state spillover</div></div>
                    </div>
                    <div class="text-xl font-mono text-slate-200 text-right" id="disp-pop-regional-50">-</div>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-between py-1 border-t border-slate-800/50 mt-1 pt-2">
                    <div class="flex items-center gap-3 mb-2 sm:mb-0">
                        <div class="p-2 bg-red-500/10 rounded-full text-red-300"><span class="material-symbols-outlined">group_add</span></div>
                        <div class="text-left"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest">Regional Net New Problem Gamblers (Attr.)*</div><div class="text-sm text-slate-500">Within 50 miles (same state)</div></div>
                    </div>
                    <div class="text-xl font-mono text-red-200 text-right" id="disp-victims-regional-50">-</div>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-between py-1 border-t border-slate-800/50 mt-1 pt-2">
                    <div class="flex items-center gap-3 mb-2 sm:mb-0">
                        <div class="p-2 bg-blue-500/10 rounded-full text-blue-300"><span class="material-symbols-outlined">map</span></div>
                        <div class="text-left"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest">Impacted Counties*</div><div class="text-sm text-slate-500">Within 50 miles (same state)</div></div>
                    </div>
                    <div class="text-right"><div class="text-xl font-mono text-blue-200 leading-none" id="disp-regional-counties">-</div><div class="text-[11px] font-mono text-slate-500 mt-1" id="disp-regional-counties-20">-</div></div>
                </div>
            </div>
            <p class="mt-3 text-sm text-slate-400 italic leading-relaxed">* County population totals reflect the full assessed county. Impact zones are modeled within a 50‑mile radius (0–10, 10–20, 20–50) for the subject county and same‑state spillover; out‑of‑state impacts are excluded.</p>
        </div>
    </div>
</div>

@code {
    private List<DropdownItem> StateOptions = new();
    private List<DropdownItem> CountyOptions = new();
    private string? SelectedCountyId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("window.ImpactMap.init", "impact-map");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var data = await Http.GetFromJsonAsync<CensusFeatureCollection>("/api/census/states");
            if (data?.Features != null)
            {
                StateOptions = data.Features.Select(f => new DropdownItem
                {
                    Value = f.Properties.GeoId,
                    Text = f.Properties.Name,
                    Badge = f.Properties.PopTotal.ToString("N0"),
                    OrderValue = f.Properties.PopTotal
                }).OrderBy(i => i.Text).ToList();
            }
        }
        catch (Exception ex) { Console.WriteLine($"Error loading states: {ex}"); }
    }

    private async Task OnStateSelected(DropdownItem item)
    {
        // Load Counties
        try
        {
            // Reset UI for Step 2
            await JSRuntime.InvokeVoidAsync("window.ImpactMap.navigateToStep", 2);

            var data = await Http.GetFromJsonAsync<CensusFeatureCollection>($"/api/census/counties/{item.Value}");
            if (data?.Features != null)
            {
                CountyOptions = data.Features.Select(f => new DropdownItem
                {
                    Value = f.Properties.GeoId,
                    Text = f.Properties.Name,
                    Badge = f.Properties.PopTotal.ToString("N0"),
                    OrderValue = f.Properties.PopTotal
                }).OrderBy(i => i.Text).ToList();
            }
            else 
            {
                CountyOptions.Clear();
            }
            
            // Reset County Selection
            SelectedCountyId = "";
            
            // Trigger Map Update
            await JSRuntime.InvokeVoidAsync("window.ImpactMap.loadState", item.Value);
        }
        catch (Exception ex) { Console.WriteLine($"Error loading counties: {ex}"); }
    }

    private async Task OnCountySelected(DropdownItem item)
    {
        SelectedCountyId = item.Value;
        await JSRuntime.InvokeVoidAsync("window.ImpactMap.loadCounty", item.Value);
    }

    // JSON Models
    public class CensusFeatureCollection
    {
        [System.Text.Json.Serialization.JsonPropertyName("features")]
        public List<CensusFeature> Features { get; set; } = new();
    }
    public class CensusFeature
    {
        [System.Text.Json.Serialization.JsonPropertyName("properties")]
        public CensusProperties Properties { get; set; } = new();
    }
    public class CensusProperties
    {
        [System.Text.Json.Serialization.JsonPropertyName("GEOID")]
        public string? GEOID { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("geoid")]
        public string? geoid { get; set; } // Handle lowercase case if API varies

        [System.Text.Json.Serialization.JsonPropertyName("NAME")]
        public string? NAME { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("name")]
        public string? name { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("POP_TOTAL")]
        public long POP_TOTAL { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("pop_total")]
        public long pop_total { get; set; }

        public string GeoId => !string.IsNullOrEmpty(GEOID) ? GEOID : (geoid ?? "");
        public string Name => !string.IsNullOrEmpty(NAME) ? NAME : (name ?? "");
        public long PopTotal => POP_TOTAL > 0 ? POP_TOTAL : pop_total;
    }
}