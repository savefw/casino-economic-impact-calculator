@inject IJSRuntime JSRuntime
@using SaveFW.Client.Pages

<section class="bg-[#0f172a] py-24 relative overflow-hidden" id="economic-analysis">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="mb-12 text-center max-w-4xl mx-auto" id="economic-analysis-header">
            <span class="text-blue-500 font-bold tracking-wider uppercase text-sm mb-2 block">Economic Analysis</span>
            <h2 class="text-3xl font-black tracking-tight text-white sm:text-4xl">
                ECONOMIC <span class="text-blue-500">IMPACT</span> CALCULATOR
            </h2>
        </div>

        <Map />

        <div class="flex flex-col gap-12 mb-16">
            <div id="calculator-controls" class="bg-slate-800 border border-slate-700 rounded-3xl p-4 sm:p-8 w-full shadow-sm">
                <h3 class="text-xl font-bold text-slate-300 dark:text-white mb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">tune</span> Economic Inputs
                </h3>
                
                <span id="total-gamblers" class="hidden">0</span>
                <div class="space-y-5">
                    <!-- Simulator Button -->
                    <button onclick="window.openSimulatorModal()"
                        class="w-full bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-blue-500/20 border border-blue-400/30 flex items-center justify-between group transition-all transform active:scale-95 mt-10">
                        <div class="flex items-center gap-3">
                            <div class="bg-white/20 p-2 rounded-lg">
                                <span class="material-symbols-outlined text-white">science</span>
                            </div>
                            <div class="text-left">
                                <div class="uppercase tracking-wide text-xs font-bold text-blue-100 mb-0.5">Quick Start</div>
                                <div class="text-lg leading-none">Run Scenario Simulator</div>
                            </div>
                        </div>
                        <span class="material-symbols-outlined group-hover:translate-x-1 transition-transform">arrow_forward</span>
                    </button>

                    <!-- Manual Toggle -->
                    <div class="relative flex py-8 items-center justify-center mt-10">
                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                            <div class="w-full border-t border-slate-700"></div>
                        </div>
                        <div class="relative flex justify-center">
                            <button type="button" @onclick="ToggleManual" id="btn-manual-toggle"
                                class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-2 px-6 rounded-full border border-purple-400/30 flex items-center gap-2 transition-all text-xs uppercase tracking-wider group shadow-lg active:scale-95 z-10">
                                <span>Adjust Variables Manually</span>
                                <span class="material-symbols-outlined group-hover:translate-y-1 transition-transform text-lg">expand_more</span>
                            </button>
                        </div>
                    </div>

                    <!-- Manual Controls Area -->
                    <div id="manual-controls" class="rounded-2xl transition-all duration-500 overflow-hidden @(isManualOpen ? "max-h-[8000px] opacity-100" : "max-h-0 opacity-0")">
                        
                        <!-- County Selection -->
                         <div class="mb-10 relative z-30">
                            <label class="text-base font-bold text-white block mb-4">Select County Analysis</label>
                            <div class="relative group" id="county-custom-select">
                                <button type="button" id="county-trigger"
                                    class="w-full bg-slate-700 hover:bg-slate-600 border border-slate-600 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-between transition-all shadow-lg text-left">
                                    <span id="county-display">@SelectedCountyName (@InputPopulation.ToString("N0"))</span>
                                    <span class="material-symbols-outlined text-slate-400">expand_more</span>
                                </button>
                                
                                <div id="county-menu" class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-600 overflow-hidden hidden transition-all origin-top scale-95 opacity-0 z-50 max-h-96 flex flex-col">
                                    <div class="p-2 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 sticky top-0">
                                        <div class="relative">
                                            <span class="material-symbols-outlined absolute left-3 top-2.5 text-slate-400 text-[18px]">search</span>
                                            <input type="text" id="county-search" placeholder="Search counties..." 
                                                class="w-full bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg pl-9 pr-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none text-slate-900 dark:text-white"
                                                onclick="event.stopPropagation()">
                                        </div>
                                    </div>
                                    <div id="county-options" class="overflow-y-auto flex-1">
                                        @foreach (var c in Counties)
                                        {
                                            <div class="px-4 py-3 text-sm text-slate-700 dark:text-slate-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 cursor-pointer transition-colors flex items-center justify-between group"
                                                 @onclick="() => SelectCounty(c)">
                                                <span class="font-medium">@c.Name</span>
                                                <span class="text-xs text-white font-mono bg-[#0f172a] px-2 py-0.5 rounded transition-colors">@c.Pop.ToString("N0")</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Problem Gambling Rate -->
                        <div class="mb-10 border-b border-slate-700 pb-8">
                             <div class="flex justify-between mb-4">
                                <label class="text-base font-bold text-white">Baseline Problem Gambling Increase</label>
                                <span class="text-orange-500 font-mono font-bold" id="val-rate">@InputRate.ToString("F1")%</span>
                            </div>
                            <div class="flex flex-col gap-6">
                                <div class="relative w-full group flex items-center">
                                    <input type="range" min="0" max="10" step="0.1" @bind="InputRate" @bind:event="oninput" id="input-rate" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-orange-500 relative z-20">
                                </div>
                                <div class="flex justify-between px-2">
                                    @foreach(var preset in new[] { 2.3, 3.0, 5.5 })
                                    {
                                        <label class="cursor-pointer group flex items-center gap-2">
                                            <input type="radio" name="gambling-rate-preset" value="@preset" checked="@(Math.Abs(InputRate - preset) < 0.1)"
                                                @onchange="() => { InputRate = preset; StateHasChanged(); }"
                                                class="w-4 h-4 text-orange-500 bg-slate-700 border-slate-500 focus:ring-orange-500 focus:ring-2">
                                            <span class="text-xs text-slate-400 group-hover:text-white transition-colors">@preset%</span>
                                        </label>
                                    }
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-4 italic">
                                * Based on input rate, "Projected Victims" (Problem Gamblers) are calculated using the map's proximity model.
                            </p>
                        </div>

                        <!-- AGR Slider -->
                        <div class="border-b border-slate-700 pb-8">
                            <label class="text-base font-bold text-white block mb-4">AGR (Adjusted Gross Revenue)</label>
                            <div class="relative w-full group flex items-center mb-8">
                                <input type="range" min="0" max="1000" step="1" @bind="InputAGR" @bind:event="oninput" @oninput="OnAGRChange" id="input-agr" 
                                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500 relative z-20">
                                <span class="absolute right-0 -top-8 text-emerald-400 font-mono font-bold" id="val-agr">$@InputAGR.ToString("F0") MM</span>
                            </div>
                            
                            <!-- Tax Breakdown Container -->
                            <div id="tax-details-container" class="bg-slate-900/80 rounded-lg p-4 mt-6 text-xs font-sans text-slate-300 border border-slate-700">
                                @foreach(var item in TaxBreakdown)
                                {
                                    /* Styling Logic based on Type */
                                    string colorClass = "text-slate-400";
                                    if (item.Type == "total") colorClass = "text-emerald-400 font-bold border-t border-slate-600 pt-2 mt-2";
                                    if (item.Type == "eff-rate") colorClass = "text-emerald-600 dark:text-emerald-500 font-bold text-sm border-t border-slate-700/50 pt-1 mt-1";
                                    if (item.Type == "add") colorClass = "text-emerald-500/80 pl-2";
                                    if (item.Type == "header") colorClass = "text-white font-bold pb-1 border-b border-slate-700 mb-1";
                                    if (item.Type == "sub-header") colorClass = "text-slate-200 font-semibold mt-2";
                                    if (item.Type == "info") colorClass = "text-slate-500 italic pl-2";

                                    <div class="flex justify-between items-center @colorClass">
                                        <div class="flex flex-col">
                                            <span>@item.Label</span>
                                            @if(!string.IsNullOrEmpty(item.Note)) { <span class="text-[10px] opacity-70 font-mono">@item.Note</span> }
                                        </div>
                                        <span class="font-mono">@item.Value</span>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Tax Revenue Slider -->
                        <div class="mt-10">
                            <label class="text-base font-bold text-white block mb-4">Target Tax Revenue</label>
                            <div class="relative w-full group flex items-center">
                                <div class="absolute w-full h-full pointer-events-none z-10">
                                    <!-- Ticks manually placed for key values could go here -->
                                </div>
                                <input type="range" min="0" max="400" step="0.5" @bind="InputRevenue" @bind:event="oninput" @oninput="OnRevenueChange" id="input-revenue" 
                                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500 relative z-20">
                                <span class="absolute right-0 -top-8 text-emerald-500 font-mono font-bold" id="val-revenue">$@InputRevenue.ToString("F1") MM</span>
                            </div>
                        </div>

                        <!-- Allocation Slider -->
                        <div class="pt-6">
                            <label class="text-base font-bold text-white block mb-4">Tax Allocation (Humanitarian vs General)</label>
                            <div class="relative h-10 w-full rounded-xl overflow-hidden shadow-inner border border-slate-600">
                                <div id="alloc-bar-human" class="absolute h-full bg-purple-600 transition-all duration-300" style="width: @InputAllocation%"></div>
                                <div id="alloc-bar-taxpayer" class="absolute h-full bg-emerald-600 right-0 transition-all duration-300" style="width: @(100 - InputAllocation)%"></div>
                                <div class="absolute inset-0 flex justify-center items-center pointer-events-none gap-4 z-30">
                                    <div class="bg-slate-900/80 px-2 py-1 rounded text-xs font-mono text-white" id="alloc-text-human">@InputAllocation.ToString("F0")%</div>
                                    <div class="bg-slate-900/80 px-2 py-1 rounded text-xs font-mono text-white" id="alloc-text-taxpayer">@(100 - InputAllocation).ToString("F0")%</div>
                                </div>
                                <input type="range" min="0" max="100" step="5" @bind="InputAllocation" @bind:event="oninput" @oninput="Recalculate" id="input-allocation" 
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-ew-resize z-40">
                            </div>
                            <div class="flex justify-between text-xs font-bold uppercase mt-2">
                                <span class="text-purple-400">Humanitarian Fund</span>
                                <span class="text-emerald-500">General Fund</span>
                            </div>
                        </div>

                        <!-- SOCIAL COSTS -->
                        <div class="pb-10 space-y-8 pl-2 mt-10 border-t border-slate-700 pt-8">
                            <div class="flex justify-between items-baseline mb-6 bg-slate-800 p-2 rounded-lg">
                                <span class="text-sm font-bold text-slate-500">TOTAL SOCIAL COST (PER VICTIM)</span>
                                <span class="text-red-500 font-bold font-mono text-lg" id="val-cost-total">$@CostPerPerson.ToString("N0")</span>
                            </div>
                            
                            @* Helper to render Cost Slider *@
                            @{
                                void RenderCostSlider(string label, double val, Action<double> setVal, double min=0, double max=10000, double def=0)
                                {
                                    <div class="relative">
                                        <div class="flex justify-between mb-1">
                                            <label class="text-xs font-bold text-slate-400 uppercase">@label</label>
                                            <span class="text-white font-mono font-bold">$@val.ToString("N0")</span>
                                        </div>
                                        <div class="relative w-full group flex items-center overflow-visible">
                                            <input type="range" min="@min" max="@max" step="10" value="@val" 
                                                @oninput="@((ChangeEventArgs e) => { setVal(double.Parse(e.Value.ToString())); Recalculate(); })"
                                                class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-red-500 relative z-20">
                                        </div>
                                    </div>
                                }
                            }

                            @RenderCostSlider("Crime Costs", InputCostCrime, v => InputCostCrime = v, 0, 10000, 1625)
                            @RenderCostSlider("Lost Employment", InputCostBusiness, v => InputCostBusiness = v, 0, 10000, 4051)
                            @RenderCostSlider("Bankruptcy", InputCostBankruptcy, v => InputCostBankruptcy = v, 0, 10000, 431)
                            @RenderCostSlider("Illness", InputCostIllness, v => InputCostIllness = v, 0, 10000, 1328)
                            @RenderCostSlider("Social Services", InputCostServices, v => InputCostServices = v, 0, 10000, 713)
                            @RenderCostSlider("Abused Dollars", InputCostAbused, v => InputCostAbused = v, 0, 10000, 5055)

                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTS -->
            <div class="bg-slate-800 rounded-3xl p-4 sm:p-8 border border-slate-700 shadow-2xl relative overflow-hidden flex flex-col justify-center">
                <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-red-500/10 rounded-full blur-3xl"></div>

                <h3 class="text-xl font-bold text-slate-300 dark:text-white mb-2" id="deficit-title">
                    <span class="material-symbols-outlined text-blue-500">calculate</span>
                    Deficit Calculation
                </h3>

                <!-- Split Balance Sheet -->
                <div class="relative z-10 bg-slate-900/50 rounded-2xl p-6 border border-slate-600 mb-6 font-sans">
                    <div class="text-sm text-slate-200 uppercase tracking-widest font-bold mb-2 text-center">
                        Net Economic Impact
                    </div>

                    <p class="text-sm text-slate-400 leading-relaxed mb-6 px-4 text-left">
                        Tax revenue is allocated based on a tiered prioritization model. The <span
                            class="text-purple-400 font-bold">Humanitarian Fund</span> exclusively targets Public
                        Health liabilities (addiction and mental health). The <span
                            class="text-blue-400 font-bold">General Fund</span> is distributed pro-rata among Law
                        Enforcement, Social Services, and Civil Legal based on their relative share of the total
                        public sector burden. <span class="text-orange-400 font-bold">Private sector</span> economic
                        losses (Abused Dollars and Lost Employment) receive zero direct tax revenue offset in this
                        analysis.
                    </p>

                    <div class="grid grid-cols-4 gap-2 text-sm uppercase text-slate-500 font-bold mb-2 px-2 border-b border-slate-700 pb-2">
                        <div class="col-span-1">Group</div>
                        <div class="col-span-1 text-right">Revenue</div>
                        <div class="col-span-1 text-right">Cost</div>
                        <div class="col-span-1 text-right">Balance</div>
                    </div>

                    <div class="space-y-4">
                        @{
                            string FmtM(double v) => "$" + (v / 1_000_000.0).ToString("F1") + "MM";
                            string FmtDiff(double v) => (v >= 0 ? "+$" : "-$") + Math.Abs(v / 1_000_000.0).ToString("F1") + "MM";
                            string NetClass(double v) => "text-right font-bold font-mono " + (v >= 0 ? "text-emerald-400" : "text-red-500");
                        }

                        <!-- 1a. Public Health (Humanitarian) -->
                        <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700/50 pt-2">
                            <div class="flex items-center gap-1">
                                <span class="font-bold text-purple-400">Public Health (Humanitarian)</span>
                            </div>
                            <div class="text-right text-emerald-400 font-mono">@FmtM(RevHealthHuman)</div>
                            <div class="text-right text-red-400 font-mono">@FmtM(CostHealthHuman)</div>
                            <div class="@NetClass(NetHealthHuman)">@FmtDiff(NetHealthHuman)</div>
                        </div>

                        <!-- 1b. Public Health (Taxpayer) -->
                        <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700/50 pt-2">
                            <div class="flex items-center gap-1">
                                <span class="font-bold text-purple-400">Public Health (Taxpayer)</span>
                            </div>
                            <div class="text-right text-emerald-400 font-mono">@FmtM(RevHealthTax)</div>
                            <div class="text-right text-red-400 font-mono">@FmtM(CostHealthTax)</div>
                            <div class="@NetClass(NetHealthTax)">@FmtDiff(NetHealthTax)</div>
                        </div>

                        <!-- Subtotal: Public Health -->
                        <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700 pt-2 bg-slate-800/30">
                            <div class="flex items-center gap-1 text-purple-300 font-bold italic">
                                <span>Subtotal: Health</span>
                            </div>
                            <div class="text-right text-emerald-400/80 font-mono italic">@FmtM(SubHealthRev)</div>
                            <div class="text-right text-red-400/80 font-mono italic">@FmtM(SubHealthCost)</div>
                            <div class="@NetClass(SubHealthNet) italic">@FmtDiff(SubHealthNet)</div>
                        </div>


                        <!-- Law Enforcement -->
                        <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700/50 pt-2 mt-4">
                            <div class="flex items-center gap-1">
                                <span class="font-bold text-blue-400">Law Enforcement</span>
                            </div>
                            <div class="text-right text-emerald-400 font-mono">@FmtM(RevCrime)</div>
                            <div class="text-right text-red-400 font-mono">@FmtM(TotalCostCrime)</div>
                            <div class="@NetClass(NetCrime)">@FmtDiff(NetCrime)</div>
                        </div>

                        <!-- Social Services -->
                        <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700/50 pt-2">
                            <div class="flex items-center gap-1">
                                <span class="font-bold text-blue-400">Social Services</span>
                            </div>
                            <div class="text-right text-emerald-400 font-mono">@FmtM(RevSocial)</div>
                            <div class="text-right text-red-400 font-mono">@FmtM(TotalCostSocial)</div>
                            <div class="@NetClass(NetSocial)">@FmtDiff(NetSocial)</div>
                        </div>

                        <!-- Civil Legal -->
                        <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700/50 pt-2">
                            <div class="flex items-center gap-1">
                                <span class="font-bold text-blue-400">Civil Legal</span>
                            </div>
                            <div class="text-right text-emerald-400 font-mono">@FmtM(RevLegal)</div>
                            <div class="text-right text-red-400 font-mono">@FmtM(TotalCostLegal)</div>
                            <div class="@NetClass(NetLegal)">@FmtDiff(NetLegal)</div>
                        </div>

                        <!-- Subtotal: General Taxpayer -->
                        <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700 pt-2 bg-slate-800/30">
                             <div class="flex items-center gap-1 text-blue-300 font-bold italic">
                                <span>Subtotal: General</span>
                            </div>
                            <div class="text-right text-emerald-400/80 font-mono italic">@FmtM(SubGenRev)</div>
                            <div class="text-right text-red-400/80 font-mono italic">@FmtM(SubGenCost)</div>
                            <div class="@NetClass(NetGenSub) italic">@FmtDiff(NetGenSub)</div>
                        </div>

                        <!-- Subtotal: Total Public Burden -->
                         <div class="grid grid-cols-4 gap-2 items-center text-sm font-black border-t-2 border-slate-500 pt-2 mt-2">
                             <div class="flex items-center gap-1 text-white">
                                <span>Total Public Sector</span>
                            </div>
                            <div class="text-right text-emerald-400 font-mono">@FmtM(SubPublicRev)</div>
                            <div class="text-right text-red-400 font-mono">@FmtM(SubPublicCost)</div>
                            <div class="@NetClass(NetPublicSub)">@FmtDiff(NetPublicSub)</div>
                        </div>

                        <!-- Private Sector Breakout -->
                        <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700/50 pt-4 mt-2">
                             <div class="flex items-center gap-1">
                                <span class="font-bold text-slate-400">Abused Dollars</span>
                            </div>
                             <div class="text-right text-emerald-400 font-mono">@FmtM(0)</div>
                             <div class="text-right text-red-400 font-mono">@FmtM(TotalCostAbused)</div>
                             <div class="text-right font-mono text-red-500">@FmtDiff(0 - TotalCostAbused)</div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700/50 pt-2">
                             <div class="flex items-center gap-1">
                                <span class="font-bold text-slate-400">Lost Employment</span>
                            </div>
                             <div class="text-right text-emerald-400 font-mono">@FmtM(0)</div>
                             <div class="text-right text-red-400 font-mono">@FmtM(TotalCostEmployment)</div>
                             <div class="text-right font-mono text-red-500">@FmtDiff(0 - TotalCostEmployment)</div>
                        </div>

                         <!-- Subtotal: Private Sector -->
                         <div class="grid grid-cols-4 gap-2 items-center text-xs sm:text-sm border-t border-slate-700 pt-2 bg-slate-800/30">
                             <div class="flex items-center gap-1 text-slate-300 font-bold italic">
                                <span>Subtotal: Private</span>
                            </div>
                            <div class="text-right text-emerald-400/80 font-mono italic">@FmtM(0)</div>
                            <div class="text-right text-red-400/80 font-mono italic">@FmtM(TotalCostPrivate)</div>
                            <div class="text-right font-mono text-red-500 italic">@FmtDiff(0 - TotalCostPrivate)</div>
                        </div>


                        <!-- TOTAL NET IMPACT -->
                        <div class="grid grid-cols-4 gap-2 items-center text-base sm:text-lg font-black border-t-2 border-white/20 pt-4 mt-6">
                            <div class="flex items-center gap-1 text-white">
                                <span>TOTAL NET IMPACT</span>
                            </div>
                             <div class="text-right text-emerald-400 font-mono">@FmtM(CalcTaxRevenue * 1_000_000)</div>
                             <div class="text-right text-red-400 font-mono">@FmtM(TotalCostCombined)</div>
                             <div class="@NetClass(NetTotalBalance) text-base">@FmtDiff(NetTotalBalance)</div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                     <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Revenue Covered</span>
                        <span>@Math.Round(PercentCovered)%</span>
                    </div>
                    <div class="w-full bg-slate-700 h-4 rounded-full overflow-hidden border border-slate-600">
                        <div id="res-bar" class="@(PercentCovered >= 100 ? "bg-emerald-500" : "bg-red-500") h-full transition-all duration-500" style="width: @PercentCovered%"></div>
                    </div>
                     <p id="res-footer" class="text-center text-slate-400 text-sm mt-4 italic">
                        @if (PercentCovered >= 100)
                        {
                            <span>Revenue covers <strong class="text-white text-lg">100%</strong> of costs.</span>
                        }
                        else
                        {
                            <span>Tax Revenue covers only <strong class="text-white text-lg">@Math.Round(PercentCovered)%</strong> of costs.</span>
                        }
                    </p>
                </div>

                 <div class="mt-8 p-4 bg-slate-900/50 rounded-xl border border-slate-700">
                    <p id="analysis-text" class="text-slate-300 text-xs leading-relaxed">
                        @AnalysisText
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scenario Simulator Modal -->
    <div id="simulator-modal" class="fixed inset-0 z-[1000] hidden opacity-0 transition-opacity duration-300"
        aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity"
            onclick="window.closeSimulatorModal()"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-slate-800 border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">

                    <!-- Header -->
                    <div class="bg-slate-900/50 px-6 py-4 border-b border-slate-700">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2" id="modal-title">
                                <span class="material-symbols-outlined text-blue-500">science</span>
                                Economic Impact Simulator
                            </h3>
                            <button onclick="window.closeSimulatorModal()"
                                class="text-slate-400 hover:text-white transition-colors">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>

                        <!-- Segmented Progress Bar -->
                        <div class="grid grid-cols-3 gap-4 w-full mt-6">
                            <!-- Step 1 Indicator -->
                            <div class="flex flex-col gap-2 group cursor-pointer" onclick="window.goToSimStep(1)">
                                <div id="sim-bar-1"
                                    class="h-1.5 w-full bg-emerald-500 rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(16,185,129,0.5)]">
                                </div>
                                <span id="sim-label-1"
                                    class="text-[10px] sm:text-xs font-bold text-emerald-400 uppercase tracking-widest transition-colors duration-300">Revenue</span>
                            </div>
                            <!-- Step 2 Indicator -->
                            <div class="flex flex-col gap-2 group cursor-pointer" onclick="window.goToSimStep(2)">
                                <div id="sim-bar-2"
                                    class="h-1.5 w-full bg-slate-700 rounded-full transition-all duration-300"></div>
                                <span id="sim-label-2"
                                    class="text-[10px] sm:text-xs font-bold text-slate-600 uppercase tracking-widest transition-colors duration-300">Allocation</span>
                            </div>
                            <!-- Step 3 Indicator -->
                            <div class="flex flex-col gap-2 group cursor-pointer" onclick="window.goToSimStep(3)">
                                <div id="sim-bar-3"
                                    class="h-1.5 w-full bg-slate-700 rounded-full transition-all duration-300"></div>
                                <span id="sim-label-3"
                                    class="text-[10px] sm:text-xs font-bold text-slate-600 uppercase tracking-widest transition-colors duration-300">Social
                                    Costs</span>
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="px-6 py-6 h-[500px] flex flex-col overflow-y-auto custom-scrollbar">

                        <!-- Step 1: Revenue Scenario -->
                        <div id="sim-step-1"
                            class="sim-step w-full h-full flex flex-col justify-start transition-all duration-300">
                            <label class="text-sm font-bold text-slate-400 uppercase tracking-wider block mb-3">1.
                                Select Adjusted Gross Revenue (AGR) Scenario</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                <!-- $43M -->
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="sim-agr" value="43" class="peer sr-only">
                                    <div
                                        class="p-4 rounded-xl bg-slate-700/50 border-2 border-slate-600 peer-checked:border-emerald-500 peer-checked:bg-emerald-500/10 transition-all hover:bg-slate-700 h-full flex flex-col">
                                        <div class="text-lg font-black text-white mb-1">$43 MM</div>
                                        <div class="text-xs text-slate-400 leading-tight">Spectrum Gaming (With Tribal
                                            Competition)</div>
                                    </div>
                                    <div
                                        class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity">
                                        <span
                                            class="material-symbols-outlined text-emerald-500 text-lg">check_circle</span>
                                    </div>
                                </label>

                                <!-- $112M (Default) -->
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="sim-agr" value="112" class="peer sr-only" checked>
                                    <div
                                        class="p-4 rounded-xl bg-slate-700/50 border-2 border-slate-600 peer-checked:border-emerald-500 peer-checked:bg-emerald-500/10 transition-all hover:bg-slate-700 h-full flex flex-col">
                                        <div class="text-lg font-black text-white mb-1">$112 MM</div>
                                        <div class="text-xs text-slate-400 leading-tight">Spectrum Gaming (Primary
                                            Projection)</div>
                                    </div>
                                    <div
                                        class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity">
                                        <span
                                            class="material-symbols-outlined text-emerald-500 text-lg">check_circle</span>
                                    </div>
                                </label>

                                <!-- $204M -->
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="sim-agr" value="204" class="peer sr-only">
                                    <div
                                        class="p-4 rounded-xl bg-slate-700/50 border-2 border-slate-600 peer-checked:border-emerald-500 peer-checked:bg-emerald-500/10 transition-all hover:bg-slate-700 h-full flex flex-col">
                                        <div class="text-lg font-black text-white mb-1">$204 MM</div>
                                        <div class="text-xs text-slate-400 leading-tight">Spectrum Gaming (No Tribal
                                            Competition)</div>
                                    </div>
                                    <div
                                        class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity">
                                        <span
                                            class="material-symbols-outlined text-emerald-500 text-lg">check_circle</span>
                                    </div>
                                </label>

                                <!-- $330M -->
                                <label class="cursor-pointer group relative">
                                    <input type="radio" name="sim-agr" value="330" class="peer sr-only">
                                    <div
                                        class="p-4 rounded-xl bg-slate-700/50 border-2 border-slate-600 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition-all hover:bg-slate-700 h-full flex flex-col">
                                        <div class="text-lg font-black text-white mb-1">$330 MM</div>
                                        <div class="text-xs text-slate-400 leading-tight">Union Gaming (FWFirst Sales
                                            Pitch)</div>
                                    </div>
                                </label>
                            </div>

                            <!-- Custom Option -->
                            <div class="relative flex py-10 items-center">
                                <div class="flex-grow border-t border-slate-700"></div>
                                <span
                                    class="flex-shrink-0 mx-4 text-slate-500 text-xs uppercase font-bold tracking-widest">Or
                                    Enter Custom</span>
                                <div class="flex-grow border-t border-slate-700"></div>
                            </div>

                            <label
                                class="cursor-pointer group relative flex items-center p-4 rounded-xl bg-slate-700/30 border-2 border-slate-600 peer-checked:border-emerald-500 peer-checked:bg-emerald-500/10 transition-all hover:bg-slate-700/50">
                                <input type="radio" name="sim-agr" value="custom" class="peer sr-only"
                                    onchange="document.getElementById('sim-custom-agr').focus()">

                                <!-- Visible Radio (Icon Swap) -->
                                <span
                                    class="material-symbols-outlined text-slate-500 text-2xl mr-4 peer-checked:hidden transition-colors">radio_button_unchecked</span>
                                <span
                                    class="material-symbols-outlined text-emerald-500 text-2xl mr-4 hidden peer-checked:block transition-colors">check_circle</span>

                                <div class="flex-1 flex flex-col sm:flex-row sm:items-center gap-4">
                                    <div class="flex-1">
                                        <div class="text-lg font-bold text-white mb-1">Custom AGR Projection</div>
                                        <div class="text-xs text-slate-400">Enter a specific Adjusted Gross Revenue
                                            figure ($MM).</div>
                                    </div>
                                    <div class="relative w-full sm:w-48">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="text-slate-400 font-bold">$</span>
                                        </div>
                                        <input type="number" id="sim-custom-agr" min="0" max="1000" placeholder="112"
                                            class="w-full bg-slate-800 border border-slate-600 text-white rounded-lg py-2 pl-8 pr-12 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all font-mono font-bold text-right"
                                            oninput="document.querySelector('input[name=sim-agr][value=custom]').checked = true">
                                        <div
                                            class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <span class="text-slate-500 font-bold text-xs">MM</span>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- Step 2: Allocation Strategy -->
                        <div id="sim-step-2"
                            class="sim-step w-full h-full flex flex-col justify-start hidden transition-all duration-300">
                            <label class="text-sm font-bold text-slate-400 uppercase tracking-wider block mb-3">2. Tax
                                Allocation Strategy</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label
                                    class="flex items-center p-3 rounded-lg border border-slate-600 bg-slate-700/30 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                    <input type="radio" name="sim-alloc" value="10"
                                        class="w-4 h-4 text-purple-500 bg-slate-800 border-slate-500 focus:ring-purple-500 focus:ring-2">
                                    <div class="ml-3">
                                        <span class="block text-sm font-bold text-white">General Fund Focus</span>
                                        <span class="block text-xs text-slate-400">10% Humanitarian / 90% General</span>
                                    </div>
                                </label>
                                <label
                                    class="flex items-center p-3 rounded-lg border-2 border-purple-500/50 bg-purple-900/10 cursor-pointer hover:bg-purple-900/20 transition-colors">
                                    <input type="radio" name="sim-alloc" value="40"
                                        class="w-4 h-4 text-purple-500 bg-slate-800 border-slate-500 focus:ring-purple-500 focus:ring-2"
                                        checked>
                                    <div class="ml-3">
                                        <span class="block text-sm font-bold text-white">SaveFW Default</span>
                                        <span class="block text-xs text-slate-400">40% Humanitarian / 60% General</span>
                                    </div>
                                </label>
                                <label
                                    class="flex items-center p-3 rounded-lg border border-slate-600 bg-slate-700/30 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                    <input type="radio" name="sim-alloc" value="50"
                                        class="w-4 h-4 text-purple-500 bg-slate-800 border-slate-500 focus:ring-purple-500 focus:ring-2">
                                    <div class="ml-3">
                                        <span class="block text-sm font-bold text-white">Balanced Approach</span>
                                        <span class="block text-xs text-slate-400">50% Humanitarian / 50% General</span>
                                    </div>
                                </label>
                                <label
                                    class="flex items-center p-3 rounded-lg border border-slate-600 bg-slate-700/30 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                    <input type="radio" name="sim-alloc" value="60"
                                        class="w-4 h-4 text-purple-500 bg-slate-800 border-slate-500 focus:ring-purple-500 focus:ring-2">
                                    <div class="ml-3">
                                        <span class="block text-sm font-bold text-white">Humanitarian Focus</span>
                                        <span class="block text-xs text-slate-400">60% Humanitarian / 40% General</span>
                                    </div>
                                </label>
                                <label
                                    class="flex items-center p-3 rounded-lg border border-slate-600 bg-slate-700/30 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                    <input type="radio" name="sim-alloc" value="75"
                                        class="w-4 h-4 text-purple-500 bg-slate-800 border-slate-500 focus:ring-purple-500 focus:ring-2">
                                    <div class="ml-3">
                                        <span class="block text-sm font-bold text-white">Maximum Support</span>
                                        <span class="block text-xs text-slate-400">75% Humanitarian / 25% General</span>
                                    </div>
                                </label>
                            </div>

                            <!-- Custom Option -->
                            <div class="relative flex py-10 items-center">
                                <div class="flex-grow border-t border-slate-700"></div>
                                <span
                                    class="flex-shrink-0 mx-4 text-slate-500 text-xs uppercase font-bold tracking-widest">Or
                                    Enter Custom</span>
                                <div class="flex-grow border-t border-slate-700"></div>
                            </div>

                            <label
                                class="cursor-pointer group relative flex items-center p-4 rounded-xl bg-slate-700/30 border-2 border-slate-600 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition-all hover:bg-slate-700/50">
                                <input type="radio" name="sim-alloc" value="custom" class="peer sr-only"
                                    onchange="document.getElementById('sim-custom-alloc').focus()">

                                <!-- Visible Radio (Icon Swap) -->
                                <span
                                    class="material-symbols-outlined text-slate-500 text-2xl mr-4 peer-checked:hidden transition-colors">radio_button_unchecked</span>
                                <span
                                    class="material-symbols-outlined text-purple-500 text-2xl mr-4 hidden peer-checked:block transition-colors">check_circle</span>

                                <div class="flex-1 flex flex-col sm:flex-row sm:items-center gap-4">
                                    <div class="flex-1">
                                        <div class="text-lg font-bold text-white mb-1">Custom Allocation</div>
                                        <div class="text-xs text-slate-400">Enter the percentage allocated to the
                                            Humanitarian Fund (0-100%).</div>
                                    </div>
                                    <div class="relative w-full sm:w-32">
                                        <input type="number" id="sim-custom-alloc" min="0" max="100" placeholder="40"
                                            class="w-full bg-slate-800 border border-slate-600 text-white rounded-lg py-2 pl-4 pr-12 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all font-mono font-bold text-right"
                                            oninput="document.querySelector('input[name=sim-alloc][value=custom]').checked = true">
                                        <div
                                            class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <span class="text-slate-500 font-bold text-xs">%</span>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- Step 3: Social Cost Sensitivity -->
                        <div id="sim-step-3"
                            class="sim-step w-full h-full flex flex-col justify-start hidden transition-all duration-300">
                            <label class="text-sm font-bold text-slate-400 uppercase tracking-wider block mb-3">3.
                                Social Cost Sensitivity</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <label
                                    class="flex items-center p-3 rounded-lg border border-slate-600 bg-slate-700/30 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                    <input type="radio" name="sim-cost" value="0.8"
                                        class="w-4 h-4 text-red-500 bg-slate-800 border-slate-500 focus:ring-red-500 focus:ring-2">
                                    <div class="ml-3">
                                        <span class="block text-sm font-bold text-white">Conservative</span>
                                        <span class="block text-xs text-slate-400">-20% to Baseline</span>
                                    </div>
                                </label>
                                <label
                                    class="flex items-center p-3 rounded-lg border-2 border-red-500/50 bg-red-900/10 cursor-pointer hover:bg-red-900/20 transition-colors">
                                    <input type="radio" name="sim-cost" value="1.0"
                                        class="w-4 h-4 text-red-500 bg-slate-800 border-slate-500 focus:ring-red-500 focus:ring-2"
                                        checked>
                                    <div class="ml-3">
                                        <span class="block text-sm font-bold text-white">Standard Baseline</span>
                                        <span class="block text-xs text-slate-400">Inflation-Adjusted Grinols</span>
                                    </div>
                                </label>
                                <label
                                    class="flex items-center p-3 rounded-lg border border-slate-600 bg-slate-700/30 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                    <input type="radio" name="sim-cost" value="1.2"
                                        class="w-4 h-4 text-red-500 bg-slate-800 border-slate-500 focus:ring-red-500 focus:ring-2">
                                    <div class="ml-3">
                                        <span class="block text-sm font-bold text-white">Aggressive</span>
                                        <span class="block text-xs text-slate-400">+20% to Baseline</span>
                                    </div>
                                </label>
                            </div>

                            <!-- Custom Option -->
                            <div class="relative flex py-10 items-center">
                                <div class="flex-grow border-t border-slate-700"></div>
                                <span
                                    class="flex-shrink-0 mx-4 text-slate-500 text-xs uppercase font-bold tracking-widest">Or
                                    Enter Custom</span>
                                <div class="flex-grow border-t border-slate-700"></div>
                            </div>

                            <label
                                class="cursor-pointer group relative flex flex-col p-4 rounded-xl bg-slate-700/30 border-2 border-slate-600 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition-all hover:bg-slate-700/50">

                                <div class="flex items-center gap-4 mb-4">
                                    <input type="radio" name="sim-cost" value="custom" class="peer sr-only"
                                        id="sim-cost-custom-radio">

                                    <!-- Visible Radio (Icon Swap) -->
                                    <span
                                        class="material-symbols-outlined text-slate-500 text-2xl shrink-0 peer-checked:hidden transition-colors">radio_button_unchecked</span>
                                    <span
                                        class="material-symbols-outlined text-red-500 text-2xl shrink-0 hidden peer-checked:block transition-colors">check_circle</span>

                                    <div class="flex-1">
                                        <div class="text-lg font-bold text-white mb-1">Custom Adjustment</div>
                                        <div class="text-xs text-slate-400">Apply a percentage increase or decrease to
                                            the baseline costs.</div>
                                    </div>
                                </div>

                                <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-600/50">
                                    <div class="flex flex-col sm:flex-row gap-4 items-center">

                                        <!-- Direction Toggle -->
                                        <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                                            <label class="cursor-pointer">
                                                <input type="radio" name="sim-cost-dir" value="-1" class="peer sr-only"
                                                    onchange="window.updateCustomCostDisplay()">
                                                <div
                                                    class="px-4 py-2 rounded-md text-sm font-bold text-slate-400 bg-transparent peer-checked:bg-red-600 peer-checked:text-white peer-checked:shadow-inner transition-all">
                                                    Decrease</div>
                                            </label>
                                            <label class="cursor-pointer">
                                                <input type="radio" name="sim-cost-dir" value="1" class="peer sr-only"
                                                    checked onchange="window.updateCustomCostDisplay()">
                                                <div
                                                    class="px-4 py-2 rounded-md text-sm font-bold text-slate-400 bg-transparent peer-checked:bg-emerald-600 peer-checked:text-white peer-checked:shadow-inner transition-all">
                                                    Increase</div>
                                            </label>
                                        </div>

                                        <!-- Percentage Input -->
                                        <div class="relative w-32">
                                            <input type="number" id="sim-custom-pct" min="0" max="500" placeholder="20"
                                                class="w-full bg-slate-900 border border-slate-600 text-white rounded-lg py-2 pl-4 pr-8 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all font-mono font-bold text-right"
                                                oninput="document.getElementById('sim-cost-custom-radio').checked = true; window.updateCustomCostDisplay()">
                                            <div
                                                class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                <span class="text-slate-500 font-bold text-xs">%</span>
                                            </div>
                                        </div>

                                        <!-- Result Display -->
                                        <div
                                            class="flex-1 text-right sm:text-left sm:pl-4 border-t sm:border-t-0 sm:border-l border-slate-700 pt-4 sm:pt-0">
                                            <div
                                                class="text-[10px] uppercase font-bold text-slate-500 tracking-wider mb-1">
                                                Resulting Multiplier</div>
                                            <div class="text-xl font-mono font-black text-white" id="sim-custom-result">
                                                1.00x</div>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="bg-slate-900/50 px-6 py-4 border-t border-slate-700 flex justify-between items-center">
                        <button id="sim-btn-back" onclick="window.prevSimStep()"
                            class="hidden px-6 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-500 transition-colors shadow-lg shadow-red-500/20 flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm">arrow_back</span> Back
                        </button>
                        <button id="sim-btn-cancel" onclick="window.closeSimulatorModal()"
                            class="px-6 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-500 transition-colors shadow-lg shadow-red-500/20">
                            Cancel
                        </button>

                        <div class="flex gap-3">
                            <button id="sim-btn-next" onclick="window.nextSimStep()"
                                class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-500 transition-colors shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2">
                                Next <span class="material-symbols-outlined text-sm">arrow_forward</span>
                            </button>
                            <button id="sim-btn-run" onclick="window.runSimulation()"
                                class="hidden px-6 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold hover:from-blue-500 hover:to-cyan-400 transition-colors shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined">play_arrow</span> Run Simulation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End Flex Col -->

        <!-- PART II: THE MYTH OF NET GROWTH -->
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-24 border-t border-slate-700 pt-24">
            <!-- Header -->
            <div class="mb-12 text-center" id="economic-analysis-part-2">
                <span class="text-blue-500 font-bold tracking-wider uppercase text-base">Economic Analysis - Part II</span>
                <h2 class="mt-2 text-3xl font-black tracking-tight text-white sm:text-5xl leading-tight">
                    THE MYTH OF <br><span class="text-blue-500">NET GROWTH</span>
                </h2>
                <div class="mt-4 text-xl italic text-slate-400 leading-relaxed max-w-3xl mx-auto">
                    <p>
                        The primary economic argument for the Fort Wayne casino is that it will generate "new" money.
                        This assumes it functions as a tourist destination. However, in markets lacking high-density
                        attractions, casinos operate as <strong>"convenience gambling"</strong> venues, leading to the
                        <strong>Substitution Effect</strong>.
                    </p>
                </div>
            </div>

            <div class="mb-16 bg-slate-800 shadow-lg rounded-3xl border border-slate-700 p-6 sm:p-8 backdrop-blur-sm relative overflow-hidden">
                <div class="text-left relative z-10">
                    <h4 class="text-white font-bold mb-4 flex items-center gap-2 text-xl">
                        <span class="material-symbols-outlined text-blue-500 text-3xl">analytics</span>
                        Evidence: Spectrum Study (2025)
                    </h4>
                    <p class="mb-4 text-slate-400">
                        A critical analysis of the Spectrum Study (2025) provides the most definitive evidence against
                        the "Economic Engine" narrative. The study's own data admits that for a Northeast Indiana
                        location, <strong>nearly 95% of the revenue is expected to come from the "core market-catchment
                            area" (residents within 90 minutes)</strong>. This statistic mathematically disproves the
                        "tourism" argument. If 95% of the money originates from local pockets, there is no "New Money"
                        being introduced; it is purely a <strong>wealth transfer</strong> from Fort Wayne families to a
                        corporate entity, with the city retaining only a small "convenience fee" in the form of tax
                        revenue.
                    </p>

                    <h4 class="text-white font-bold mt-6 mb-4 flex items-center gap-2 text-xl">
                        <span class="material-symbols-outlined text-red-500 text-3xl">block</span>
                        Market Saturation & Competitive Landscape
                    </h4>
                    <p class="mb-4 text-slate-400">
                        To function as a genuine destination, a venue must offer a unique value proposition that
                        transcends local alternatives. However, the Northeast Indiana market is already saturated by
                        established competitors:
                    </p>
                    <ul class="list-disc pl-5 space-y-2 mb-6 text-slate-400">
                        <li><strong>South Bend:</strong> Four Winds</li>
                        <li><strong>Toledo:</strong> Hollywood Casino</li>
                        <li><strong>Battle Creek:</strong> FireKeepers</li>
                        <li><strong>Indianapolis:</strong> Horseshoe (Shelbyville)</li>
                    </ul>
                    <p class="font-bold text-white border-l-4 border-blue-500 pl-4 py-1">
                        Conclusion: Given the proximity of these established gaming centers, a standard regional casino
                        lacks the requisite differentiation to attract significant external tourism, as potential
                        visitors are already served by closer facilities.
                    </p>
                </div>
            </div>

            <!-- Interactive Substitution Visualizer -->
            <div class="mb-16 bg-slate-800 shadow-lg rounded-3xl border border-slate-700 p-4 sm:p-8 backdrop-blur-sm relative overflow-hidden">
                <!-- Background accent -->
                <div class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl p-6"></div>

                <div class="text-center mb-10 relative z-10">
                    <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                        <span class="material-symbols-outlined text-emerald-400 text-3xl">account_balance_wallet</span>
                        Household Discretionary Budget: $500/mo
                    </h3>
                    <p class="text-slate-400 text-base mt-3 max-w-2xl mx-auto">
                        See how the local economy suffers when spending shifts. The total household budget for
                        entertainment is fixed.
                        When a casino enters, it doesn't create new money; it eats into existing categories.
                    </p>
                </div>

                <div class="grid md:grid-cols-2 gap-12 items-center relative z-10">
                    <!-- Before -->
                    <div class="flex flex-col items-center">
                        <h4 class="text-white font-bold mb-6 flex items-center gap-2">
                            <span class="bg-slate-700 text-slate-200 text-sm px-2 py-1 rounded">Current State</span>
                            Before Casino
                        </h4>
                        <div class="w-64 h-64 relative">
                            <canvas id="chartBefore"></canvas>
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-base font-medium text-emerald-400">100% Local Circulation</p>
                            <p class="text-sm text-slate-500 mt-1">Money recirculates 5-7 times in the local economy.</p>
                        </div>
                    </div>

                    <!-- After -->
                    <div class="flex flex-col items-center relative">
                        <h4 class="text-white font-bold mb-6 flex items-center gap-2">
                            <span class="bg-red-900/30 text-red-400 text-sm px-2 py-1 rounded border border-red-900/50">Future State</span>
                            After Casino
                        </h4>

                        <div class="w-64 h-64 relative">
                            <canvas id="chartAfter"></canvas>
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-base font-medium text-red-400">25-30% Wealth Extraction</p>
                            <p class="text-sm text-slate-500 mt-1">Casino profits are exported to external investors.</p>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="mt-10 flex flex-wrap justify-center gap-6 text-sm font-medium text-slate-400 border-t border-slate-700/50 pt-6">
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#3b82f6]"></div> Retail (Clothes, Hobbies)</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#8b5cf6]"></div> Dining & Restaurants</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#10b981]"></div> Local Entertainment</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#f97316]"></div> Savings</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-[#ef4444]"></div> Casino Loss</div>
                </div>

                <!-- Mechanics & Context (Restored) -->
                <div class="grid lg:grid-cols-2 gap-8 items-start mt-12 pt-8 border-t border-slate-700/50">
                    <!-- Left Column: The Data -->
                    <div>
                        <!-- Substitution Effect Card -->
                        <div class="bg-slate-800 shadow-lg rounded-3xl border border-slate-700 p-8 backdrop-blur-sm h-full">
                            <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                                <span class="material-symbols-outlined text-blue-500">sync_problem</span>
                                Mechanics of the Substitution Effect
                            </h3>
                            <p class="text-slate-400 mb-6 leading-relaxed">
                                For a casino to generate net growth, it must function as an "export" industrybringing in
                                outside dollars. If it merely recirculates local capital, the net impact is neutral or
                                negative.
                                <br><br>
                                Research by the <strong>Federal Reserve Bank of St. Louis</strong> notes that in
                                mid-sized urban areas, casinos often correlate with a <em>stagnation or decrease</em> in local retail
                                sales. The casino acts as a gravitational well, absorbing liquidity that formerly supported small
                                businesses.
                            </p>

                            <!-- Data Callout -->
                            <div class="bg-red-900/20 border-l-4 border-red-500 p-6 rounded-r-xl mb-8">
                                <h4 class="text-lg font-bold text-red-500 mb-2">"243" Coefficient</h4>
                                <p class="text-slate-300 text-base">
                                    For every <strong>$1,000 increase</strong> in casino revenue, businesses within a
                                    10-30 mile radius experience a <strong>loss of approximately $243</strong> in sales.
                                </p>
                            </div>

                            <!-- Displacement Table -->
                            <div class="overflow-x-auto rounded-xl border border-slate-700">
                                <table class="w-full text-left text-base text-slate-400">
                                    <thead class="bg-slate-900 text-slate-300 uppercase font-bold text-sm">
                                        <tr>
                                            <th class="px-6 py-4">Metric</th>
                                            <th class="px-6 py-4">Value</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-700 bg-slate-800">
                                        <tr>
                                            <td class="px-6 py-4 font-medium text-white">Projected Casino AGR</td>
                                            <td class="px-6 py-4 text-emerald-400 font-bold">$204.3M</td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-4 font-medium text-white">Displacement Coefficient</td>
                                            <td class="px-6 py-4 text-orange-400 font-bold">24.3%</td>
                                        </tr>
                                        <tr class="bg-red-900/10">
                                            <td class="px-6 py-4 font-bold text-white">Projected Local Loss</td>
                                            <td class="px-6 py-4 text-red-500 font-black">($49.6M)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: The Context -->
                    <div class="space-y-6">
                        <!-- Factory vs Restaurant -->
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div class="bg-slate-800 shadow-sm p-6 rounded-3xl border-l-4 border-red-500">
                                <div class="text-red-500 font-bold uppercase tracking-widest text-sm mb-2">Fallacy</div>
                                <h3 class="text-lg font-bold text-white mb-2">"Economic Development"</h3>
                                <p class="text-slate-400 text-sm leading-relaxed">
                                    Proponents claim the casino expands the economic pie, ignoring the reality of
                                    convenience gaming.
                                </p>
                            </div>
                            <div class="bg-slate-800 shadow-sm p-6 rounded-3xl border-l-4 border-emerald-500">
                                <div class="text-emerald-500 font-bold uppercase tracking-widest text-sm mb-2">The Reality</div>
                                <h3 class="text-lg font-bold text-white mb-2">Factory vs. Restaurant</h3>
                                <p class="text-slate-400 text-sm leading-relaxed">
                                    A local casino merely competes for the <strong>existing pool</strong> of
                                    entertainment dollars like a restaurant.
                                </p>
                            </div>
                        </div>

                        <!-- Recession Risk -->
                        <div class="bg-slate-800 shadow-sm rounded-3xl p-8 border-l-4 border-yellow-500">
                            <h3 class="text-xl font-bold text-white mb-2">Recessionary Vulnerability</h3>
                            <p class="text-slate-400 text-base mb-4 leading-relaxed">
                                During the 2007-2012 Recession, retail sales in casino-hosting economies <strong>grew 3x
                                    slower</strong> (2.4%) than in non-casino economies (8.6%).
                            </p>
                            <p class="text-white italic font-medium text-base">
                                "Introducing a casino introduces a structural weakness apparent during recession."
                            </p>
                        </div>

                        <!-- Economic Monoculture -->
                        <div class="bg-slate-800 shadow-sm rounded-3xl p-8 border-l-4 border-blue-500">
                            <h3 class="text-xl font-bold text-white mb-2">Economic Monoculture</h3>
                            <p class="text-slate-400 text-base leading-relaxed">
                                The casino acts as an invasive species, displacing diverse local businesses and creating
                                a <strong>single point of failure</strong>.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

</section>

@code {
    private bool isManualOpen = true;
    private void ToggleManual() => isManualOpen = !isManualOpen;

    // --- Inputs ---
    private double InputAGR { get; set; } = 112;
    private double InputRevenue { get; set; } = 27.5;
    private double InputAllocation { get; set; } = 40;
    private double InputRate { get; set; } = 2.3;

    // Social Costs
    private double InputCostCrime { get; set; } = 1625;
    private double InputCostBusiness { get; set; } = 4051;
    private double InputCostBankruptcy { get; set; } = 431;
    private double InputCostIllness { get; set; } = 1328;
    private double InputCostServices { get; set; } = 713;
    private double InputCostAbused { get; set; } = 5055;

    // County Selection
    private class CountyInfo { public string Id { get; set; } public string Name { get; set; } public int Pop { get; set; } }
    private string SelectedCountyId { get; set; } = "003"; // Allen
    private string SelectedCountyName { get; set; } = "Allen";
    private int InputPopulation { get; set; } = 385410;

    private List<CountyInfo> Counties = new()
    {
        new() { Id="001", Name="Adams", Pop=35809 }, new() { Id="003", Name="Allen", Pop=385410 }, new() { Id="005", Name="Bartholomew", Pop=82208 },
        new() { Id="007", Name="Benton", Pop=8719 }, new() { Id="009", Name="Blackford", Pop=12112 }, new() { Id="011", Name="Boone", Pop=70812 },
        new() { Id="013", Name="Brown", Pop=15475 }, new() { Id="015", Name="Carroll", Pop=20306 }, new() { Id="017", Name="Cass", Pop=37870 },
        new() { Id="019", Name="Clark", Pop=121093 }, new() { Id="021", Name="Clay", Pop=26466 }, new() { Id="023", Name="Clinton", Pop=33190 },
        new() { Id="025", Name="Crawford", Pop=10526 }, new() { Id="027", Name="Daviess", Pop=33381 }, new() { Id="029", Name="Dearborn", Pop=50679 },
        new() { Id="031", Name="Decatur", Pop=26472 }, new() { Id="033", Name="DeKalb", Pop=43265 }, new() { Id="035", Name="Delaware", Pop=111903 },
        new() { Id="037", Name="Dubois", Pop=43637 }, new() { Id="039", Name="Elkhart", Pop=207047 }, new() { Id="041", Name="Fayette", Pop=23398 },
        new() { Id="043", Name="Floyd", Pop=80484 }, new() { Id="045", Name="Fountain", Pop=16479 }, new() { Id="047", Name="Franklin", Pop=22785 },
        new() { Id="049", Name="Fulton", Pop=20480 }, new() { Id="051", Name="Gibson", Pop=33011 }, new() { Id="053", Name="Grant", Pop=66674 },
        new() { Id="055", Name="Greene", Pop=30803 }, new() { Id="057", Name="Hamilton", Pop=347467 }, new() { Id="059", Name="Hancock", Pop=79840 },
        new() { Id="061", Name="Harrison", Pop=39654 }, new() { Id="063", Name: "Hendricks", Pop= 174788 }, new() { Id="065", Name="Henry", Pop=48914 },
        new() { Id="067", Name="Howard", Pop=82544 }, new() { Id="069", Name="Huntington", Pop=36662 }, new() { Id="071", Name="Jackson", Pop=46428 },
        new() { Id="073", Name="Jasper", Pop=32918 }, new() { Id="075", Name="Jay", Pop=20478 }, new() { Id="077", Name="Jefferson", Pop=33147 },
        new() { Id="079", Name="Jennings", Pop=27613 }, new() { Id="081", Name="Johnson", Pop=161765 }, new() { Id="083", Name="Knox", Pop=36282 },
        new() { Id="085", Name="Kosciusko", Pop=80240 }, new() { Id="087", Name="LaGrange", Pop=40446 }, new() { Id="089", Name="Lake", Pop=498700 },
        new() { Id="091", Name="LaPorte", Pop=112417 }, new() { Id="093", Name="Lawrence", Pop=45011 }, new() { Id="095", Name="Madison", Pop=130129 },
        new() { Id="097", Name="Marion", Pop=977203 }, new() { Id="099", Name="Marshall", Pop=46095 }, new() { Id="101", Name="Martin", Pop=9812 },
        new() { Id="103", Name="Miami", Pop=35962 }, new() { Id="105", Name="Monroe", Pop=139718 }, new() { Id="107", Name="Montgomery", Pop=37936 },
        new() { Id="109", Name="Morgan", Pop=71780 }, new() { Id="111", Name="Newton", Pop=13830 }, new() { Id="113", Name="Noble", Pop=47457 },
        new() { Id="115", Name="Ohio", Pop=5940 }, new() { Id="117", Name="Orange", Pop=19867 }, new() { Id="119", Name="Owen", Pop=21321 },
        new() { Id="121", Name="Parke", Pop=16156 }, new() { Id="123", Name="Perry", Pop=19170 }, new() { Id="125", Name="Pike", Pop=12250 },
        new() { Id="127", Name: "Porter", Pop=173215 }, new() { Id="129", Name="Posey", Pop=25222 }, new() { Id="131", Name: "Pulaski", Pop=12514 },
        new() { Id="133", Name: "Putnam", Pop=36726 }, new() { Id="135", Name: "Randolph", Pop=24502 }, new() { Id="137", Name: "Ripley", Pop=28995 },
        new() { Id="139", Name: "Rush", Pop=16752 }, new() { Id="141", Name: "St. Joseph", Pop=272912 }, new() { Id="143", Name: "Scott", Pop=24384 },
        new() { Id="145", Name: "Shelby", Pop=45055 }, new() { Id="147", Name: "Spencer", Pop=19810 }, new() { Id="149", Name: "Starke", Pop=23371 },
        new() { Id="151", Name: "Steuben", Pop=34435 }, new() { Id="153", Name: "Sullivan", Pop=20817 }, new() { Id="155", Name: "Switzerland", Pop=9737 },
        new() { Id="157", Name: "Tippecanoe", Pop=186251 }, new() { Id="159", Name: "Tipton", Pop=15359 }, new() { Id="161", Name: "Union", Pop=7087 },
        new() { Id="163", Name: "Vanderburgh", Pop=180136 }, new() { Id="165", Name: "Vermillion", Pop=15439 }, new() { Id="167", Name: "Vigo", Pop=106153 },
        new() { Id="169", Name: "Wabash", Pop=30976 }, new() { Id="171", Name: "Warren", Pop=8440 }, new() { Id="173", Name: "Warrick", Pop=63898 },
        new() { Id="175", Name: "Washington", Pop=28182 }, new() { Id="177", Name: "Wayne", Pop=66553 }, new() { Id="179", Name="Wells", Pop=28180 },
        new() { Id="181", Name: "White", Pop=24688 }, new() { Id="183", Name: "Whitley", Pop=34191 }
    };

    // --- Outputs ---
    private double CalcTaxRevenue { get; set; }
    private double CalcAGR { get; set; }
    private double CalcEffectiveTaxRate { get; set; }
    private List<TaxTierItem> TaxBreakdown { get; set; } = new();

    // Alloc
    private double AllocHumanitarianPool { get; set; }
    private double AllocGeneralPool { get; set; }

    // Costs
    private double TotalCostHealth { get; set; }
    private double TotalCostSocial { get; set; }
    private double TotalCostCrime { get; set; }
    private double TotalCostLegal { get; set; }
    private double TotalCostAbused { get; set; }
    private double TotalCostEmployment { get; set; }
    private double TotalCostPrivate { get; set; }
    private double TotalCostPublic { get; set; }
    private double TotalCostCombined { get; set; }

    // Balances
    private double NetHealthHuman { get; set; }
    private double NetHealthTax { get; set; }
    private double NetHealthTotal { get; set; }
    private double NetCrime { get; set; }
    private double NetSocial { get; set; }
    private double NetLegal { get; set; }
    private double NetGenSub { get; set; }
    private double NetPublicSub { get; set; }
    private double NetAbused { get; set; }
    private double NetEmployment { get; set; }
    private double NetPrivateSub { get; set; }
    private double NetTotalBalance { get; set; }

    // Breakdown Props (Matches new HTML)
    private double RevHealthHuman { get; set; }
    private double CostHealthHuman { get; set; }
    
    private double RevHealthTax { get; set; }
    private double CostHealthTax { get; set; }
    
    private double SubHealthRev { get; set; }
    private double SubHealthCost { get; set; }
    private double SubHealthNet { get; set; }

    private double RevCrime { get; set; }
    private double RevSocial { get; set; }
    private double RevLegal { get; set; }

    private double SubGenRev { get; set; }
    private double SubGenCost { get; set; }
    
    private double SubPublicRev { get; set; }
    private double SubPublicCost { get; set; }

    private MarkupString AnalysisText { get; set; }
    private double PercentCovered { get; set; }
    private int ProjectedVictims { get; set; }
    private double CostPerPerson => InputCostCrime + InputCostBusiness + InputCostBankruptcy + InputCostIllness + InputCostServices + InputCostAbused;

    private DotNetObjectReference<EconomicImpact>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);

            // Initial Recalc
            Recalculate();
            StateHasChanged();

            // Map Init is handled by Map component, but let's give it time or assume it works.

            // Chart Init for Part II
            await Task.Delay(500); // Give DOM a moment
            await JSRuntime.InvokeVoidAsync("window.SubstitutionEffect.init");

            // Set up Observer for Victim Count (from Map)
            await JSRuntime.InvokeVoidAsync("eval", @"
                (function(dotNetHelper) {
                    const target = document.getElementById('total-gamblers');
                    if(target) {
                        const observer = new MutationObserver((mutations) => {
                            const val = parseInt(target.textContent.replace(/,/g, '')) || 0;
                            dotNetHelper.invokeMethodAsync('UpdateVictims', val);
                        });
                        observer.observe(target, { characterData: true, childList: true, subtree: true });
                    }
                })
            ", _objRef);
        }
    }

    [JSInvokable]
    public void UpdateVictims(int victims)
    {
        ProjectedVictims = victims;
        Recalculate();
    }
    
    // --- Logic ---
    private class TaxTierItem 
    {
        public string Label { get; set; }
        public string Value { get; set; }
        public string Note { get; set; }
        public string Type { get; set; } 
    }

    private void CalculateTax(double agrMM)
    {
        double agr = agrMM * 1_000_000;
        double supplementalTax = agr * 0.035;
        double baseRate = (agr < 75_000_000) ? 0.05 : 0.15;
        double taxableAGR = Math.Max(0, agr - 7_000_000);
        double freePlayDeduction = (agr > 7_000_000) ? 7_000_000 : agr;

        double bracketTax = 0;
        TaxBreakdown.Clear();

        string Fmt(double v) => "$" + v.ToString("N0");
        string FmtM(double v) => "$" + (v / 1_000_000).ToString("F1") + "MM";

        TaxBreakdown.Add(new TaxTierItem { Label = "Adjusted Gross Revenue (AGR)", Value = Fmt(agr), Type = "header" });
        TaxBreakdown.Add(new TaxTierItem { Label = "Supplemental Tax (3.5%)", Value = Fmt(supplementalTax), Note = "Off the top", Type = "add" });
        TaxBreakdown.Add(new TaxTierItem { Label = "Free Play Deduction", Value = Fmt(freePlayDeduction), Note = "First $7MM Exempt", Type = "info" });
        TaxBreakdown.Add(new TaxTierItem { Label = "Taxable AGR", Value = Fmt(taxableAGR), Note = "AGR - $7MM", Type = "sub-header" });

        double remaining = taxableAGR;
        // Tier 1
        double t1 = Math.Min(Math.Max(0, remaining), 25_000_000);
        double t1Tax = t1 * baseRate; bracketTax += t1Tax; remaining -= t1;
        TaxBreakdown.Add(new TaxTierItem { Label = $"Tier 1 ($0-$25MM) @ {(baseRate*100):F0}%", Value = Fmt(t1Tax), Note = $"on {FmtM(t1)}", Type = "add" });
        // Tier 2
        double t2 = Math.Min(Math.Max(0, remaining), 25_000_000);
        double t2Tax = t2 * 0.20; bracketTax += t2Tax; remaining -= t2;
        TaxBreakdown.Add(new TaxTierItem { Label = "Tier 2 ($25MM-$50MM) @ 20%", Value = Fmt(t2Tax), Note = $"on {FmtM(t2)}", Type = "add" });
        // Tier 3
        double t3 = Math.Min(Math.Max(0, remaining), 25_000_000);
        double t3Tax = t3 * 0.25; bracketTax += t3Tax; remaining -= t3;
        TaxBreakdown.Add(new TaxTierItem { Label = "Tier 3 ($50MM-$75MM) @ 25%", Value = Fmt(t3Tax), Note = $"on {FmtM(t3)}", Type = "add" });
        // Tier 4
        double t4 = Math.Min(Math.Max(0, remaining), 75_000_000);
        double t4Tax = t4 * 0.30; bracketTax += t4Tax; remaining -= t4;
        TaxBreakdown.Add(new TaxTierItem { Label = "Tier 4 ($75MM-$150MM) @ 30%", Value = Fmt(t4Tax), Note = $"on {FmtM(t4)}", Type = "add" });
        // Tier 5
        double t5 = Math.Min(Math.Max(0, remaining), 450_000_000);
        double t5Tax = t5 * 0.35; bracketTax += t5Tax; remaining -= t5;
        TaxBreakdown.Add(new TaxTierItem { Label = "Tier 5 ($150MM-$600MM) @ 35%", Value = Fmt(t5Tax), Note = $"on {FmtM(t5)}", Type = "add" });
        // Tier 6
        double t6 = Math.Max(0, remaining) * 0.40; bracketTax += t6;
        TaxBreakdown.Add(new TaxTierItem { Label = "Tier 6 (Over $600MM) @ 40%", Value = Fmt(t6), Note = $"on {FmtM(Math.Max(0, remaining))}", Type = "add" });

        double totalTax = supplementalTax + bracketTax;
        CalcTaxRevenue = totalTax / 1_000_000.0;
        CalcAGR = agrMM;
        
        TaxBreakdown.Add(new TaxTierItem { Label = "TOTAL ESTIMATED TAX", Value = Fmt(totalTax), Type = "total" });
        
        double effRate = agr > 0 ? (totalTax / agr) * 100 : 0;
        CalcEffectiveTaxRate = effRate;
        TaxBreakdown.Add(new TaxTierItem { Label = "Effective Tax Rate of AGR", Value = effRate.ToString("F2") + "%", Type = "eff-rate" });
    }

    private void OnAGRChange(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out double val)) 
        {
            InputAGR = val;
            CalculateTax(InputAGR);
            InputRevenue = CalcTaxRevenue;
            Recalculate();
        }
    }
    
    private void OnRevenueChange(ChangeEventArgs e) // Simplify Revenue driving for now
    {
         if (double.TryParse(e.Value?.ToString(), out double val)) 
         {
             InputRevenue = val;
             // Rough estimation (Tax is roughly 25%)
             InputAGR = val * 4.0; 
             CalculateTax(InputAGR);
             Recalculate();
         }
    }
    
    private void OnCountyChange(ChangeEventArgs e)
    {
        // Not used if custom UI
    }
    
    private void SelectCounty(CountyInfo c)
    {
         SelectedCountyId = c.Id;
         SelectedCountyName = c.Name;
         InputPopulation = c.Pop;
         Recalculate();
    }

    private void Recalculate()
    {
        CalculateTax(InputAGR);
        
        // Costs
        TotalCostHealth = ProjectedVictims * InputCostIllness / 1_000_000.0;
        TotalCostSocial = ProjectedVictims * InputCostServices / 1_000_000.0;
        TotalCostCrime = ProjectedVictims * InputCostCrime / 1_000_000.0;
        TotalCostLegal = ProjectedVictims * InputCostBankruptcy / 1_000_000.0;
        TotalCostAbused = ProjectedVictims * InputCostAbused / 1_000_000.0;
        TotalCostEmployment = ProjectedVictims * InputCostBusiness / 1_000_000.0;
        
        TotalCostPrivate = TotalCostAbused + TotalCostEmployment;
        TotalCostCombined = TotalCostHealth + TotalCostSocial + TotalCostCrime + TotalCostLegal + TotalCostPrivate;
        
        double totalRev = CalcTaxRevenue;
        AllocHumanitarianPool = totalRev * (InputAllocation / 100.0);
        AllocGeneralPool = totalRev * ((100 - InputAllocation) / 100.0);
        
        // Cost Coverage Calculations
        double healthAllocated = 0, healthSurplus = 0, healthUncovered = 0;
        
        if (AllocHumanitarianPool >= TotalCostHealth) 
        { 
            healthAllocated = TotalCostHealth; 
            healthSurplus = AllocHumanitarianPool - TotalCostHealth; 
            healthUncovered = 0;
        }
        else 
        { 
            healthAllocated = AllocHumanitarianPool; 
            healthSurplus = 0;
            healthUncovered = TotalCostHealth - AllocHumanitarianPool; 
        }
        
        // 1a. Humanitarian Row
        RevHealthHuman = AllocHumanitarianPool;
        CostHealthHuman = healthAllocated;
        NetHealthHuman = healthSurplus; 
        
        // Distribution of General Fund
        double burdenHealth = 0; // Policy: General Fund does not cover Health gaps in this model
        double totalGeneralBurden = TotalCostCrime + TotalCostSocial + TotalCostLegal;
        
        double revCrime = 0, revSocial = 0, revLegal = 0;
        if (totalGeneralBurden > 0)
        {
            revCrime = AllocGeneralPool * (TotalCostCrime / totalGeneralBurden);
            revSocial = AllocGeneralPool * (TotalCostSocial / totalGeneralBurden);
            revLegal = AllocGeneralPool * (TotalCostLegal / totalGeneralBurden);
        }
        else if (AllocGeneralPool > 0)
        {
             // If no burden, unallocated surplus?
             // For parity with JS, we don't assign it to specific departments if no cost.
             // But for balance sheet correctness, it should appear somewhere?
             // In JS logic, it just sits unallocated.
        }
        
        // 1b. Health (Taxpayer)
        RevHealthTax = 0; // No allocation
        CostHealthTax = healthUncovered;
        NetHealthTax = 0 - healthUncovered;
        
        NetHealthTotal = NetHealthHuman + NetHealthTax;
        
        // Subtotal Health
        SubHealthRev = RevHealthHuman + RevHealthTax;
        SubHealthCost = CostHealthHuman + CostHealthTax;
        SubHealthNet = NetHealthHuman + NetHealthTax;

        // General Fund Rows
        RevCrime = revCrime;
        NetCrime = revCrime - TotalCostCrime;
        
        RevSocial = revSocial;
        NetSocial = revSocial - TotalCostSocial; 
        
        RevLegal = revLegal;
        NetLegal = revLegal - TotalCostLegal;
        
        // Subtotal General
        SubGenRev = RevCrime + RevSocial + RevLegal;
        SubGenCost = TotalCostCrime + TotalCostSocial + TotalCostLegal;
        NetGenSub = NetCrime + NetSocial + NetLegal;

        // Total Public
        SubPublicRev = SubHealthRev + SubGenRev;
        SubPublicCost = SubHealthCost + SubGenCost;
        NetPublicSub = SubHealthNet + NetGenSub;
        
        // Private
        NetAbused = 0 - TotalCostAbused;
        NetEmployment = 0 - TotalCostEmployment;
        NetPrivateSub = NetAbused + NetEmployment;
        
        // Total
        NetTotalBalance = totalRev - TotalCostCombined;
        
        if (TotalCostCombined > 0) PercentCovered = Math.Min(100, (totalRev / TotalCostCombined) * 100); else PercentCovered = 100;
        
        GenerateAnalysisText();
        StateHasChanged();
    }
    
    private void GenerateAnalysisText()
    {
        var sb = new System.Text.StringBuilder();
        string FmtM(double v) => "$" + v.ToString("F1") + "MM";
        string AbsFmtM(double v) => "$" + Math.Abs(v).ToString("F1") + "MM";

        sb.Append($"<div class='font-bold text-white mb-2 uppercase tracking-wide text-sm underline'>Net Economic Impact Analysis</div>");
        sb.Append($"<ul class='list-disc pl-8 space-y-3 text-slate-300'>");
        sb.Append($"<li><strong class='text-white'>Sector Comparison:</strong> The Public Sector projected impact is a {AbsFmtM(NetPublicSub)} {(NetPublicSub >= 0 ? "surplus" : "deficit")}. In comparison, the Private Sector faces an unmitigated loss of {AbsFmtM(NetPrivateSub)}.</li>");
        if (NetTotalBalance < 0)
             sb.Append($"<li><strong class='text-white'>Fiscal Conclusion:</strong> The projected social costs exceed the direct tax revenue, resulting in a net fiscal deficit. Projected revenue ({FmtM(CalcTaxRevenue)}) is surpassed by social costs ({FmtM(TotalCostCombined)}), leaving a {AbsFmtM(NetTotalBalance)} net deficit.</li>");
        else
             sb.Append($"<li><strong class='text-white'>Fiscal Conclusion:</strong> The casino generates a net fiscal surplus of {FmtM(NetTotalBalance)}.</li>");
        sb.Append("</ul>");
        
        AnalysisText = (MarkupString)sb.ToString();
    }

    public void Dispose() { _objRef?.Dispose(); }
}
