@inject IJSRuntime JSRuntime
@inject HttpClient Http
@using SaveFW.Shared
@using SaveFW.Client.Pages

    <section class="bg-[#0f172a] py-24 relative overflow-hidden" id="economic-analysis">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">

            <!-- Economic Analysis Header -->
            <div class="mb-12 text-center max-w-4xl mx-auto" id="economic-analysis-header">
                <span class="text-blue-500 font-bold tracking-wider uppercase text-sm mb-2 block">Economic
                    Analysis</span>
                <h2 class="text-3xl font-black tracking-tight text-white sm:text-4xl">
                    ECONOMIC <span class="text-blue-500">IMPACT</span> CALCULATOR
                </h2>
                <p class="mt-4 text-xl italic text-slate-400 font-medium max-w-2xl mx-auto">
                    Interactive modeling of the social and financial impact on counties and states.
                </p>
            </div>

            <!-- Refactored Map Component -->
            <Map />

            <!-- Calculator Grid -->
            <div class="flex flex-col gap-12 mb-16">

            <!-- Controls Card -->
            <div id="calculator-controls"
                class="bg-slate-800 border border-slate-700 rounded-3xl p-4 sm:p-8 w-full shadow-sm">
                <h3 class="text-xl font-bold text-slate-300 dark:text-white mb-2">
                    <span class="material-symbols-outlined text-blue-500">tune</span>
                    Economic Inputs
                </h3>
                <div class="space-y-5">
                    <!-- County is selected through the Map component above -->
                    <!-- Simulator Trigger -->
                    <div class="-mb-8">
                        <button onclick="openSimulatorModal()"
                            class="w-full bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-blue-500/20 border border-blue-400/30 flex items-center justify-between group transition-all transform active:scale-95 mt-10">
                            <div class="flex items-center gap-3">
                                <div class="bg-white/20 p-2 rounded-lg">
                                    <span class="material-symbols-outlined text-white">science</span>
                                </div>
                                <div class="text-left">
                                    <div class="uppercase tracking-wide text-xs font-bold text-blue-100 mb-0.5">Quick
                                        Start</div>
                                    <div class="text-lg leading-none">Run Scenario Simulator</div>
                                </div>
                            </div>
                            <span
                                class="material-symbols-outlined group-hover:translate-x-1 transition-transform">arrow_forward</span>
                        </button>

                        <div class="relative flex py-8 items-center justify-center mt-10">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="w-full border-t border-slate-700"></div>
                            </div>
                            <div class="relative flex justify-center">
                                <button @onclick="ToggleManualControls" id="btn-manual-toggle"
                                    class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-2 px-6 rounded-full border border-purple-400/30 flex items-center gap-2 transition-all text-xs uppercase tracking-wider group shadow-lg active:scale-95">
                                    <span>Adjust Variables Manually</span>
                                    <span
                                        class="material-symbols-outlined group-hover:translate-y-1 transition-transform text-lg @(_manualControlsExpanded ? "rotate-180" : "")">expand_more</span>
                                </button>
                            </div>
                        </div>

                        <!-- Collapsible Manual Controls -->
                        <div id="manual-controls"
                            class="rounded-2xl px-4 sm:px-6 py-8 transition-all duration-500 ease-in-out @(_manualControlsExpanded ? "max-h-[8000px] opacity-100 overflow-visible" : "max-h-0 opacity-0 overflow-hidden")">
                        
                        <!-- AGR Input -->
                        <div class="border-b border-slate-700 pb-8">
                            <SliderInput Id="agr" Label="Adjusted Gross Revenue (AGR)" Value="112"
                                         MinValue="0" MaxValue="1000" Step="1"
                                         InputType="MoneyMM" DecimalPlaces="2"
                                         MajorTickInterval="200" MinorTickInterval="50"
                                         MarkerColor="green"
                                         Tooltip="Total gambling losses from all players, before taxes and expenses."
                                         Markers='@(new List<SliderMarker> { new() { Label="Default", Value=112, TooltipDescription="Spectrum Gaming Projection" } })' />

                            <!-- Tax Details (Always Visible) -->
                            <div id="tax-details-container"
                                class="bg-slate-900/80 rounded-lg p-4 mt-20 text-sm font-mono text-slate-300 border border-slate-700 shadow-inner">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Revenue Input -->
                        <div class="border-b border-slate-700 pb-8 mt-8">
                            <SliderInput Id="revenue" Label="Tax Revenue" Value="27.5"
                                         MinValue="0" MaxValue="400" Step="0.5"
                                         InputType="MoneyMM" DecimalPlaces="2"
                                         MajorTickInterval="100" MinorTickInterval="25"
                                         MarkerColor="green"
                                         Tooltip="The portion of AGR collected by the state and local government."
                                         Markers='@(new List<SliderMarker> { new() { Label="Default", Value=27.5, TooltipDescription="Spectrum Gaming Projection" } })' />
                        </div>

                        <!-- Revenue Allocation Control -->
                        <div class="pt-6">
                            <div class="flex flex-col mb-3 mt-10">
                                <label class="text-base font-bold text-white">Tax Revenue Allocation</label>
                                <p class="text-sm text-slate-400 italic">
                                    Drag to adjust the split between the Humanitarian Fund and General Taxpayer
                                    Services.
                                </p>
                            </div>

                            <!-- Visual Bar / Slider Wrapper -->
                            <div
                                class="relative h-10 w-full rounded-xl overflow-hidden cursor-pointer group shadow-inner border border-slate-600">
                                <!-- Backgrounds -->
                                <div class="absolute inset-0 flex">
                                    <div id="alloc-bar-human"
                                        class="h-full bg-purple-600 transition-all duration-75 flex items-center pl-3 overflow-hidden"
                                        style="width: 40%">
                                        <span
                                            class="text-xs sm:text-sm font-bold text-white whitespace-nowrap drop-shadow-md">Humanitarian</span>
                                    </div>
                                    <div id="alloc-bar-taxpayer"
                                        class="h-full bg-emerald-600 transition-all duration-75 flex items-center justify-end pr-3 overflow-hidden"
                                        style="width: 60%">
                                        <span
                                            class="text-xs sm:text-sm font-bold text-white whitespace-nowrap drop-shadow-md">Taxpayer
                                            Services</span>
                                    </div>
                                </div>

                                <!-- Percentage Overlay (Centered) -->
                                <div
                                    class="absolute inset-0 flex justify-center items-center pointer-events-none gap-4">
                                    <div class="bg-slate-900/80 px-2 py-1 rounded text-sm font-mono font-bold text-purple-300 border border-purple-500/30"
                                        id="alloc-text-human">40%</div>
                                    <div class="bg-slate-900/80 px-2 py-1 rounded text-sm font-mono font-bold text-emerald-300 border border-emerald-500/30"
                                        id="alloc-text-taxpayer">60%</div>
                                </div>

                                <!-- Hidden Range Input -->
                                <input type="range" min="0" max="100" step="1" value="40" id="input-allocation"
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-ew-resize z-20"
                                    aria-label="Revenue Allocation">
                            </div>
                        </div>

                        <!-- Social Cost Input -->
                        <div class="pb-10">
                            <div class="mb-4 mt-10">
                                <label class="text-base font-bold text-white block mb-2">Social Cost
                                    Variables (Per Problem Gambler)</label>
                                <div class="flex justify-between items-baseline mb-2 bg-slate-800 p-2 rounded-lg">
                                    <span class="text-sm font-bold text-slate-500 uppercase">Total Cost</span>
                                    <span class="text-red-500 font-bold font-mono text-lg"
                                        id="val-cost-total">$13,203</span>
                                </div>
                                <p class="text-sm text-slate-400 italic mb-4">Default values based on Grinols (2011)
                                    ($9,393) adjusted for 2025 inflation ($13,205).</p>
                            </div>

                            <div class="space-y-12 pl-2">
                                <SliderInput Id="cost-crime" Label="Crime Costs" Value="1625" 
                                             MinValue="0" MaxValue="10000" Step="1"
                                             InputType="Currency" DecimalPlaces="0"
                                             MajorTickInterval="2000" MinorTickInterval="500"
                                             Tooltip="Includes costs for police, adjudication, and incarceration related to gambling-induced crime." 
                                             Markers='@(new List<SliderMarker> { new() { Label="Default", Value=1625, TooltipDescription="This is the inflation-adjusted default value based on Grinols (2011)." } })' />

                                <SliderInput Id="cost-business" Label="Lost Employment" Value="4051" 
                                             MinValue="0" MaxValue="10000" Step="1"
                                             InputType="Currency" DecimalPlaces="0"
                                             MajorTickInterval="2000" MinorTickInterval="500"
                                             Tooltip="Economic losses due to lost productivity, absenteeism, and unemployment." 
                                             Markers='@(new List<SliderMarker> { new() { Label="Default", Value=4051, TooltipDescription="This is the inflation-adjusted default value based on Grinols (2011)." } })' />

                                <SliderInput Id="cost-bankruptcy" Label="Bankruptcy" Value="431" 
                                             MinValue="0" MaxValue="10000" Step="1"
                                             InputType="Currency" DecimalPlaces="0"
                                             MajorTickInterval="2000" MinorTickInterval="500"
                                             Tooltip="Legal costs and resource drain associated with filings, debts, and civil proceedings." 
                                             Markers='@(new List<SliderMarker> { new() { Label="Default", Value=431, TooltipDescription="This is the inflation-adjusted default value based on Grinols (2011)." } })' />

                                <SliderInput Id="cost-illness" Label="Illness" Value="1328" 
                                             MinValue="0" MaxValue="10000" Step="1"
                                             InputType="Currency" DecimalPlaces="0"
                                             MajorTickInterval="2000" MinorTickInterval="500"
                                             Tooltip="Healthcare costs for treating stress-related disorders, depression, and anxiety." 
                                             Markers='@(new List<SliderMarker> { new() { Label="Default", Value=1328, TooltipDescription="This is the inflation-adjusted default value based on Grinols (2011)." } })' />

                                <SliderInput Id="cost-services" Label="Social Services" Value="713" 
                                             MinValue="0" MaxValue="10000" Step="1"
                                             InputType="Currency" DecimalPlaces="0"
                                             MajorTickInterval="2000" MinorTickInterval="500"
                                             Tooltip="Public costs for unemployment benefits, welfare programs, and social safety nets." 
                                             Markers='@(new List<SliderMarker> { new() { Label="Default", Value=713, TooltipDescription="This is the inflation-adjusted default value based on Grinols (2011)." } })' />

                                <SliderInput Id="cost-abused" Label="Abused Dollars" Value="5055" 
                                             MinValue="0" MaxValue="10000" Step="1"
                                             InputType="Currency" DecimalPlaces="0"
                                             MajorTickInterval="2000" MinorTickInterval="500"
                                             Tooltip="Financial impact of 'borrowed' or stolen family funds, plus divorce and domestic instability costs." 
                                             Markers='@(new List<SliderMarker> { new() { Label="Default", Value=5055, TooltipDescription="This is the inflation-adjusted default value based on Grinols (2011)." } })' />
                            </div>

                            <!-- Tax Revenue Calculation -->
                            <div
                                class="mt-20 mb-6 relative z-10 bg-slate-900/50 rounded-xl p-4 border border-slate-600">
                                <div
                                    class="text-xs text-slate-400 uppercase tracking-widest font-bold mb-4 text-center">
                                    Tax Revenue Calculation</div>
	                                        <div
	                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
	                                            <div class="flex flex-col items-center">
	                                                <span
                                            class="text-slate-500 uppercase font-bold mb-1 text-center">Adjusted
                                            Gross Revenue</span>
                                        <span class="text-white font-mono font-bold" id="calc-agr">-</span>
                                    </div>
                                    <div class="text-slate-500 font-bold mb-3">×</div>
                                    <div class="flex flex-col items-center">
                                        <span
                                            class="text-slate-500 uppercase font-bold mb-1 text-center">Effective
                                            Tax Rate</span>
                                        <span class="text-white font-mono font-bold" id="calc-tax-rate">-</span>
                                    </div>
                                    <div class="text-slate-500 font-bold mb-3">=</div>
                                    <div class="flex flex-col items-center">
                                        <span class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                            Estimated Tax Revenue</span>
                                        <span class="text-white font-mono font-bold" id="calc-tax-total">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Tax Revenue Allocation Calculation -->
                            <div
                                class="mb-6 relative z-10 bg-slate-900/50 rounded-xl p-4 border border-slate-600 space-y-8">
                                <!-- Humanitarian -->
                                <div>
                                    <div
                                        class="text-xs text-slate-400 uppercase tracking-widest font-bold mb-4 text-center">
                                        Humanitarian Fund Allocation</div>
                                    <div
                                        class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                        <div class="flex flex-col items-center">
                                            <span
                                                class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                Tax Revenue</span>
                                            <span class="text-white font-mono font-bold" id="calc-rev-total-h">-</span>
                                        </div>
                                        <div class="text-slate-500 font-bold mb-3">×</div>
                                        <div class="flex flex-col items-center">
                                            <span
                                                class="text-slate-500 uppercase font-bold mb-1 text-center">Allocation
                                                Percentage</span>
                                            <span class="text-white font-mono font-bold" id="calc-alloc-pct-h">-</span>
                                        </div>
                                        <div class="text-slate-500 font-bold mb-3">=</div>
                                        <div class="flex flex-col items-center">
                                            <span
                                                class="text-slate-500 uppercase font-bold mb-1 text-center">Humanitarian
                                                Fund Total</span>
                                            <span class="text-white font-mono font-bold"
                                                id="calc-alloc-human-val">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- General -->
                                <div class="border-t border-slate-700 pt-8">
                                    <div
                                        class="text-xs text-slate-400 uppercase tracking-widest font-bold mb-4 text-center">
                                        General Fund Allocation</div>
                                    <div
                                        class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                        <div class="flex flex-col items-center">
                                            <span
                                                class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                Tax Revenue</span>
                                            <span class="text-white font-mono font-bold" id="calc-rev-total-g">-</span>
                                        </div>
                                        <div class="text-slate-500 font-bold mb-3">×</div>
                                        <div class="flex flex-col items-center">
                                            <span
                                                class="text-slate-500 uppercase font-bold mb-1 text-center">Allocation
                                                Percentage</span>
                                            <span class="text-white font-mono font-bold" id="calc-alloc-pct-g">-</span>
                                        </div>
                                        <div class="text-slate-500 font-bold mb-3">=</div>
                                        <div class="flex flex-col items-center">
                                            <span
                                                class="text-slate-500 uppercase font-bold mb-1 text-center">General
                                                Fund Total</span>
                                            <span class="text-white font-mono font-bold"
                                                id="calc-alloc-gen-val">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Calculation Breakdown -->
                            <div class="mb-6 relative z-10 bg-slate-900/50 rounded-xl p-4 border border-slate-600">
                                <div
                                    class="text-xs text-slate-400 uppercase tracking-widest font-bold mb-4 text-center">
                                    Problem Gambler Calculation</div>
                                <div
                                    class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                    <div class="flex flex-col items-center">
                                        <span class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                            Population</span>
                                        <span class="text-white font-mono font-bold" id="calc-pop">-</span>
                                    </div>
                                    <div class="text-slate-500 font-bold mb-3">×</div>
                                    <div class="flex flex-col items-center">
                                        <span
                                            class="text-slate-500 uppercase font-bold mb-1 text-center">Effective
                                            Rate</span>
                                        <span class="text-white font-mono font-bold" id="calc-rate">-</span>
                                    </div>
                                    <div class="text-slate-500 font-bold mb-3">=</div>
                                    <div class="flex flex-col items-center">
                                        <span class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                            Problem Gamblers</span>
                                        <span class="text-white font-mono font-bold" id="calc-result">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Social Cost Breakdown -->
                            <div id="detailed-breakdown-empty-state" class="p-8 text-center bg-slate-800/30 rounded-xl border border-dashed border-slate-700 mb-8">
                                <p class="text-slate-500 text-sm italic">
                                    Breakdown details will be populated once a location is selected.
                                </p>
                            </div>

                            <div id="detailed-breakdown-content" class="hidden mb-8 relative z-10 bg-slate-900/50 rounded-xl p-4 border border-slate-600">
                                <div
                                    class="text-sm text-slate-400 uppercase tracking-widest font-bold mb-4 text-center">
                                    Detailed Social Cost Breakdown — Subject County
                                </div>

                                <div class="space-y-6 mb-8">
                                    <!-- 1. Public Health -->
                                    <div>
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Public
                                            Health (Humanitarian Fund)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-health-victims">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-health-per">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-health-total">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 2. Social Services -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Social
                                            Services (Welfare, Unemployment)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-social-victims">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-social-per">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-social-total">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 3. Criminal Justice -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Law
                                            Enforcement (Police, Courts, Jail)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-crime-victims">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-crime-per">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-crime-total">-</span>
                                            </div>
                                        </div>
	                                    </div>

                                    <!-- 4. Civil Legal -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Civil
                                            Legal (Courts, Bankruptcy)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-legal-victims">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-legal-per">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-legal-total">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 5. Abused Dollars -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Abused
                                            Dollars (Household Loss)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-abused-victims">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-abused-per">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-abused-total">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 6. Lost Employment -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Lost
                                            Employment (Productivity)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-employment-victims">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-employment-per">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-employment-total">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 7. Total Social Cost -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Total
                                            Social Cost</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-break-total-victims">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-total-cost-per">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-3">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-white font-mono font-bold"
                                                    id="calc-total-cost-combined">-</span>
                                            </div>
                                        </div>
                                    </div>
	                            </div>

                                <div
                                    class="text-sm text-slate-400 uppercase tracking-widest font-bold mb-4 text-center">
                                    Detailed Social Cost Breakdown — Other Counties (Same State, ≤50 mi)
                                </div>

                                <div class="space-y-6">
                                    <!-- 1. Public Health -->
                                    <div>
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Public
                                            Health (Humanitarian Fund)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-health-victims-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-health-per-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-health-total-other">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 2. Social Services -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Social
                                            Services (Welfare, Unemployment)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-social-victims-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-social-per-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-social-total-other">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 3. Criminal Justice -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Law
                                            Enforcement (Police, Courts, Jail)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-crime-victims-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-crime-per-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-crime-total-other">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 4. Civil Legal -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Civil
                                            Legal (Courts, Bankruptcy)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-legal-victims-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-legal-per-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-legal-total-other">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 5. Abused Dollars -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Abused
                                            Dollars (Household Loss)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-abused-victims-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-abused-per-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-abused-total-other">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 6. Lost Employment -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Lost
                                            Employment (Productivity)</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-employment-victims-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-employment-per-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-employment-total-other">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 7. Total Social Cost -->
                                    <div class="border-t border-slate-700/50 pt-4">
                                        <div class="text-slate-500 uppercase font-bold mb-2 text-center">Total
                                            Social Cost</div>
                                        <div
                                            class="grid grid-cols-[1fr_auto_1fr_auto_1fr] gap-2 items-center text-xs">
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">New
                                                    Problem Gamblers</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-break-total-victims-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">×</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Cost/Problem
                                                    Gambler</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-total-cost-per-other">-</span>
                                            </div>
                                            <div class="text-slate-500 font-bold mb-2">=</div>
                                            <div class="flex flex-col items-center">
                                                <span
                                                    class="text-slate-500 uppercase font-bold mb-1 text-center">Total
                                                    Cost</span>
                                                <span class="text-slate-200 font-mono font-bold"
                                                    id="calc-total-cost-combined-other">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- County Selection -->

            </div> <!-- Close manual-controls -->
        </div> <!-- Close -mb-8 -->
    </div> <!-- Close space-y-5 -->
</div> <!-- Close calculator-controls -->

            <!-- Results Card -->
            <div class="space-y-6">
                <div
                    class="bg-slate-800 rounded-3xl p-4 sm:p-8 border border-slate-700 shadow-2xl relative overflow-hidden flex flex-col justify-center">
                    <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-red-500/10 rounded-full blur-3xl">
                    </div>

                    <div class="flex justify-between items-center mb-2 relative z-50">
                        <h3 class="text-xl font-bold text-slate-300 dark:text-white" id="deficit-title">
                            <span class="material-symbols-outlined text-blue-500">calculate</span>
                            Deficit Calculation
                        </h3>
                        <button id="btn-generate-pdf" @onclick="GeneratePdf" 
                                class="bg-red-600 hover:bg-red-500 text-white p-2 rounded-lg shadow-md transition-all transform active:scale-95 border border-red-400/20 flex items-center justify-center w-10 h-10 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-slate-600 disabled:hover:bg-slate-600 disabled:shadow-none disabled:active:scale-100" 
                                title="Download PDF Report"
                                disabled="@_isGeneratingPdf">
                            @if (_isGeneratingPdf)
                            {
                                <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                            }
                            else
                            {
                                <span class="material-symbols-outlined text-2xl">picture_as_pdf</span>
                            }
                        </button>
                    </div>



                    <!-- Split Balance Sheet -->
                    <div class="relative z-10 bg-slate-900/50 rounded-2xl p-6 border border-slate-600 mb-6 font-sans">
                        
                        <!-- Net Economic Impact Table Structure -->
                        <div id="net-impact-empty-state" class="flex flex-col items-center justify-center py-12 text-center">
                            <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700/50 max-w-md mx-auto">
                                <span class="material-symbols-outlined text-slate-500 text-4xl mb-3">map_search</span>
                                <h4 class="text-slate-300 font-bold mb-2">Analysis Pending Location Selection</h4>
                                <p class="text-slate-400 text-sm mb-6">
                                    Please select a county on the map above to initialize the Net Economic Impact Analysis model.
                                </p>
                                <button onclick="document.getElementById('impact-map').scrollIntoView({ behavior: 'smooth', block: 'center' })"
                                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-lg shadow-blue-500/20 text-sm flex items-center justify-center gap-2 mx-auto">
                                    <span class="material-symbols-outlined text-[18px]">location_on</span>
                                    Select Location on Map
                                </button>
                            </div>
                        </div>

                        <div id="net-impact-content" class="hidden">
                            <div class="text-sm text-slate-200 uppercase tracking-widest font-bold mb-2 text-center">
                                Net Economic Impact
                            </div>

                            <p class="text-sm text-slate-400 leading-relaxed mb-6 px-4 text-left">
                                Tax revenue is allocated based on a tiered prioritization model. The Humanitarian Fund exclusively targets Public
                                Health liabilities (addiction and mental health). The General Fund is distributed pro-rata among Law
                                Enforcement, Social Services, and Civil Legal based on their relative share of the total
                                public sector burden. Private sector economic
                                losses (Abused Dollars and Lost Employment) receive zero direct tax revenue offset in this
                                analysis.
                            </p>

                            <div class="overflow-x-auto rounded-xl border border-slate-700 bg-slate-950/40">
                                <div id="net-impact-table" class="min-w-max">
                                    <div class="p-4 text-sm text-slate-500 italic text-center">
                                        Select a county on the map to see cost distribution.
                                    </div>
                                </div>
                            </div>
                            <p class="mt-2 text-[11px] text-slate-500 italic text-left" id="net-impact-note"></p>

		                        <!-- Progress Bar -->
		                        <div class="relative z-10 mt-8 mb-4">
	                            <div class="flex justify-between text-base font-bold mb-2">
	                                <span class="text-emerald-500">Revenue Covered</span>
                                <span class="text-red-500">Uncovered Cost</span>
                            </div>
                            <div class="w-full bg-red-500/60 rounded-full h-4 overflow-hidden border border-slate-700">
                                <div class="bg-emerald-500 h-full transition-all duration-500" style="width: 35%"
                                    id="res-bar"></div>
                            </div>
                            <p class="mt-4 text-center text-base text-slate-300 italic" id="res-footer">
                                Tax Revenue covers only <strong class="text-white text-lg">35%</strong> of social costs.
                            </p>
                        </div>

                        <!-- Programmatic Analysis & Disclaimer -->
                        <div class="mt-6 pt-4 border-t border-slate-700">
                            <div id="analysis-empty-state" class="p-8 text-center bg-slate-800/30 rounded-xl border border-dashed border-slate-700">
                                <p class="text-slate-500 text-sm italic">
                                    Summary analysis will be generated once a location is selected.
                                </p>
                            </div>

                            <div id="analysis-content" class="hidden rounded-lg p-4 mb-4">
                                <h5
                                    class="text-white font-bold uppercase tracking-wider mb-2 flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined">analytics</span>
                                    SaveFW's Economic Impact Analysis
                                </h5>
                                <p class="text-slate-300 leading-relaxed" id="analysis-text">
                                    <!-- Populated by JS -->
                                </p>
                            </div>
                        </div>
                    </div>


        <!--
            <div class="mt-12 bg-slate-800 border border-slate-700 rounded-3xl p-4 sm:p-8 shadow-sm">
                <h4 class="font-bold text-white text-lg mb-6 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">table_chart</span>
                    SaveFW's Estimated Analysis
                </h4>
                <div class="overflow-x-auto rounded-xl border border-slate-700">
                    <table class="w-full text-sm text-left">
                        <thead
                            class="bg-slate-950 text-slate-300 uppercase text-xs font-bold border-b border-slate-700">
                            <tr>
                                <th class="px-6 py-4">Projection Model</th>
                                <th class="px-6 py-4 text-center">New Problem Gamblers</th>
                                <th class="px-6 py-4 text-center">Annual Social Cost</th>
                                <th class="px-6 py-4 text-right">Net Annual Deficit</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700 bg-slate-800">
                            <tr class="hover:bg-slate-700/50 transition-colors">
                                <td class="px-6 py-4 font-bold text-white">Low End Estimate</td>
                                <td class="px-6 py-4 text-center font-mono text-white">5,872
                                </td>
                                <td class="px-6 py-4 text-center font-mono text-red-500">$77.5 Million</td>
                                <td class="px-6 py-4 text-right font-black text-red-600 font-mono">-$50.0 Million
                                </td>
                            </tr>
                            <tr class="hover:bg-slate-700/50 transition-colors">
                                <td class="px-6 py-4 font-bold text-white">High End Estimate
                                </td>
                                <td class="px-6 py-4 text-center font-mono text-white">
                                    12,918
                                </td>
                                <td class="px-6 py-4 text-center font-mono text-red-500">$170.5 Million</td>
                                <td class="px-6 py-4 text-right font-black text-red-600 font-mono">-$143.0 Million
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p class="mt-4 text-xs text-slate-400 text-center">
                    Based on local population (391,449), problem gambling rates of 1.5% to 3.3% within 20 miles of a
                    casino, and social costs adjusted for inflation.
                </p>
            </div>
            -->
        <!-- End Table -->
                </div>
            </div>


        </div> <!-- Close Calculator Grid -->
    </div> <!-- Close mx-auto container -->

        <!-- PART II: THE MYTH OF NET GROWTH (Moved Here) -->
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-24 border-t border-slate-700 pt-24">
            <!-- Header -->
            <div class="mb-12 text-center" id="economic-analysis-part-2">
                <span class="text-blue-500 font-bold tracking-wider uppercase text-base">Economic Analysis - Part
                    II</span>
                <h2 class="mt-2 text-3xl font-black tracking-tight text-white sm:text-5xl leading-tight">
                    THE MYTH OF <br><span class="text-blue-500">NET GROWTH</span>
                </h2>
                <div class="mt-4 text-xl italic text-slate-400 leading-relaxed">
                    <p>
                        The primary economic argument for the Fort Wayne casino is that it will generate "new" money.
                        This assumes it functions as a tourist destination. However, in markets lacking high-density
                        attractions, casinos operate as <strong>"convenience gambling"</strong> venues, leading to the
                        <strong>Substitution Effect</strong>.
                    </p>
                </div>
            </div>

            <div
                class="mb-16 bg-slate-800 shadow-lg rounded-3xl border border-slate-700 p-6 sm:p-8 backdrop-blur-sm relative overflow-hidden">
                <div class="text-left relative z-10">
                    <h4 class="text-white font-bold mb-4 flex items-center gap-2 text-xl">
                        <span class="material-symbols-outlined text-blue-500 text-3xl">analytics</span>
                        Evidence: Spectrum Study (2025)
                    </h4>
                    <p class="mb-4 text-slate-400">
                        A critical analysis of the Spectrum Study (2025) provides the most definitive evidence against
                        the "Economic Engine" narrative. The study's own data admits that for a Northeast Indiana
                        location, <strong>nearly 95% of the revenue is expected to come from the "core market-catchment
                            area" (residents within 90 minutes)</strong>. This statistic mathematically disproves the
                        "tourism" argument. If 95% of the money originates from local pockets, there is no "New Money"
                        being introduced; it is purely a <strong>wealth transfer</strong> from Fort Wayne families to a
                        corporate entity, with the city retaining only a small "convenience fee" in the form of tax
                        revenue.
                    </p>

                    <h4 class="text-white font-bold mt-6 mb-4 flex items-center gap-2 text-xl">
                        <span class="material-symbols-outlined text-red-500 text-3xl">block</span>
                        Market Saturation & Competitive Landscape
                    </h4>
                    <p class="mb-4 text-slate-400">
                        To function as a genuine destination, a venue must offer a unique value proposition that
                        transcends local alternatives. However, the Northeast Indiana market is already saturated by
                        established competitors:
                    </p>
                    <ul class="list-disc pl-5 space-y-2 mb-6 text-slate-400">
                        <li><strong>South Bend:</strong> Four Winds</li>
                        <li><strong>Toledo:</strong> Hollywood Casino</li>
                        <li><strong>Battle Creek:</strong> FireKeepers</li>
                        <li><strong>Indianapolis:</strong> Horseshoe (Shelbyville)</li>
                    </ul>
                    <p class="font-bold text-white border-l-4 border-blue-500 pl-4 py-1">
                        Conclusion: Given the proximity of these established gaming centers, a standard regional casino
                        lacks the requisite differentiation to attract significant external tourism, as potential
                        visitors are already served by closer facilities.
                    </p>
                </div>
            </div>

            <!-- Interactive Substitution Visualizer -->
            <div
                class="mb-16 bg-slate-800 shadow-lg rounded-3xl border border-slate-700 p-4 sm:p-8 backdrop-blur-sm relative overflow-hidden">
                <!-- Background accent -->
                <div class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl p-6">
                </div>

                <div class="text-center mb-10 relative z-10">

                    <h3 class="text-2xl font-bold text-white flex items-center justify-center gap-3">
                        <span class="material-symbols-outlined text-emerald-400 text-3xl">account_balance_wallet</span>
                        Household Discretionary Budget: $500/mo
                    </h3>
                    <p class="text-slate-400 text-base mt-3 max-w-2xl mx-auto">
                        See how the local economy suffers when spending shifts. The total household budget for
                        entertainment is fixed.
                        When a casino enters, it doesn't create new money; it eats into existing categories.
                    </p>
                </div>

                <div class="grid md:grid-cols-2 gap-12 items-center relative z-10">
                    <!-- Before -->
                    <div class="flex flex-col items-center">
                        <h4 class="text-white font-bold mb-6 flex items-center gap-2">
                            <span class="bg-slate-700 text-slate-200 text-sm px-2 py-1 rounded">Current State</span>
                            Before Casino
                        </h4>
                        <div class="w-64 h-64 relative">
                            <canvas id="chartBefore"></canvas>
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-base font-medium text-emerald-400">100% Local Circulation</p>
                            <p class="text-sm text-slate-500 mt-1">Money recirculates 5-7 times in the local economy.
                            </p>
                        </div>
                    </div>

                    <!-- After -->
                    <div class="flex flex-col items-center relative">
                        <h4 class="text-white font-bold mb-6 flex items-center gap-2">
                            <span
                                class="bg-red-900/30 text-red-400 text-sm px-2 py-1 rounded border border-red-900/50">Future
                                State</span>
                            After Casino
                        </h4>

                        <div class="w-64 h-64 relative">
                            <canvas id="chartAfter"></canvas>
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-base font-medium text-red-400">25-30% Wealth Extraction</p>
                            <p class="text-sm text-slate-500 mt-1">Casino profits are exported to external investors.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div
                    class="mt-10 flex flex-wrap justify-center gap-6 text-sm font-medium text-slate-400 border-t border-slate-700/50 pt-6">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-[#3b82f6]"></div> Retail (Clothes, Hobbies)
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-[#8b5cf6]"></div> Dining & Restaurants
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-[#10b981]"></div> Local Entertainment
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-[#f97316]"></div> Savings
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-[#ef4444]"></div> Casino Loss
                    </div>
                </div>
            </div>

            <!-- Chart.js and Logic -->
            <div class="grid lg:grid-cols-2 gap-8 items-start">
                <!-- Left Column: The Data -->
                <div>
                    <!-- Substitution Effect Card -->
                    <div class="bg-slate-800 shadow-lg rounded-3xl border border-slate-700 p-8 backdrop-blur-sm h-full">
                        <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                            <span class="material-symbols-outlined text-blue-500">sync_problem</span>
                            Mechanics of the Substitution Effect
                        </h3>
                        <p class="text-slate-400 mb-6 leading-relaxed">
                            For a casino to generate net growth, it must function as an "export" industry—bringing
                            in
                            outside dollars. If it merely recirculates local capital, the net impact is neutral or
                            negative.
                            <br><br>
                            Research by the <strong>Federal Reserve Bank of St. Louis</strong> notes that in
                            mid-sized urban
                            areas, casinos often correlate with a <em>stagnation or decrease</em> in local retail
                            sales. The
                            casino acts as a gravitational well, absorbing liquidity that formerly supported small
                            businesses.
                        </p>

                        <!-- Data Callout -->
                        <div class="bg-red-900/20 border-l-4 border-red-500 p-6 rounded-r-xl mb-8">
                            <h4 class="text-lg font-bold text-red-500 mb-2">"243" Coefficient</h4>
                            <p class="text-slate-300 text-base">
                                For every <strong>$1,000 increase</strong> in casino revenue, businesses within a
                                10-30 mile
                                radius experience a <strong>loss of approximately $243</strong> in sales.
                            </p>
                        </div>

                        <!-- Displacement Table -->
                        <div class="overflow-x-auto rounded-xl border border-slate-700">
                            <table class="w-full text-left text-base text-slate-400">
                                <thead class="bg-slate-900 text-slate-300 uppercase font-bold text-sm">
                                    <tr>
                                        <th class="px-6 py-4">Metric</th>
                                        <th class="px-6 py-4">Value</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-700 bg-slate-800">
                                    <tr>
                                        <td class="px-6 py-4 font-medium text-white">Projected Casino AGR</td>
                                        <td class="px-6 py-4 text-emerald-400 font-bold">$204.3M</td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 font-medium text-white">Displacement Coefficient</td>
                                        <td class="px-6 py-4 text-orange-400 font-bold">24.3%</td>
                                    </tr>
                                    <tr class="bg-red-900/10">
                                        <td class="px-6 py-4 font-bold text-white">Projected Local Loss</td>
                                        <td class="px-6 py-4 text-red-500 font-black">($49.6M)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column: The Context -->
                <div class="space-y-6">
                    <!-- Factory vs Restaurant -->
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div class="bg-slate-800 shadow-sm p-6 rounded-3xl border-l-4 border-red-500">
                            <div class="text-red-500 font-bold uppercase tracking-widest text-sm mb-2">Fallacy
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">"Economic Development"</h3>
                            <p class="text-slate-400 text-sm leading-relaxed">
                                Proponents claim the casino expands the economic pie, ignoring the reality of
                                convenience gaming.
                            </p>
                        </div>
                        <div class="bg-slate-800 shadow-sm p-6 rounded-3xl border-l-4 border-emerald-500">
                            <div class="text-emerald-500 font-bold uppercase tracking-widest text-sm mb-2">The
                                Reality</div>
                            <h3 class="text-lg font-bold text-white mb-2">Factory vs. Restaurant</h3>
                            <p class="text-slate-400 text-sm leading-relaxed">
                                A local casino merely competes for the <strong>existing pool</strong> of
                                entertainment dollars like a restaurant.
                            </p>
                        </div>
                    </div>

                    <!-- Recession Risk -->
                    <div class="bg-slate-800 shadow-sm rounded-3xl p-8 border-l-4 border-yellow-500">
                        <h3 class="text-xl font-bold text-white mb-2">Recessionary Vulnerability</h3>
                        <p class="text-slate-400 text-base mb-4 leading-relaxed">
                            During the 2007-2012 Recession, retail sales in casino-hosting economies <strong>grew 3x
                                slower</strong> (2.4%) than in non-casino economies (8.6%).
                        </p>
                        <p class="text-white italic font-medium text-base">
                            "Introducing a casino introduces a structural weakness apparent during recession."
                        </p>
                    </div>

                    <!-- Economic Monoculture -->
                    <div class="bg-slate-800 shadow-sm rounded-3xl p-8 border-l-4 border-blue-500">
                        <h3 class="text-xl font-bold text-white mb-2">Economic Monoculture</h3>

                        <p class="text-slate-400 text-base leading-relaxed">
                            The casino acts as an invasive species, displacing diverse local businesses and creating
                            a <strong>single point of failure</strong>.
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </section>

<EconomicModals />
@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(500); // Wait for DOM
            try { await JSRuntime.InvokeVoidAsync("window.EconomicCalculator.init"); } catch (Exception e) { Console.WriteLine($"Calc Init: {e.Message}"); }
            try { await JSRuntime.InvokeVoidAsync("window.initSubstitutionCharts"); } catch (Exception e) { Console.WriteLine($"Chart Init: {e.Message}"); }
        }
    }
    // Helpers for safety, though HTML controls logic
    private string FmtM(double val) { return "$" + (val / 1_000_000).ToString("F1") + "MM"; }
    private string FmtDiff(double val) { return (val >= 0 ? "+$" : "-$") + Math.Abs(val / 1_000_000).ToString("F1") + "MM"; }
    private string NetClass(double val) { return val >= 0 ? "text-emerald-400" : "text-red-500"; }
    
    private bool _manualControlsExpanded = false;
    private void ToggleManualControls() => _manualControlsExpanded = !_manualControlsExpanded;

    private bool _isGeneratingPdf = false;

    private async Task GeneratePdf()
    {
        if (_isGeneratingPdf) return;
        _isGeneratingPdf = true;
        StateHasChanged();

        try 
        {
            // 1. Capture Map Image
            var base64Map = await JSRuntime.InvokeAsync<string>("window.PdfHelper.captureMapAndGenerate", "impact-map");
            
            // 2. Scrape Data
            var data = await JSRuntime.InvokeAsync<ReportDataScraped>("window.PdfHelper.getReportData");
            
            if (data == null) data = new ReportDataScraped();

            // 3. Send to Server
            var request = new 
            {
                MapImageBase64 = base64Map,
                AnalysisText = data.AnalysisText,
                MainTable = data.MainTable,
                BreakdownTable = data.BreakdownTable,
                BreakdownOtherTable = data.BreakdownOtherTable,
                SubjectCountyName = data.SubjectCountyName
            };
            
            var response = await Http.PostAsJsonAsync("api/report/generate", request);
            
            if (response.IsSuccessStatusCode)
            {
                var fileStream = await response.Content.ReadAsStreamAsync();
                using var streamRef = new DotNetStreamReference(fileStream);
                await JSRuntime.InvokeVoidAsync("window.PdfHelper.downloadFileFromStream", "SaveFW_Analysis.pdf", streamRef);
            }
            else
            {
                Console.WriteLine("PDF Generation failed: " + response.StatusCode);
            }
        }
        catch (Exception ex)
        {
             Console.WriteLine($"PDF Error: {ex.Message}");
        }
        finally
        {
            _isGeneratingPdf = false;
            StateHasChanged();
        }
    }

    public class ReportDataScraped 
    {
        public string? SubjectCountyName { get; set; }
        public string? AnalysisText { get; set; }
        public TableData? MainTable { get; set; }
        public List<List<string>> BreakdownTable { get; set; } = new();
        public List<List<string>> BreakdownOtherTable { get; set; } = new();
    }

    public class TableData
    {
        public List<string> Headers { get; set; } = new();
        public List<List<string>> Rows { get; set; } = new();
    }
}
